/* checkout-ui - v3.52.15 */(function(){var Router,ShippingDataWrapper,debug,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};debug=vtex.debug("router"),Router=function(){function Router(){this.isStepBefore=__bind(this.isStepBefore,this),this.validateAllSteps=__bind(this.validateAllSteps,this),this.parseHash=__bind(this.parseHash,this),this.setHash=__bind(this.setHash,this),this.stateChangeHandler=__bind(this.stateChangeHandler,this),this.orderformRoute=__bind(this.orderformRoute,this),this.paymentRoute=__bind(this.paymentRoute,this),this.shippingRoute=__bind(this.shippingRoute,this),this.profileRoute=__bind(this.profileRoute,this),this.emailRoute=__bind(this.emailRoute,this),this.cartRoute=__bind(this.cartRoute,this),this.defaultRoute=__bind(this.defaultRoute,this),this.initializeRouter=__bind(this.initializeRouter,this);var _this=this;this.state=ko.observable(),this.inCart=ko.computed(function(){return"cart"===_this.state()}),this.inOrderForm=ko.computed(function(){return"orderform"===_this.state()}),this.state.subscribe(this.stateChangeHandler),this.parsingHash=!1,this.steps=["profile","shipping","payment"],this.shippingData=new ShippingDataWrapper("#shipping-data"),this.hashForStep=function(hash){switch(hash){case"profile":return window.clientProfileData;case"shipping":return _this.shippingData;case"payment":return window.paymentData;default:return void 0}},this.view={clientProfileDataVisited:ko.observable(),shippingDataVisited:ko.observable(),paymentDataVisited:ko.observable()},this.validationResults={},crossroads.addRoute("",this.defaultRoute),crossroads.addRoute("cart",this.cartRoute),crossroads.addRoute("email",this.emailRoute),crossroads.addRoute("profile",this.profileRoute),crossroads.addRoute("shipping",this.shippingRoute),crossroads.addRoute("payment",this.paymentRoute),crossroads.addRoute("orderform",this.orderformRoute),$("#client-profile-data").on("componentValidated.vtex",function(e,results){return _this.validationResults.profile=_.all(results,function(val){return val.result===!0})}),$("#shipping-data").on("componentValidated.vtex",function(e,results){return _this.validationResults.shipping=results===!0||0===results.length}),$("#payment-data").on("componentValidated.vtex",function(e,results){return _this.validationResults.payment=_.all(results,function(val){return val.result===!0})}),$(window).on("componentDone.vtex",function(){return _this.parsingHash?void 0:_this.validateAllSteps()})}return Router.prototype.initializeRouter=function(){var step,stepId,_i,_len,_ref;for(_ref=this.steps,_i=0,_len=_ref.length;_len>_i;_i++)stepId=_ref[_i],step=this.hashForStep(stepId),this.validationResults[stepId]&&step.visited(!0);return hasher.initialized.add(this.parseHash),hasher.changed.add(this.parseHash),hasher.init()},Router.prototype.defaultRoute=function(){return hasher.setHash("cart")},Router.prototype.cartRoute=function(){return this.state("cart")},Router.prototype.emailRoute=function(){return 0===cart.items().length?hasher.replaceHash("cart"):checkout.canEditData()?this.hashForStep("profile").showEmailForm()?(this.state("orderform"),this.hashForStep("profile").enable()):hasher.replaceHash("profile"):hasher.replaceHash("orderform")},Router.prototype.profileRoute=function(){return 0===cart.items().length?hasher.replaceHash("cart"):checkout.canEditData()?(this.state("orderform"),this.hashForStep("profile").enable()):hasher.replaceHash("orderform")},Router.prototype.shippingRoute=function(){return cart.items().length>0?(this.state("orderform"),this.hashForStep("shipping").enable(),this.view.shippingDataVisited(!0)):hasher.replaceHash("cart")},Router.prototype.paymentRoute=function(){var unavailableItems;return unavailableItems=cart.unavailableItems(),unavailableItems.length>0?(vtex.checkout.MessageUtils.showUnavailableMessage(),cart.unavailableItemsCannotBeDelivered()?hasher.setHash("shipping"):hasher.setHash("cart")):cart.availableItems().length>0?(this.state("orderform"),this.hashForStep("payment").enable()):hasher.setHash("cart")},Router.prototype.orderformRoute=function(){return cart.items().length>0?this.validateAllSteps(!0):hasher.replaceHash("cart")},Router.prototype.stateChangeHandler=function(state){return $(window).trigger("stateUpdated.vtex",[state]),"orderform"===state?$(document).off("focusin.cart",".orderform-template :visible"):"cart"===state?($(".cart-template.full-cart").focus(),$(document).on("focusin.cart",".orderform-template :visible",function(e){return $(e.target).blur(),$(".cart-template.full-cart a.btn-success:last-child:visible").focus(),!1}),radio("checkout.shippingData.clearUnselectedLogisticsInfo").broadcast(!0)):void 0},Router.prototype.setHash=function(hash){return hasher.setHash(hash)},Router.prototype.parseHash=function(newHash,oldHash){var newHashFiltered,oldHashFiltered,oldStep;if(debug("parsing from",oldHash,"to",newHash),null!=oldHash&&oldHash!==newHash&&$(window).trigger("removeAllMessages.vtex"),this.parsingHash=!0,window.vtex.checkout.analytics.sendEvent(newHash),oldHashFiltered=null!=oldHash?oldHash.replace(/\/|\?/g,"").toLowerCase().replace("email","profile"):void 0,newHashFiltered=null!=newHash?newHash.replace(/\/|\?/g,"").toLowerCase():void 0,oldStep=this.hashForStep(oldHashFiltered)){if(!this.validationResults[oldHashFiltered]&&!this.isStepBefore(newHashFiltered,oldHashFiltered))return hasher.setHash(oldHashFiltered),this.parsingHash=!1;oldStep.disable()}else if(""!==newHashFiltered&&"cart"!==newHashFiltered)return crossroads.parse(this.validateAllSteps()),this.parsingHash=!1;return crossroads.parse(newHashFiltered),this.parsingHash=!1},Router.prototype.validateAllSteps=function(replaceHash){var step,stepId,stepIsValid,_i,_len,_ref;for(null==replaceHash&&(replaceHash=!1),_ref=this.steps,_i=0,_len=_ref.length;_len>_i&&(stepId=_ref[_i],step=this.hashForStep(stepId),stepIsValid=this.validationResults[stepId],stepIsValid);_i++)step.visited(!0),step.active()&&"payment"!==stepId&&step.disable();return"profile"===stepId&&step.showEmailForm()&&(stepId="email"),debug("validated all steps, stopped at",stepId),replaceHash?hasher.replaceHash(stepId):hasher.setHash(stepId),stepId},Router.prototype.isStepBefore=function(a,b){return _(this.steps).indexOf(a)<_(this.steps).indexOf(b)},Router}(),ShippingDataWrapper=function(){function ShippingDataWrapper(selector){this.disable=__bind(this.disable,this),this.enable=__bind(this.enable,this),this.active=__bind(this.active,this),this.visited=__bind(this.visited,this),this.el=$(selector)}return ShippingDataWrapper.prototype.visited=function(){},ShippingDataWrapper.prototype.active=function(){return this.el.find(".step").hasClass("active")},ShippingDataWrapper.prototype.enable=function(){return this.el.trigger("enable.vtex")},ShippingDataWrapper.prototype.disable=function(){return this.el.trigger("disable.vtex")},ShippingDataWrapper}(),vtex.checkout.Router=Router}).call(this),function(){var CheckoutModel,debug,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;l>i;i++)if(i in this&&this[i]===item)return i;return-1};debug=vtex.debug("checkout"),CheckoutModel=function(){function CheckoutModel(){this.login=__bind(this.login,this),this.removeGiftRegistry=__bind(this.removeGiftRegistry,this),this.noteSubmitHandler=__bind(this.noteSubmitHandler,this),this.paymentSubmitHandler=__bind(this.paymentSubmitHandler,this),this.giftCardSubmitHandler=__bind(this.giftCardSubmitHandler,this),this.billingAddressSubmitHandler=__bind(this.billingAddressSubmitHandler,this),this.shippingDataSubmitHandler=__bind(this.shippingDataSubmitHandler,this),this.addressSubmitHandler=__bind(this.addressSubmitHandler,this),this.parseOrderFormResponse=__bind(this.parseOrderFormResponse,this),this.toJSON=__bind(this.toJSON,this),this.parseLogisticsInfo=__bind(this.parseLogisticsInfo,this),this.parseShippingData=__bind(this.parseShippingData,this),this.update=__bind(this.update,this),this.goToFirstInvalidStep=__bind(this.goToFirstInvalidStep,this),this.killCookiePCI=__bind(this.killCookiePCI,this),this.cookiePCIExists=__bind(this.cookiePCIExists,this);var _ref,_this=this;this.isTotem=ko.observable(null!=(_ref=vtex.totem)?_ref:!1),this.cookiePCI=_.readCookie("CheckoutNewInstallments"),this.locale=ko.observable(""),this.localeSetByAPI=!1,this.countryCode=ko.observable("BRA"),this.userProfileId=void 0,this.saveData=ko.observable(!0),this.optinNewsLetter=ko.observable(!0),this.canEditData=ko.observable(!0),this.userType=ko.observable(null),this.loggedIn=ko.observable(!1),this.salesChannel=ko.observable(1),this.isUsingGiftRegistry=ko.observable(!1),this.giftRegistryId=ko.observable(null),this.giftRegistryDescription=ko.observable(null),this.giftRegistryAddressId=ko.observable(null),this.isUsingGiftRegistryAddress=ko.observable(!1),this.isNoteSaved=!1,this.isSavingNote=!0,this.isUsingNote=ko.observable(!1),this.setUsingNote=function(){return _this.isUsingNote(!0),$("#cart-note").focus()},this.note=ko.observable(null),this.oldNote=ko.observable(),this.newNote=ko.computed(function(){return _this.oldNote()!==_this.note()&&(_this.isNoteSaved=!1),_this.note()?_this.isUsingNote(!0):_this.isUsingNote(!1),vtex.i18n.translateHtml(".summary-note")}),this.noteAutoSave=ko.computed(function(){var note;return note=_this.note(),_this.isNoteSaved||_this.isSavingNote?void 0:_this.noteSubmitHandler(note)}).extend({throttle:700}),this.postalCodeMask=ko.observable(),this.phoneMask=ko.observable(),this.documentMask=ko.observable(),this.corporateDocumentMask=ko.observable(),this.postalCodeForgottenURL=ko.observable(),this.defaultDocumentType=ko.observable(),this.adjustLocaleForCountryCode=function(newValue){var countryToKey;return window.vtex.i18n.setCountryCode(newValue),countryToKey=vtex.validation.countryToKey[newValue],_this.postalCodeMask(vtex.validation.masks[countryToKey.postalCode]),_this.phoneMask(vtex.validation.masks[countryToKey.phone]),_this.documentMask(vtex.validation.masks[countryToKey.documentKey]),_this.corporateDocumentMask(vtex.validation.masks[countryToKey.corporateDocument]),_this.postalCodeForgottenURL(_this.getForgottenPostalCodeURL(newValue)),_this.defaultDocumentType(vtex.validation.countryToKey[newValue].document),vtex.ko.validation.regex.document=vtex.ko.validation.regex[countryToKey.documentKey],vtex.ko.validation.regex.phone=vtex.ko.validation.regex[countryToKey.phone],vtex.ko.validation.regex.postalCode=vtex.ko.validation.regex[countryToKey.postalCode]},this.adjustLocaleForCountryCode("BRA"),this.countryCode.subscribe(this.adjustLocaleForCountryCode),this.currencyCode=ko.observable("BRL"),this.deliveryCountries=ko.observableArray(["BRA"]),this.campaignName=ko.observable(),this.campaignSource=ko.observable(),this.campaignMedium=ko.observable(),this.loading=ko.observable(!0),this.disableInputs=ko.observable(!1),this.backgroundLoading=ko.observable(!1),this.countriesWithNoPostalCode=["ECU","CHL","COL","PRY"],this.countriesWithPostalCodeAccordingToCity=["CHL","COL","PRY"],this.isNotUsingPostalCode=ko.computed(function(){var _ref1;return _ref1=_this.countryCode(),__indexOf.call(_this.countriesWithNoPostalCode,_ref1)>=0}),this.isPostalCodeAccordingToCity=ko.computed(function(){var _ref1;return _ref1=_this.countryCode(),__indexOf.call(_this.countriesWithPostalCodeAccordingToCity,_ref1)>=0}),this.disablePaymentButton=ko.computed({read:function(){return window.cart.unavailableItems().length>0||_this.backgroundLoading()||window.paymentData.isEditingSensitiveField()},deferEvaluation:!0}),this.hasSelectableGifts=ko.observable(!1),this.alertPCICookieMessage=ko.computed(function(){return _this.locale(),i18n.t("cookiePCIMessage")}),this.alertPCICookieClick=ko.computed(function(){return _this.locale(),i18n.t("cookiePCIClick")}),this.alertPCICookieClickInfo=ko.computed(function(){return _this.locale(),i18n.t("cookiePCIClickInfo")}),radio("checkout.disableInputs").subscribe(this.disableInputs),$(window).on("checkoutRequestBegin.vtex",function(e,options){return debug("Starting request to endpoint",options.url),_this.backgroundLoading(!0)}),$(window).on("orderFormUpdated.vtex",function(e,orderForm){return debug("Updating orderForm via event"),_this.backgroundLoading(!1),_this.parseOrderFormResponse(orderForm)}),radio("vtex.i18n.update").subscribe(function(data){return data!==_this.locale()?(vtex.ko.validation.options.locale=data,_this.locale(data),window.vtex.i18n.translateHtml(),_this.localeSetByAPI?void(_this.localeSetByAPI=!1):($(window).trigger("localeSelected.vtex",[data]),API.sendLocale(data))):void 0}),radio("vtex.countryCode.update").subscribe(this.countryCode),radio("checkout.item.new.bundleItem").subscribe(this.newItemWithBundleItem),radio("checkout.shipping.create").subscribe(this.parseOrderFormResponse),radio("checkout.shippingData.shippingAddress.submit").subscribe(this.addressSubmitHandler),radio("checkout.paymentData.billingAddress.submit").subscribe(this.billingAddressSubmitHandler),radio("checkout.shippingData.submit").subscribe(this.shippingDataSubmitHandler),radio("checkout.paymentData.submit").subscribe(this.paymentSubmitHandler),radio("checkout.giftcard.submit").subscribe(this.giftCardSubmitHandler),radio("checkout.openTextField").subscribe(this.note)}return CheckoutModel.prototype.cookiePCIExists=function(){return"__cart_use_new_installments=True"===this.cookiePCI?!0:!1},CheckoutModel.prototype.killCookiePCI=function(){return document.cookie="CheckoutNewInstallments=;expires=Thu, 01 Jan 1970 00:00:01 GMT;path=/;domain="+document.domain,location.reload()},CheckoutModel.prototype.goToFirstInvalidStep=function(){var _ref;return null!=(_ref=window.router)?_ref.validateAllSteps(!0):void 0},CheckoutModel.prototype.update=function(expectedOrderFormSections){return API.getOrderForm(expectedOrderFormSections)},CheckoutModel.prototype.parseShippingData=function(shippingData){return shippingData.logisticsInfo?this.parseLogisticsInfo(shippingData.logisticsInfo):void 0},CheckoutModel.prototype.parseLogisticsInfo=function(jsonArray){var countryCode,deliveryCountries,li,_i,_j,_len,_len1,_ref;if(void 0!==jsonArray&&0!==jsonArray.length){for(deliveryCountries=[],_i=0,_len=jsonArray.length;_len>_i;_i++)if(li=jsonArray[_i],li.shipsTo)for(_ref=li.shipsTo,_j=0,_len1=_ref.length;_len1>_j;_j++)countryCode=_ref[_j],_(deliveryCountries).contains(countryCode)||deliveryCountries.push(countryCode);return deliveryCountries.length>0?_.isEqual(deliveryCountries,this.deliveryCountries())?void 0:this.deliveryCountries(deliveryCountries):this.deliveryCountries([this.countryCode()])}},CheckoutModel.prototype.toJSON=function(){var _ref;return JSON.stringify({items:ko.toJSON(window.cart.items()),gifts:ko.toJSON(window.cart.gifts()),clientProfileData:clientProfileData.toJSON(),shippingData:shippingData.toJSON(),paymentData:{payments:paymentData.getAllPayments(!0),giftCards:(null!=(_ref=paymentData.paymentGroups.giftCardPaymentGroup)?_ref.getGiftCardsJSON():void 0)||[]},coupon:ko.toJSON(summary.coupon),clientPreferencesData:{optinNewsLetter:this.optinNewsLetter(),locale:vtex.i18n.locale}})},CheckoutModel.prototype.parseOrderFormResponse=function(json){var currentCurrency,locale,_ref,_ref1,_ref2,_ref3,_ref4,_ref5,_ref6;return debug("Parsing order form response"),this.userProfileId=json.userProfileId,this.canEditData(json.canEditData),this.loggedIn(json.loggedIn),json.salesChannel&&this.salesChannel(json.salesChannel),0===(null!=(_ref=json.items)?_ref.length:void 0)&&router.setHash("cart"),json.clientPreferencesData&&json.clientPreferencesData.optinNewsLetter&&this.optinNewsLetter(json.clientPreferencesData.optinNewsLetter),(null!=(_ref1=json.shippingData)&&null!=(_ref2=_ref1.address)?_ref2.addressType:void 0)&&this.isUsingGiftRegistryAddress("giftRegistry"===json.shippingData.address.addressType),json.clientPreferencesData&&json.clientPreferencesData.locale&&(this.localeSetByAPI=!0,locale=json.clientPreferencesData.locale.match("es-")?"es":json.clientPreferencesData.locale,this.locale()!==locale&&vtex.i18n.setLocale(locale)),json.storePreferencesData&&(json.storePreferencesData.countryCode&&this.countryCode()!==json.storePreferencesData.countryCode&&radio("vtex.countryCode.update").broadcast(json.storePreferencesData.countryCode),json.storePreferencesData.currencyCode&&this.currencyCode(json.storePreferencesData.currencyCode),json.storePreferencesData.currencySymbol?vtex.i18n.setCurrency(json.storePreferencesData.currencySymbol):(currentCurrency=function(){switch(this.countryCode()){case"BRA":return"R$";case"PRY":return"Gs";case"PER":return"S/.";case"URY":return"USD";case"VEN":return"Bs. F.";default:return"$"}}.call(this),vtex.i18n.setCurrency(currentCurrency)),json.storePreferencesData.currencyFormatInfo&&(vtex.i18n.setThousandsSeparator(json.storePreferencesData.currencyFormatInfo.currencyGroupSeparator),vtex.i18n.setDecimalSeparator(json.storePreferencesData.currencyFormatInfo.currencyDecimalSeparator),vtex.i18n.setDecimalDigits(json.storePreferencesData.currencyFormatInfo.currencyDecimalDigits)),null!=json.storePreferencesData.checkToSavePersonDataByDefault&&this.saveData(!!json.storePreferencesData.checkToSavePersonDataByDefault)),null!=json.items&&this.hasSelectableGifts((null!=(_ref3=json.selectableGifts)?_ref3.length:void 0)>0),null!=json.giftRegistryData?(this.isUsingGiftRegistry(!0),radio("checkout.giftRegistry").broadcast(!0),this.giftRegistryId(json.giftRegistryData.giftRegistryId),this.giftRegistryDescription(json.giftRegistryData.description),this.giftRegistryAddressId(json.giftRegistryData.addressId)):(this.isUsingGiftRegistry(!1),radio("checkout.giftRegistry").broadcast(!1),this.giftRegistryId(void 0),this.giftRegistryDescription(void 0),this.giftRegistryAddressId(void 0)),json.ratesAndBenefitsData&&radio("checkout.ratesAndBenefitsData.create").broadcast(json.ratesAndBenefitsData),void 0!==json.marketingData&&(radio("checkout.marketingData.create").broadcast(json.marketingData),this.campaignName(null!=(_ref4=json.marketingData)?_ref4.utmCampaign:void 0),this.campaignSource(null!=(_ref5=json.marketingData)?_ref5.utmSource:void 0),this.campaignMedium(null!=(_ref6=json.marketingData)?_ref6.utmMedium:void 0)),json.openTextField&&null!==json.openTextField.value?(this.oldNote(json.openTextField.value),this.isNoteSaved=!0,this.isSavingNote=!1,this.note(json.openTextField.value),this.isUsingNote(!0)):(this.isSavingNote=!1,this.isUsingNote(!1),this.note(null)),json.shippingData&&this.parseShippingData(json.shippingData),null!=json.userType&&this.userType(json.userType),json.messages?vtex.checkout.MessageUtils.showMessagesFromOrderForm(json.messages):void 0},CheckoutModel.prototype.addressSubmitHandler=function(address){var xhr,_this=this;return xhr=API.getAddressInformation(address),xhr.done(function(address){return _this.parseShippingData({address:address})}),xhr.always(function(){return _this.shippingDataSubmitHandler({address:address,clearAddressIfPostalCodeNotFound:address.clearAddressIfPostalCodeNotFound})})},CheckoutModel.prototype.shippingDataSubmitHandler=function(shippingData){var attachment,attachmentId,jqxhr;return attachmentId="shippingData",attachment=shippingData,jqxhr=API.sendAttachment(attachmentId,attachment),jqxhr.fail(function(){return router.setHash("shipping")})},CheckoutModel.prototype.billingAddressSubmitHandler=function(billingAddress){var jqXHR;return jqXHR=API.getAddressInformation(billingAddress),jqXHR.done(function(address){var apiAddress;return apiAddress=address,radio("checkout.paymentData.billingAddress.commit").broadcast({postalCode:apiAddress.postalCode,addressType:0,addressId:(new Date).getTime().toString(),street:apiAddress.street,neighborhood:apiAddress.neighborhood,city:apiAddress.city,state:apiAddress.state,number:apiAddress.number,country:apiAddress.country})}),jqXHR.fail(function(){return radio("checkout.paymentData.billingAddress.commit").broadcast({postalCode:billingAddress.postalCode,country:billingAddress.country})})},CheckoutModel.prototype.giftCardSubmitHandler=function(attachmentId,attachment){var jqXHR;return jqXHR=API.sendAttachment(attachmentId,attachment,["totalizers","marketingData","paymentData","messages","items","ratesAndBenefitsData","sellers"]),jqXHR.fail(function(){return window.paymentData.paymentGroups.giftCardPaymentGroup.loadingGiftCard(!1)})},CheckoutModel.prototype.paymentSubmitHandler=function(value,referenceValue,payments){var doBefore,interestValue,payment,savingNote,_i,_len,_this=this;for(vtex.checkout.MessageUtils.showPaymentMessage(),interestValue=0,_i=0,_len=payments.length;_len>_i;_i++)payment=payments[_i],interestValue+=payment.value-payment.referenceValue;return doBefore=$.Deferred(),savingNote=!1,!this.isUsingNote()||this.isNoteSaved||this.isSavingNote||(savingNote=!0,doBefore=this.noteSubmitHandler(this.note())),doBefore.done(function(){var jqxhr;return jqxhr=API.startTransaction(value,referenceValue,interestValue,_this.saveData(),_this.optinNewsLetter()),jqxhr.fail(function(){return vtex.checkout.MessageUtils.hidePaymentMessage(),radio("checkout.paymentData.submit.fail").broadcast("startTransaction")}),jqxhr.done(function(transactionResponse){var gatewayUrl,giftPayment,giftPayments,i,j,merchant,merchantId,merchantTransactions,newPayment,paymentsArray,paymentsJSON,transaction,transactionID,transactionPayment,transactionPayments,transactionURL,_j,_k,_l,_len1,_len2,_len3,_len4,_m,_ref;if(transactionID=transactionResponse.id,transactionURL=transactionResponse.receiverUri,merchantTransactions=transactionResponse.merchantTransactions,transactionPayments=transactionResponse.paymentData.payments,null!=merchantTransactions&&merchantTransactions.length>0){for(paymentsArray=[],giftPayments=_.filter(payments,function(p){return"giftCardPaymentGroup"===p.group}),_j=0,_len1=giftPayments.length;_len1>_j;_j++)giftPayment=giftPayments[_j],giftPayment.transaction={id:merchantTransactions[0].transactionId,merchantName:merchantTransactions[0].merchantName};for(paymentsArray=paymentsArray.concat(giftPayments),i=_k=0,_len2=payments.length;_len2>_k;i=++_k)for(payment=payments[i],j=_l=0,_len3=transactionPayments.length;_len3>_l;j=++_l)if(transactionPayment=transactionPayments[j],i===j)for(_ref=transactionPayment.merchantSellerPayments,_m=0,_len4=_ref.length;_len4>_m;_m++)merchant=_ref[_m],newPayment=_.clone(payment),_.extend(newPayment,merchant),merchantId=newPayment.id,transaction=_.find(merchantTransactions,function(m){return m.id===merchantId}),transaction&&(newPayment.transaction={id:transaction.transactionId,merchantName:transaction.merchantName},newPayment.installmentsValue=newPayment.installmentValue,newPayment.currencyCode=_this.currencyCode(),paymentsArray.push(newPayment));payments=paymentsArray}return paymentsJSON=JSON.stringify(payments),null==transactionURL?(vtex.checkout.MessageUtils.hidePaymentMessage(),radio("checkout.paymentData.submit.fail").broadcast("transactionUrl"),_this.goToFirstInvalidStep()):"NO-PAYMENT"===transactionID?window.location.href=transactionURL:($("#sendPayments").attr("action",transactionURL),$("#paymentsArray").val(paymentsJSON),transactionResponse.gatewayCallbackTemplatePath&&(gatewayUrl=location.protocol+"//"+location.host+transactionResponse.gatewayCallbackTemplatePath,$("#callbackURL").val(gatewayUrl)),$("#sendPayments").submit())})}),savingNote?void 0:doBefore.resolve()},CheckoutModel.prototype.noteSubmitHandler=function(value){var attachment,sendAttachmentXHR,_this=this;return""===value&&(value=null),attachment={value:value},this.isSavingNote=!0,sendAttachmentXHR=API.sendAttachment("openTextField",attachment),sendAttachmentXHR.done(function(data){return _this.isSavingNote=!1,_this.noteSaved=!0,_this.oldNote(_this.note())}),sendAttachmentXHR.fail(function(){return this.isSavingNote=!1,this.noteSaved=!1})},CheckoutModel.prototype.removeGiftRegistry=function(){var xhr,_this=this;return this.loading(!0),xhr=window.API.removeGiftRegistry(),xhr.done(function(data){return $.get("/no-cache/giftlistv2/cookiemanage")}),xhr.always(function(){return _this.loading(!1)})},CheckoutModel.prototype.login=function(){return vtexid.start({returnUrl:window.location.href,userEmail:window.clientProfileData.email(),locale:this.locale()})},CheckoutModel.prototype.getStates=function(country){return null==country&&(country="BRA"),"BRA"===country||"USA"===country?vtex.localeUtils[country].states:vtex.localeUtils[country]?vtex.localeUtils[country].map?(vtex.localeUtils[country].states||(vtex.localeUtils[country].states=_.map(vtex.localeUtils[country].map,function(k,v){return v})),vtex.localeUtils[country].states):_.map(vtex.localeUtils[country].states,function(v,k){return k}):void 0},CheckoutModel.prototype.getForgottenPostalCodeURL=function(country){switch(null==country&&(country="BRA"),country){case"BRA":return"http://www.buscacep.correios.com.br/servicos/dnec/index.do";case"ARG":return"http://www.correoargentino.com.ar/formularios/cpa";case"MEX":return"http://www.sepomex.gob.mx/servicioslinea/paginas/ccpostales.aspx";case"URY":return"http://geo.correo.com.uy/IsisBusquedaDireccionPlugin/cp.jsp";default:return"#"}},CheckoutModel}(),vtex.checkout.CheckoutModel=CheckoutModel}.call(this),function(){window.vtex||(window.vtex={}),vtex.checkout||(vtex.checkout={}),vtex.checkout.Module={moduleId:"",_cache:{},serializableProperties:function(){return[]},commit:function(){return this._cache=this.toJSON()},revert:function(){return this.update(this._cache)},update:function(data){return ko.utils.extendObservable(this,data),this.commit(),this},submit:function(){return radio("checkout."+this.moduleId+".submit").broadcast(this.toJSON())},toJSON:function(){var attr,json,key,_i,_len,_ref;for(json={},_ref=this.serializableProperties(),_i=0,_len=_ref.length;_len>_i;_i++)key=_ref[_i],attr=ko.toJS(this[key]),json[key]=attr;return json},applyModuleSubscriptions:function(){return radio("checkout."+this.moduleId+".update").subscribe([this.update,this]),radio("checkout."+this.moduleId+".commit").subscribe([this.commit,this])},removeModuleSubscriptions:function(){return radio("checkout."+this.moduleId+".update").unsubscribe(this.update),radio("checkout."+this.moduleId+".commit").unsubscribe(this.commit)},destroy:function(){return this.removeModuleSubscriptions()},isDirty:function(){return!_.isEqual(this._cache,this.toJSON())}}}.call(this),function(){var TotalizerViewModel,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};TotalizerViewModel=function(){function TotalizerViewModel(data){this.shippingAddressRemoveHandler=__bind(this.shippingAddressRemoveHandler,this),this.shippingAddressChangeHandler=__bind(this.shippingAddressChangeHandler,this),this.isFree=__bind(this.isFree,this),this.isVisibleInit=__bind(this.isVisibleInit,this),this.isShipping=__bind(this.isShipping,this),this.isTax=__bind(this.isTax,this),this.isItems=__bind(this.isItems,this),this.update=__bind(this.update,this);var _this=this;this.id=ko.observable(),this.name=ko.observable(),this.value=ko.observable(),this.update(data),this.visible=ko.observable(this.isVisibleInit()),this.toBeCalculated=ko.observable(!1),this.valueLabel=ko.computed(function(){return _this.toBeCalculated()?i18n.t("totalizers.toBeCalculated"):_this.isFree()?i18n.t("global.free"):_.intAsCurrency(_this.value())}),$(window).on("orderFormUpdated.vtex",function(e,orderForm){var _ref;return null!=(null!=(_ref=orderForm.shippingData)?_ref.address:void 0)?_this.shippingAddressChangeHandler(orderForm.shippingData.address):_this.shippingAddressRemoveHandler()})}return TotalizerViewModel.prototype.update=function(data){return this.id(data.id),this.name(data.name),this.value(data.value)},TotalizerViewModel.prototype.isItems=function(){return"Items"===this.id()},TotalizerViewModel.prototype.isTax=function(){return"Tax"===this.id()},TotalizerViewModel.prototype.isShipping=function(){return"Shipping"===this.id()},TotalizerViewModel.prototype.isVisibleInit=function(){return!(this.isTax()&&this.isFree())},TotalizerViewModel.prototype.isFree=function(){return 0===this.value()},TotalizerViewModel.prototype.shippingAddressChangeHandler=function(address){return(!this.isShipping()||address)&&this.visible(!0),this.isTax()&&this.isFree()?this.visible(!1):void 0},TotalizerViewModel.prototype.shippingAddressRemoveHandler=function(){return this.shippingAddressChangeHandler()},TotalizerViewModel}(),vtex.checkout.TotalizerViewModel=TotalizerViewModel}.call(this),function(){var SummaryViewModel,debug,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};debug=vtex.debug("summary"),SummaryViewModel=function(){function SummaryViewModel(checkoutModel){this.goToFirstInvalidStep=__bind(this.goToFirstInvalidStep,this),this.deliverySelectedHandler=__bind(this.deliverySelectedHandler,this),this.deliveryEstimateAddressSubmitHandler=__bind(this.deliveryEstimateAddressSubmitHandler,this),this.logisticsInfoChangeHandler=__bind(this.logisticsInfoChangeHandler,this),this.usingPostalCode=__bind(this.usingPostalCode,this),this.resetShipping=__bind(this.resetShipping,this),this.calculateShipping=__bind(this.calculateShipping,this),this.shippingValueLabel=__bind(this.shippingValueLabel,this),this.newRatesAndBenefitsData=__bind(this.newRatesAndBenefitsData,this),this.addInterest=__bind(this.addInterest,this),this.newTotalizers=__bind(this.newTotalizers,this),this.addressRemoveHandler=__bind(this.addressRemoveHandler,this),this.addressChangeHandler=__bind(this.addressChangeHandler,this),this.update=__bind(this.update,this),this.subscriptions=__bind(this.subscriptions,this);var _this=this;this.totalizers=ko.observableArray([]),this.discounts=ko.observableArray([]),this.sellers=ko.observableArray([]),this.logisticsInfoArray=[],this.logisticsInfo=ko.observableArray([]),this.loading=checkoutModel.loading,this.isGiftRegistryAddress=ko.observable(!1),this.giftRegistryData=ko.observable(null),this.items=null,this.coupon=new vtex.checkout.CouponViewModel,this.slasForSellerViewModelArray=ko.observableArray(),this.interestValue=ko.observable(0),this.total=ko.computed(function(){var total,totalizer,_i,_len,_ref;for(total=0,_ref=_this.totalizers(),_i=0,_len=_ref.length;_len>_i;_i++)totalizer=_ref[_i],"interest"!==totalizer.id()&&totalizer.visible()&&(total+=totalizer.value());return total}),this.hasTotal=ko.computed(function(){var _ref;return(null!=(_ref=_this.totalizers())?_ref.length:void 0)>0}),this.disableCheckoutButton=ko.computed(function(){return!window.checkout.isNotUsingPostalCode()&&!_this.hasTotal()}),this.totalLabel=ko.computed(function(){var hasTotal,total;return hasTotal=_this.hasTotal(),total=_this.total(),0===total?hasTotal?i18n.t("global.free"):i18n.t("totalizers.toBeCalculated"):-1===_this.total()?i18n.t("totalizers.toBeCalculated"):_.intAsCurrency(_this.total()+_this.interestValue())}),this.isShippingKnown=ko.observable(!1),this.isUsingPostalCode=ko.observable(!1),this.postalCodeKey=ko.computed(function(){return vtex.validation.countryToKey[checkout.countryCode()].postalCode}),this.postalCodeLabel=ko.computed(function(){return _this.postalCodeKey().toUpperCase()}),this.loadingPostalCode=ko.observable(!1),this.postalCode=ko.observable(),this.maskedPostalCode=ko.computed({read:function(){var masked,postalCode,_ref;return postalCode=_this.postalCode(),_this.isGiftRegistryAddress()?(null!=(_ref=_this.giftRegistryData())?_ref.description:void 0)||"":(masked=_.maskInfo(postalCode),masked===postalCode?_.maskString(postalCode,checkout.postalCodeMask()):masked)}}),this.deliveryCountry=ko.computed(function(){return checkout.countryCode()}),$(window).on("orderFormUpdated.vtex",function(e,orderForm){return _this.update(orderForm)}),$(window).on("deliverySelected.vtex",_.debounce(this.deliverySelectedHandler,200)),$(window).on("stateUpdated.vtex",function(e,state){var attachment,selectedSla,_ref,_ref1,_ref2;return"orderform"===state&&null!=(null!=(_ref=_this.address)?_ref.postalCode:void 0)&&null!=_this.logisticsInfoArray&&(_this.usingPostalCode(!0),_this.isShippingKnown(!0),_this.postalCode(null!=(_ref1=_this.address)?_ref1.postalCode:void 0),
selectedSla=null!=(_ref2=_this.logisticsInfo()[0])?_ref2.selectedSla():void 0,_this.previouslySelectedSla&&_this.previouslySelectedSla!==selectedSla)?(attachment={logisticsInfo:_(_this.logisticsInfo()).map(function(li){return _(li.toJSON()).pick("itemIndex","selectedSla","deliveryWindow","tax")}),address:_this.address},API.sendAttachment("shippingData",attachment)):void 0}),this.subscriptions()}return SummaryViewModel.prototype.subscriptions=function(){return radio("checkout.totalizers.interest").subscribe(this.addInterest),radio("checkout.ratesAndBenefitsData.create").subscribe(this.newRatesAndBenefitsData)},SummaryViewModel.prototype.update=function(orderForm){var shouldTranslate,_ref,_ref1;return shouldTranslate=!1,this.items=orderForm.items,orderForm.sellers&&this.sellers(orderForm.sellers),orderForm.totalizers&&(debug("parsing totalizers from event"),this.newTotalizers(orderForm.totalizers),shouldTranslate=!0),this.giftRegistryData(null!=orderForm?orderForm.giftRegistryData:void 0),null!=(null!=(_ref=orderForm.shippingData)?_ref.address:void 0)?this.addressChangeHandler(orderForm.shippingData.address):this.addressRemoveHandler(),null!=(null!=(_ref1=orderForm.shippingData)?_ref1.logisticsInfo:void 0)&&(this.previouslySelectedSla=null,this.logisticsInfoChangeHandler(orderForm.shippingData.logisticsInfo),shouldTranslate=!0),shouldTranslate?vtex.i18n.translateHtml(".summary"):void 0},SummaryViewModel.prototype.addressChangeHandler=function(address){return this.isGiftRegistryAddress("giftRegistry"===(null!=address?address.addressType:void 0)),this.address=address,this.postalCode(null!=address?address.postalCode:void 0),address?this.isShippingKnown(!0):void 0},SummaryViewModel.prototype.addressRemoveHandler=function(){return this.postalCode(""),this.isShippingKnown(!1)},SummaryViewModel.prototype.newTotalizers=function(totalizers){var tempTotalizers,totalizer,_i,_len;for(tempTotalizers=[],_i=0,_len=totalizers.length;_len>_i;_i++)totalizer=totalizers[_i],tempTotalizers.push(new vtex.checkout.TotalizerViewModel(totalizer));return this.totalizers(tempTotalizers)},SummaryViewModel.prototype.addInterest=function(interestValue){var tempTotalizers,totalizer;return tempTotalizers=_.reject(this.totalizers(),function(t){return"interest"===t.id()}),this.interestValue(interestValue),interestValue>0&&(totalizer={id:"interest",name:"interestValue",value:interestValue},tempTotalizers.push(new vtex.checkout.TotalizerViewModel(totalizer))),this.totalizers(tempTotalizers),vtex.i18n.translateHtml(".summary")},SummaryViewModel.prototype.newRatesAndBenefitsData=function(ratesAndBenefitsData){return this.discounts(ratesAndBenefitsData.rateAndBenefitsIdentifiers)},SummaryViewModel.prototype.shippingValueLabel=function(){var totalizer,_i,_len,_ref;for(_ref=this.totalizers(),_i=0,_len=_ref.length;_len>_i;_i++)if(totalizer=_ref[_i],"Shipping"===totalizer.id())return totalizer.valueLabel();return""},SummaryViewModel.prototype.calculateShipping=function(){var postalCodeRegex;return postalCodeRegex=vtex.ko.validation.regex[this.postalCodeKey()],postalCodeRegex.exec(this.postalCode())?this.deliveryEstimateAddressSubmitHandler({postalCode:this.postalCode(),country:this.deliveryCountry()}):void 0},SummaryViewModel.prototype.resetShipping=function(){return $(window).trigger("deliveryCleared.vtex"),this.isShippingKnown(!1),this.postalCode(""),this.usingPostalCode(!0)},SummaryViewModel.prototype.usingPostalCode=function(){return this.isUsingPostalCode?(this.isUsingPostalCode(!0),$("#summary-postal-code:visible").focus().removeClass("success error")):void 0},SummaryViewModel.prototype.logisticsInfoChangeHandler=function(logisticsInfoArray){var liGroupedBySeller,shippingTotalizer,toBeCalculated,totalDeliveryWindowsValue,totalSLAValue,totalizer,_ref,_this=this;if(this.items)return this.previouslySelectedSla||(this.previouslySelectedSla=null!=(_ref=this.logisticsInfoArray[0])?_ref.selectedSla:void 0),this.logisticsInfoArray=logisticsInfoArray,totalSLAValue=_(logisticsInfoArray).reduce(function(memo,element){var selectedSla,_ref1;return selectedSla=_(element.slas).find(function(s){return s.id===element.selectedSla}),(null!=(_ref1=null!=selectedSla?selectedSla.price:void 0)?_ref1:0)+memo},0),liGroupedBySeller=_.groupBy(logisticsInfoArray,function(li){var item;return item=_this.items[li.itemIndex],null!=item?item.seller:void 0}),toBeCalculated=!1,totalDeliveryWindowsValue=_(liGroupedBySeller).reduce(function(memo,liArray){var selectedSla;return selectedSla=_(liArray[0].slas).find(function(s){return s.id===liArray[0].selectedSla}),(null!=selectedSla?selectedSla.availableDeliveryWindows.length:void 0)>0?null==selectedSla.deliveryWindow?(toBeCalculated=!0,memo):selectedSla.deliveryWindow.price+memo:memo},0),shippingTotalizer=function(){var _i,_len,_ref1,_results;for(_ref1=this.totalizers(),_results=[],_i=0,_len=_ref1.length;_len>_i;_i++)totalizer=_ref1[_i],"Shipping"===totalizer.id()&&_results.push(totalizer);return _results}.call(this)[0],null!=shippingTotalizer&&shippingTotalizer.toBeCalculated(toBeCalculated),null!=shippingTotalizer&&shippingTotalizer.value(totalSLAValue+totalDeliveryWindowsValue),this.logisticsInfo(_(logisticsInfoArray).map(function(li){return new vtex.checkout.LogisticsInfoViewModel(li)})),this.slasForSellerViewModelArray(vtex.checkout.SlasForSellerViewModel.slasGroupedBySeller(this.logisticsInfo()))},SummaryViewModel.prototype.deliveryEstimateAddressSubmitHandler=function(address){var xhr,_this=this;return this.loadingPostalCode(!0),xhr=API.calculateShipping(address),xhr.fail(function(){return $(window).trigger("deliveryCleared.vtex")}),xhr.always(function(){return _this.loadingPostalCode(!1)})},SummaryViewModel.prototype.deliverySelectedHandler=function(e,logisticsInfoArray,options){var attachment;return null==options&&(options={}),this.logisticsInfoChangeHandler(logisticsInfoArray),options.skipSendAttachment?void 0:(attachment={logisticsInfo:_(this.logisticsInfo()).map(function(li){return _(li.toJSON()).pick("itemIndex","selectedSla","deliveryWindow","tax")}),address:this.address},API.sendAttachment("shippingData",attachment))},SummaryViewModel.prototype.goToFirstInvalidStep=function(){var _ref;return null!=(_ref=window.router)&&_ref.validateAllSteps(),!1},SummaryViewModel}(),vtex.checkout.SummaryViewModel=SummaryViewModel}.call(this),function(){var ItemViewModel,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};ItemViewModel=function(){function ItemViewModel(json,index,ratesAndBenefitsIdentifiers,logisticsInfoArray){this.unsubscribe=__bind(this.unsubscribe,this),this.subscriptions=__bind(this.subscriptions,this),this.quantityBlurHandler=__bind(this.quantityBlurHandler,this),this.setSeller=__bind(this.setSeller,this),this.updateLogisticsInfo=__bind(this.updateLogisticsInfo,this),this.submit=__bind(this.submit,this),this.toJSON=__bind(this.toJSON,this),this.remove=__bind(this.remove,this),this.removeOffering=__bind(this.removeOffering,this),this.addOffering=__bind(this.addOffering,this),this.setOptionDisable=__bind(this.setOptionDisable,this),this.addLastItemAttachmentOffering=__bind(this.addLastItemAttachmentOffering,this),this.addSelectedOffering=__bind(this.addSelectedOffering,this),this.addLastAvailableOffering=__bind(this.addLastAvailableOffering,this),this.update=__bind(this.update,this),this.decrement=__bind(this.decrement,this),this.increment=__bind(this.increment,this),this.setQuantity=__bind(this.setQuantity,this),this.toggleDiscount=__bind(this.toggleDiscount,this),this.handleDeliverySelected=__bind(this.handleDeliverySelected,this),this.removeManualPrice=__bind(this.removeManualPrice,this),this.saveManualPrice=__bind(this.saveManualPrice,this),this.toggleManualPrice=__bind(this.toggleManualPrice,this);var _this=this;this.index=ko.observable(),this.id=ko.observable(),this.productId=ko.observable(),this.detailUrl=ko.observable(),this.imageUrl=ko.observable(),this.name=ko.observable(),this.skuName=ko.observable(),this.skuRefId=ko.observable(),this.sellerId=ko.observable(),this.sellerName=ko.observable(""),this.brand=ko.observable(),this.brandId=ko.observable(),this.category=ko.observable(),this.categoryId=ko.observable(),this.categoryTree=ko.observableArray(),this.categoryIdTree=ko.observableArray(),this.listPrice=ko.observable(),this.price=ko.observable(),this.manualPrice=ko.observable(),this.isManualPriceActive=ko.observable(!1),this.sellingPrice=ko.observable(),this.showDiscount=ko.observable(!1),this.showDiscountButton=ko.observable(!1),this.quantity=ko.observable(),this.offerings=ko.observableArray(),this.components=ko.observableArray(),this.bundleItems=ko.observableArray(),this.seller=new vtex.checkout.SellerViewModel,this.isGift=ko.observable(!1),this.updateReceived=!1,this.tax=ko.observable(),this.estimateLabel=ko.observable(i18n.t("cart.seller.toBeCalculated")),this.estimateDetailLabel=ko.observable(),this.isSelectedSla=ko.observable(!1),this.measurementUnit=ko.observable(),this.unitMultiplier=ko.observable(),this.priceTags=ko.observableArray(),this.selectedItemAttachmentOffering=ko.observable(),this.itemAttachmentsList=ko.observableArray([]),this._manualPriceInput=ko.observable(),this.manualPriceInput=ko.computed({read:function(){return _this._manualPriceInput()},write:function(value){var intValue;return value=value.toString().replace(/\D/g,""),_this._manualPriceInput(value),""===value&&(value=0),intValue=parseInt(value,10),_this._manualPriceInput(_.formatCurrency(intValue/100))}}),this.itemAttachments=ko.computed(function(){return _.filter(_this.itemAttachmentsList(),function(it){return it.isUsingAttachment()})}),this.itemAttachmentOfferings=ko.computed(function(){var offerings;return offerings=_.filter(_this.itemAttachmentsList(),function(it){return!it.isUsingAttachment()})}),this.addSelectedItemAttachmentOffering=ko.computed(function(){var it;return null!=_this.selectedItemAttachmentOffering()?(it=_.find(_this.itemAttachmentOfferings(),function(it){return it.name()===_this.selectedItemAttachmentOffering().name()}),it.isUsingAttachment(!0),_this.selectedItemAttachmentOffering(null)):void 0}),this.selectItemAttachmentOfferingLabel=ko.computed(function(){return checkout.locale(),i18n.t("cart.addInfo")}),this.lastItemAttachmentOfferingLabel=ko.computed(function(){var _ref;return i18n.t("global.add")+" "+(null!=(_ref=_this.itemAttachmentOfferings()[0])?_ref.name():void 0)}),this.unitLabel=ko.computed(function(){var multiplier,quantity,unit;return multiplier=_this.unitMultiplier(),unit=_this.measurementUnit(),quantity=_this.quantity(),"un"!==unit?""+parseFloat(multiplier*quantity).toFixed(2)+" "+unit:void 0}),this.multiplierLabel=ko.computed(function(){var multiplier,unit;return multiplier=_this.unitMultiplier(),unit=_this.measurementUnit(),1*multiplier!==1?"x "+parseFloat(multiplier).toFixed(2)+" "+unit:void 0}),this.shippingPriceLabel=ko.observable(),this.shippingName=ko.observable(),this.availability=ko.observable(),this.unavailableForDelivery=ko.computed(function(){var _ref;return"cannotBeDelivered"===(_ref=_this.availability())}),this.available=ko.computed(function(){var _ref;return"available"===(_ref=_this.availability())||null===_ref||void 0===_ref}),this.isPriceVisible=ko.computed(function(){var _ref;return _this.available()||!("cannotBeDelivered"===(_ref=_this.availability())||"withoutStock"===_ref)}),this.canChangeQty=ko.computed(function(){var availability,available,loading,_ref;return loading=window.cart.loadingItem(),available=_this.available(),availability="cannotBeDelivered"===(_ref=_this.availability()),loading?!1:available||availability}),this.priceLabel=ko.computed(function(){return 0===_this.price()?i18n.t("global.free"):null===_this.price()?"-":_.intAsCurrency(Math.floor(_this.price()*_this.unitMultiplier()))}),this.sellingPriceLabel=ko.computed(function(){return 0===_this.sellingPrice()?i18n.t("global.free"):null===_this.price()?"-":_.intAsCurrency(_this.sellingPrice())}),this.priceLabelPerUnit=ko.computed(function(){return 0!==_this.price()&&"un"!==_this.measurementUnit()?_.intAsCurrency(_this.price())+" / "+_this.measurementUnit():""}),this.valueLabel=ko.computed(function(){var total;return 0===_this.sellingPrice()?i18n.t("global.free"):null===_this.sellingPrice()?"-":""===_this.quantity()||0===_this.quantity()?_.intAsCurrency(0):(total=_this.sellingPrice()*_this.quantity(),_.intAsCurrency(total))}),this.priceValueLabel=ko.computed(function(){var total;return 0===_this.price()?i18n.t("global.free"):null===_this.price()?"-":""===_this.quantity()||0===_this.quantity()?_.intAsCurrency(0):(total=Math.floor(_this.price()*_this.unitMultiplier()*_this.quantity()),_.intAsCurrency(total))}),this.listPriceLabel=ko.computed(function(){return _this.listPrice()<=_this.sellingPrice()?void 0:0===_this.listPrice()?i18n.t("global.free"):_.intAsCurrency(_this.listPrice())}),this.discount=ko.computed(function(){return _this.price()>_this.sellingPrice()&&_this.showDiscountButton(!0),_.intAsCurrency(_this.price()-_this.sellingPrice())}),this.isListPriceVisible=ko.computed(function(){return void 0!==_this.listPriceLabel()}),this.quantity.subscribe(function(value){return value?radio("checkout.item.quantity.change").broadcast():void 0}),this.quantityThrottled=ko.computed({read:function(){return _this.quantity()},deferEvaluation:!0}).extend({throttle:500}),this.quantityThrottled.subscribe(function(newValue){return _this.updateReceived?_this.updateReceived=!1:!isNaN(newValue)&&newValue>0?_this.submit():void 0}),this.selectedOffering=ko.observable(),this.availableOfferings=ko.computed(function(){var available,offer,sameBundleItem,_i,_len,_ref;for(available=[],_ref=_this.offerings(),_i=0,_len=_ref.length;_len>_i;_i++)offer=_ref[_i],sameBundleItem=_.find(_this.bundleItems(),function(b){return b.id()===offer.id()||b.type()===offer.type()}),sameBundleItem||available.push(offer);return available}),this.subscriptions(),this.update(json,index,ratesAndBenefitsIdentifiers,logisticsInfoArray)}return ItemViewModel.prototype.toggleManualPrice=function(){return this.isManualPriceActive(!this.isManualPriceActive()),this.isManualPriceActive()?this.manualPriceInput(this.sellingPrice()):void 0},ItemViewModel.prototype.saveManualPrice=function(item,event){var manualPriceInt;return("keyup"===event.type&&13===event.keyCode||"blur"===event.type)&&this.isManualPriceActive?(manualPriceInt=parseInt(this.manualPriceInput().replace(/[\.,]/g,""),10),manualPriceInt>=0&&manualPriceInt!==this.sellingPrice()?(this.manualPrice(manualPriceInt),this.sellingPrice(manualPriceInt),vtexjs.checkout.setManualPrice(item.index(),manualPriceInt)):this.manualPriceInput(""),this.toggleManualPrice()):void 0},ItemViewModel.prototype.removeManualPrice=function(item){return vtexjs.checkout.removeManualPrice(item.index())},ItemViewModel.prototype.handleDeliverySelected=function(e,logisticsInfoArray){var _this=this;return this.updateLogisticsInfo(_.find(logisticsInfoArray,function(li){return li.itemIndex===_this.index()}))},ItemViewModel.prototype.toggleDiscount=function(){return this.showDiscount(!this.showDiscount())},ItemViewModel.prototype.setQuantity=function(value){return this.updateReceived=!0,this.quantity(value)},ItemViewModel.prototype.increment=function(){return this.quantity(this.quantity()+1)},ItemViewModel.prototype.decrement=function(){return this.quantity()>1?this.quantity(this.quantity()-1):void 0},ItemViewModel.prototype.update=function(data,index,ratesAndBenefitsIdentifiers,logisticsInfoArray){var attOff,attachment,attachmentsList,bundleItem,c,categoryIds,component,imageUrl,newBundleItem,newComponent,newOffering,offering,relativeOffering,_i,_j,_k,_l,_len,_len1,_len2,_len3,_len4,_m,_ref,_ref1,_ref2,_ref3,_ref4;if(null!=data){for(this.index(index),this.productId(data.productId),this.id(data.id),this.detailUrl(data.detailUrl),imageUrl=null!=(_ref=data.imageUrl)?_ref.replace(/http\:|https:/,""):void 0,this.imageUrl(imageUrl),this.name(data.name),this.skuName(data.skuName),this.skuRefId(data.refId),this.sellerId(data.seller),this.brand(data.additionalInfo.brandName),this.brandId(data.additionalInfo.brandId),categoryIds=[],data.productCategoryIds&&(categoryIds=data.productCategoryIds.split("/"),categoryIds=_.reject(categoryIds,function(c){return 0===c.length}),this.categoryId(categoryIds[categoryIds.length-1]),this.category(data.productCategories[this.categoryId()])),this.categoryTree([]),this.categoryIdTree([]),_i=0,_len=categoryIds.length;_len>_i;_i++)c=categoryIds[_i],this.categoryIdTree.push(c),this.categoryTree.push(data.productCategories[c]);for(this.listPrice(data.listPrice),this.price(data.price),this.sellingPrice(data.sellingPrice),this.manualPrice(data.manualPrice),this.setQuantity(data.quantity),this.tax(data.tax),this.isGift(data.isGift),this.availability(data.availability),this.measurementUnit(data.measurementUnit?data.measurementUnit:"un"),this.unitMultiplier(data.unitMultiplier?data.unitMultiplier:1),this.priceTags(data.priceTags),this.itemAttachmentsList.removeAll(),_ref1=data.attachmentOfferings,_j=0,_len1=_ref1.length;_len1>_j;_j++)attOff=_ref1[_j],attachmentsList=new vtex.checkout.ItemAttachmentListViewModel(index),attachment=_.find(data.attachments,function(att){return att.name===attOff.name}),attachmentsList.update(attOff,attachment),this.itemAttachmentsList.push(attachmentsList);for(this.components.removeAll(),_ref2=data.components,_k=0,_len2=_ref2.length;_len2>_k;_k++)component=_ref2[_k],newComponent=new vtex.checkout.ItemViewModel(component,index,ratesAndBenefitsIdentifiers,logisticsInfoArray),this.components.push(newComponent);for(this.offerings.removeAll(),_ref3=data.offerings,_l=0,_len3=_ref3.length;_len3>_l;_l++)offering=_ref3[_l],newOffering=new vtex.checkout.OfferingViewModel(index,!0).update(offering),this.offerings.push(newOffering);for(this.bundleItems.removeAll(),_ref4=data.bundleItems,_m=0,_len4=_ref4.length;_len4>_m;_m++)bundleItem=_ref4[_m],relativeOffering=_.find(data.offerings,function(o){return bundleItem.id===o.id}),newBundleItem=new vtex.checkout.OfferingViewModel(index,!1).update(bundleItem,relativeOffering),this.bundleItems.push(newBundleItem);return this.seller=new vtex.checkout.SellerViewModel(data.sellerId),ratesAndBenefitsIdentifiers&&_.each(this.priceTags(),function(pt){return pt.ratesAndBenefitsIdentifier=_.find(ratesAndBenefitsIdentifiers,function(rnbi){return rnbi.id===pt.identifier})}),logisticsInfoArray&&this.handleDeliverySelected(null,logisticsInfoArray),this}},ItemViewModel.prototype.addLastAvailableOffering=function(){return this.addOffering(this.availableOfferings()[0].id())},ItemViewModel.prototype.addSelectedOffering=function(){return this.addOffering(this.selectedOffering().id())},ItemViewModel.prototype.addLastItemAttachmentOffering=function(){var it;return it=this.itemAttachmentOfferings()[0],it.isUsingAttachment(!0)},ItemViewModel.prototype.setOptionDisable=function(option,item){return"undefined"==typeof item&&this.selectedItemAttachmentOffering()?ko.applyBindingsToNode(option,{disable:!0},item):void 0},ItemViewModel.prototype.addOffering=function(offeringId){return window.cart.loadingItem(!0),radio("checkout.offering.loading").broadcast(!0),API.addOffering(offeringId,this.index()).always(function(){return window.cart.loadingItem(!1),radio("checkout.offering.loading").broadcast(!1)})},ItemViewModel.prototype.removeOffering=function(item,offeringId){if(item.index()===this.index())return window.cart.loadingItem(!0),radio("checkout.offering.loading").broadcast(!0),API.removeOffering(offeringId,this.index()).always(function(){return window.cart.loadingItem(!1),radio("checkout.offering.loading").broadcast(!1)})},ItemViewModel.prototype.remove=function(){return this.setQuantity(0),this.submit()},ItemViewModel.prototype.toJSON=function(){return ko.toJS(this)},ItemViewModel.prototype.submit=function(){return window.cart.loadingItem(!0),radio("checkout.item.submit").broadcast([this.toJSON()])},ItemViewModel.prototype.updateLogisticsInfo=function(logisticInfo){var selectedSla,slaVM;if((null!=logisticInfo?logisticInfo.itemIndex:void 0)===this.index())return selectedSla=_(logisticInfo.slas).find(function(s){return s.id===logisticInfo.selectedSla}),selectedSla?(this.isSelectedSla(!0),slaVM=new vtex.checkout.SlaViewModel(selectedSla),slaVM.isScheduled?null==slaVM.deliveryWindow()?void console.log("WARN: Got deliverySelected with scheduledSLA and no delivery window"):(this.estimateLabel(_.dateFormat(slaVM.deliveryWindow().endDate)),this.estimateDetailLabel(slaVM.deliveryWindow().timeLabel),this.shippingPriceLabel(slaVM.valueLabel),this.shippingName(slaVM.name)):(this.estimateLabel(slaVM.estimateLabel),this.estimateDetailLabel(null),this.shippingPriceLabel(slaVM.valueLabel),this.shippingName(slaVM.name))):(this.isSelectedSla(!1),this.estimateLabel(i18n.t("cart.seller.toBeCalculated")))},ItemViewModel.prototype.setSeller=function(data){return data.id===this.sellerId()?(this.seller.update(data),this.sellerName(data.name),vtex.i18n.translateHtml(".product-item .seller")):void 0},ItemViewModel.prototype.quantityBlurHandler=function(){var qty;return qty=parseInt(this.quantity(),10),0===qty||isNaN(qty)?this.quantity(1):void 0},ItemViewModel.prototype.translateBundleItems=function(){return vtex.i18n.translateHtml(".item-service")},ItemViewModel.prototype.subscriptions=function(){radio("checkout.offering.remove").subscribe(this.removeOffering),radio("checkout.sellers.create").subscribe(this.setSeller),$(window).on("deliverySelected.vtex",this.handleDeliverySelected)},ItemViewModel.prototype.unsubscribe=function(){radio("checkout.offering.remove").unsubscribe(this.removeOffering),radio("checkout.sellers.create").unsubscribe(this.setSeller),$(window).off("deliverySelected.vtex",this.handleDeliverySelected)},ko.bindingHandlers.inputNumber={init:function(element,valueAccessor,allBindingsAccessor,viewModel,bindingContext){var observable;return observable=valueAccessor(),$(element).inputNumber(),$(element).change(function(){return observable($(this).val())})}},ItemViewModel}(),vtex.checkout.ItemViewModel=ItemViewModel}.call(this),function(){var OfferingViewModel,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};OfferingViewModel=function(){function OfferingViewModel(itemIndex,isOffering){this.addLastItemAttachmentOffering=__bind(this.addLastItemAttachmentOffering,this),this.setOptionDisable=__bind(this.setOptionDisable,this),this.handleFail=__bind(this.handleFail,this),this.setLoading=__bind(this.setLoading,this),this.remove=__bind(this.remove,this),this.isFree=__bind(this.isFree,this),this.update=__bind(this.update,this);var _this=this;this.index=ko.observable(itemIndex),this.isOffering=isOffering,this.id=ko.observable(),this.name=ko.observable(),this.price=ko.observable(),this.tax=ko.observable(0),this.type=ko.observable(),this.selectedItemAttachmentOffering=ko.observable(),this.itemAttachmentsList=ko.observableArray([]),this.itemAttachments=ko.computed(function(){return _.filter(_this.itemAttachmentsList(),function(it){return it.isUsingAttachment()})}),this.itemAttachmentOfferings=ko.computed(function(){var offerings;return offerings=_.filter(_this.itemAttachmentsList(),function(it){return!it.isUsingAttachment()})}),this.addSelectedItemAttachmentOffering=ko.computed(function(){var it;return null!=_this.selectedItemAttachmentOffering()?(it=_.find(_this.itemAttachmentOfferings(),function(it){return it.name()===_this.selectedItemAttachmentOffering().name()}),it.isUsingAttachment(!0),_this.selectedItemAttachmentOffering(null)):void 0}),this.selectItemAttachmentOfferingLabel=ko.computed(function(){return checkout.locale(),i18n.t("cart.addInfo")}),this.lastItemAttachmentOfferingLabel=ko.computed(function(){var _ref;return i18n.t("global.add")+" "+(null!=(_ref=_this.itemAttachmentOfferings()[0])?_ref.name():void 0)}),this.allowGiftMessage=ko.observable(!1),this.giftMessageAttachment=ko.computed(function(){var itemAttachmentsList;return itemAttachmentsList=_.find(_this.itemAttachmentsList(),function(att){return"message"===(null!=att?att.name():void 0)})}),this.loading=ko.observable(!1),this.priceLabel=ko.computed(function(){return _this.isFree()?i18n.t("global.free"):_.intAsCurrency(_this.price())}),radio("checkout.offering.loading").subscribe(this.setLoading),radio("checkout.offering.fail").subscribe(this.handleFail)}return OfferingViewModel.prototype.update=function(data,relativeOffering){var attOff,attachment,attachmentsList,_i,_len,_ref;if(this.id(data.id),this.name(data.name),this.price(data.price),this.type(data.type),data.tax&&this.tax(data.tax),!this.isOffering)for((null!=relativeOffering?relativeOffering.allowGiftMessage:void 0)&&this.allowGiftMessage(relativeOffering.allowGiftMessage),this.itemAttachmentsList.removeAll(),_ref=data.attachmentOfferings,_i=0,_len=_ref.length;_len>_i;_i++)attOff=_ref[_i],attachmentsList=new vtex.checkout.ItemAttachmentListViewModel(this.index(),this.id()),attachment=_.find(data.attachments,function(att){return att.name===attOff.name}),attachmentsList.update(attOff,attachment),this.itemAttachmentsList.push(attachmentsList);return vtex.i18n.translateHtml(".item-service"),this},OfferingViewModel.prototype.isFree=function(){return 0===this.price()},OfferingViewModel.prototype.remove=function(parent){return radio("checkout.offering.remove").broadcast(parent,this.id())},OfferingViewModel.prototype.setLoading=function(itemIndex,id,flag){return itemIndex===this.index()&&id===this.id()?this.loading(flag):void 0},OfferingViewModel.prototype.handleFail=function(itemIndex,id,message){itemIndex!==this.index()||id!==this.id()},OfferingViewModel.prototype.setOptionDisable=function(option,item){return"undefined"==typeof item&&this.selectedItemAttachmentOffering()?ko.applyBindingsToNode(option,{disable:!0},item):void 0},OfferingViewModel.prototype.addLastItemAttachmentOffering=function(){var it;return it=this.itemAttachmentOfferings()[0],it.isUsingAttachment(!0)},OfferingViewModel}(),vtex.checkout.OfferingViewModel=OfferingViewModel}.call(this),function(){var SellerViewModel,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};SellerViewModel=function(){function SellerViewModel(){this.update=__bind(this.update,this),this.id=ko.observable(),this.name=ko.observable(""),this.logo=ko.observable("")}return SellerViewModel.prototype.update=function(data){return null!=data?(this.id(data.id),this.name(data.name),this.logo(data.logo)):void 0},SellerViewModel}(),vtex.checkout.SellerViewModel=SellerViewModel}.call(this),function(){var CouponViewModel,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};CouponViewModel=function(){function CouponViewModel(){this.subscriptions=__bind(this.subscriptions,this),this._APIremoveAndBroadcast=__bind(this._APIremoveAndBroadcast,this),this.removeCoupon=__bind(this.removeCoupon,this),this._APIaddAndBroadcast=__bind(this._APIaddAndBroadcast,this),this.addCoupon=__bind(this.addCoupon,this),this.update=__bind(this.update,this);var _this=this;this.value=ko.observable(""),this.couponCode=ko.observable(),this.isUsingCoupon=ko.observable(!1),this.loadingCoupon=ko.observable(!1),this.subscriptions(),this.isCouponTyped=ko.computed(function(){return""===_this.value()?!1:(_this.isUsingCoupon(!0),!0)})}return CouponViewModel.prototype.update=function(data){return null!=(null!=data?data.coupon:void 0)?this.value(data.coupon):(this.couponCode(""),this.value(""))},CouponViewModel.prototype.addCoupon=function(){return this.couponCode()?(radio("checkout.coupon.loading").broadcast(!0),this._APIaddAndBroadcast()):void 0},CouponViewModel.prototype._APIaddAndBroadcast=function(){return API.addDiscountCoupon(this.couponCode()).always(function(){return radio("checkout.coupon.loading").broadcast(!1)})},CouponViewModel.prototype.removeCoupon=function(){return this.couponCode(""),radio("checkout.coupon.loading").broadcast(!0),this._APIremoveAndBroadcast()},CouponViewModel.prototype._APIremoveAndBroadcast=function(){return API.removeDiscountCoupon().always(function(){return radio("checkout.coupon.loading").broadcast(!1)})},CouponViewModel.prototype.subscriptions=function(){return radio("checkout.marketingData.create").subscribe(this.update),radio("checkout.coupon.loading").subscribe(this.loadingCoupon)},CouponViewModel}(),vtex.checkout.CouponViewModel=CouponViewModel}.call(this),function(){var GatewayExceptionMessage,MessageUtils,showUnavailableMessage,__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;l>i;i++)if(i in this&&this[i]===item)return i;return-1};GatewayExceptionMessage=function(){function GatewayExceptionMessage(json){var _ref,_ref1;this.tidText=ko.observable((null!=(_ref=json.text)?_ref.substr((null!=(_ref1=json.text)?_ref1.indexOf("***"):void 0)+3):void 0).trim()),this.showingTransactionDetails=ko.observable(!1)}return GatewayExceptionMessage.prototype.showTransactionDetails=function(){return this.showingTransactionDetails(!0)},GatewayExceptionMessage}(),showUnavailableMessage=_.throttle(function(){return console.log("-> MessageUtils -> showUnavailableMessage"),$(window).trigger("addMessage.vtex",{type:"fatal",modalTemplate:".unavailable-modal",id:"unavailable-message-modal"})},2e4,{trailing:!1}),MessageUtils=function(){function MessageUtils(){}return MessageUtils.messages=new window.vtex.Messages.getInstance({ajaxError:!0}),MessageUtils.showUnavailableMessage=function(){return showUnavailableMessage()},MessageUtils.showEmailMessage=function(){return console.log("-> MessageUtils -> showEmailMessage"),$(window).trigger("addMessage.vtex",{type:"fatal",modalTemplate:".modal-email-template",id:"email-message-modal"})},MessageUtils.showPaymentUnauthorizedMessage=function(message){var $paymentUnauthorized;return console.log("-> MessageUtils -> showPaymentUnauthorizedMessage"),null!=message&&($paymentUnauthorized=$(".payment-unauthorized-modal")[0],message=new GatewayExceptionMessage(message),ko.cleanNode($paymentUnauthorized),ko.applyBindings(message,$paymentUnauthorized)),$(window).trigger("addMessage.vtex",{type:"fatal",modalTemplate:".modal-payment-unauthorized-template",id:"payment-unauthorized-modal"})},MessageUtils.showMaskedInfoMessage=function(){return console.log("-> MessageUtils -> showMaskedInfoMessage"),$(window).trigger("addMessage.vtex",{type:"fatal",modalTemplate:".modal-masked-info-template",id:"masked-info-modal"})},MessageUtils.showPaymentMessage=function(){return console.log("-> MessageUtils -> showPaymentMessage"),$(window).trigger("addMessage.vtex",{type:"fatal",modalTemplate:".modal-payment-template",id:"payment-message-modal"})},MessageUtils.hidePaymentMessage=function(){return console.log("-> MessageUtils -> hidePaymentMessage"),$(window).trigger("removeMessage.vtex","payment-message-modal")},MessageUtils.showGuestLoginMessage=function(){return console.log("-> MessageUtils -> showGuestLoginMessage"),$(window).trigger("addMessage.vtex",{type:"fatal",modalTemplate:".guest-login-modal",id:"guest-login-modal"})},MessageUtils.hideGuestLoginMessage=function(){return console.log("-> MessageUtils -> hideGuestLoginMessage"),$(window).trigger("removeMessage.vtex","guest-login-modal")},MessageUtils.messageFromAPIMessage=function(messageFromAPI){var html;return html="fatal"===messageFromAPI.status?!0:!1,{type:messageFromAPI.status,content:{detail:messageFromAPI.text,html:html},close:i18n.t("global.close")}},MessageUtils.showMessagesFromOrderForm=function(messagesJSON){var authorizationErrorCodes,ignoredMessageCodes,message,_i,_len,_ref,_ref1;for(ignoredMessageCodes=["cannotBeDelivered","withoutStock","unavailableItemFulfillment","withoutPrice","withoutPriceRnB","nullPrice"],authorizationErrorCodes=["transactionMissingRequestData","transactionInvalidRequiredParameter","transactionUnauthorized","transactionAuthorizationDenied","transactionNotApproved","transactionAnalyzingRisk","transactionInRiskAnalysis","transactionCannotBeSettled","transactionRejectedByAntifraud","transactionAuthenticationFailed","transactionAuthorizationDeniedWithoutCause","transactionInvalidRequest","gatewayServiceTimeout","gatewayCommunicationError","paymentUnauthorized","paymentPending"],
_i=0,_len=messagesJSON.length;_len>_i;_i++)message=messagesJSON[_i],_ref=message.code,__indexOf.call(authorizationErrorCodes,_ref)>=0?this.showPaymentUnauthorizedMessage(message):(_ref1=message.code,__indexOf.call(ignoredMessageCodes,_ref1)<0&&MessageUtils.showMessage(message));return messagesJSON.length>0?API.clearMessages():void 0},MessageUtils.showMessage=function(message){return console.log("-> MessageUtils -> showMessage"),$(window).trigger("addMessage.vtex",MessageUtils.messageFromAPIMessage(message))},MessageUtils.clear=function(index){return void 0!==index?MessageUtils.messages.messagesArray.splice(index,1):API.clearMessages()},MessageUtils}.call(this),window.vtex.checkout.MessageUtils=MessageUtils,$(window).on("showMessage.vtex",function(ev,message){var capitalizedMessageId,showMesssageFunction,_base;if(message)return capitalizedMessageId=message.charAt(0).toUpperCase()+message.slice(1),showMesssageFunction="show"+capitalizedMessageId+"Message","function"==typeof(_base=window.vtex.checkout.MessageUtils)[showMesssageFunction]?_base[showMesssageFunction]():void 0})}.call(this),function(){var CartViewModel,debug,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};debug=vtex.debug("cart"),CartViewModel=function(){function CartViewModel(checkoutModel){this.removeUnavailableProducts=__bind(this.removeUnavailableProducts,this),this.itemSubmitHandler=__bind(this.itemSubmitHandler,this),this.parseOrderFormResponse=__bind(this.parseOrderFormResponse,this);var _this=this;this.allowManualPrice=ko.observable(!1),this.itemsAndGifts=ko.observableArray([]),this.items=ko.computed(function(){return _.filter(_this.itemsAndGifts(),function(i){return!i.isGift()})}),this.gifts=ko.computed(function(){return _.filter(_this.itemsAndGifts(),function(i){return i.isGift()})}),this.hasItems=ko.computed(function(){return _this.items().length>0}).extend({throttle:100}),this.hasItemsAndIsInCart=ko.computed(function(){var isInCart,_ref;return isInCart=(null!=(_ref=window.router)&&"function"==typeof _ref.inCart?_ref.inCart():void 0)?window.router.inCart():!1,_this.hasItems()&&isInCart}),this.availableItems=ko.computed(function(){return _.filter(_this.items(),function(i){return i.available()})}),this.unavailableItems=ko.computed(function(){return _.filter(_this.items(),function(i){return!i.available()})}),this.unavailableItemsCannotBeDelivered=ko.computed(function(){return _.all(_this.unavailableItems(),function(i){return i.unavailableForDelivery()})}),this.loading=checkoutModel.loading,this.loadingItem=ko.observable(!1),$(window).on("orderFormUpdated.vtex",function(e,orderForm){return debug("updating orderForm via event"),_this.parseOrderFormResponse(orderForm)}),radio("checkout.item.submit").subscribe(this.itemSubmitHandler)}return CartViewModel.prototype.parseOrderFormResponse=function(orderForm){var item,seller,_i,_j,_len,_len1,_ref,_ref1,_results;if(null!=orderForm.items){for(this.allowManualPrice(orderForm.allowManualPrice),this.loadingItem(!1),_ref=this.itemsAndGifts.removeAll(),_i=0,_len=_ref.length;_len>_i;_i++)item=_ref[_i],item.unsubscribe();if(this.itemsAndGifts(_.map(orderForm.items,function(item,index){var _ref1,_ref2;return new vtex.checkout.ItemViewModel(item,index,null!=(_ref1=orderForm.ratesAndBenefitsData)?_ref1.rateAndBenefitsIdentifiers:void 0,null!=(_ref2=orderForm.shippingData)?_ref2.logisticsInfo:void 0)})),orderForm.sellers){for(_ref1=orderForm.sellers,_results=[],_j=0,_len1=_ref1.length;_len1>_j;_j++)seller=_ref1[_j],_results.push(radio("checkout.sellers.create").broadcast(seller));return _results}}},CartViewModel.prototype.itemSubmitHandler=function(items){var itemIndexesToRemove,_this=this;return itemIndexesToRemove=_.chain(items).filter(function(i){return 0===i.quantity}).pluck("index").value(),_(itemIndexesToRemove).each(function(i){return _this.items().splice(i,1)}),this.items.notifySubscribers(),API.updateItems(items)},CartViewModel.prototype.removeUnavailableProducts=function(){var promiseForItemRemove,unavailableItems;return unavailableItems=_.map(ko.toJS(this.unavailableItems()),function(i){return _.pick(i,"index","quantity","sellerId")}),promiseForItemRemove=API.removeItems(unavailableItems),promiseForItemRemove.done(function(){return router.setHash("orderform")})},CartViewModel}(),vtex.checkout.CartViewModel=CartViewModel}.call(this),function(){var ItemAttachmentViewModel,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};ItemAttachmentViewModel=function(){function ItemAttachmentViewModel(parent,name,schema){this.update=__bind(this.update,this);var _this=this;this.name=name,this.nameSlug=_.sanitize(_.spacesToHyphens(name)).replace(/[^-A-z0-9]/,"").toLowerCase(),this.maxLength=ko.observable(schema.maxLength||schema.maximumNumberOfCharacters||150),this.domain=ko.observableArray(schema.domain||[]),this.value=ko.observable(""),this.oldValue=ko.observable(""),this.isUsingAttachment=ko.observable(!1),this.inputClass=ko.computed(function(){return _this.maxLength()<6?"input-micro":_this.maxLength()<10?"input-mini":_this.maxLength()<18?"input-small":_this.maxLength()<29?"input-medium":_this.maxLength()<60?"input-large":void 0}),this.inputType=ko.computed(function(){var domain;return domain=_this.domain(),domain.length>0?2===domain.length&&_.contains(domain,"true")&&_.contains(domain,"false")?"checkbox":"select":_this.maxLength()<60?"text":"textarea"}),this.charsTyped=ko.computed(function(){return null!=_this.value()?_this.value().length:0}),this.saveMessage=_.debounce(function(){return _this.value()!==_this.oldValue()?(_this.oldValue(_this.value()),parent.saveAttachment()):void 0},500),this.value.subscribe(function(value){return"select"===_this.inputType()&&_this.isUsingAttachment()?_this.saveMessage():void 0})}return ItemAttachmentViewModel.prototype.update=function(value){return this.oldValue(value),this.value(value)},ItemAttachmentViewModel}(),vtex.checkout.ItemAttachmentViewModel=ItemAttachmentViewModel}.call(this),function(){var ItemAttachmentListViewModel,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};ItemAttachmentListViewModel=function(){function ItemAttachmentListViewModel(itemIndex,bundleItemId){this.getExpectedOrderFormSections=__bind(this.getExpectedOrderFormSections,this),this.handleFail=__bind(this.handleFail,this),this.bundleLoading=__bind(this.bundleLoading,this),this.itemLoading=__bind(this.itemLoading,this),this.removeOfferingAttachmentHandler=__bind(this.removeOfferingAttachmentHandler,this),this.saveOfferingAttachmentHandler=__bind(this.saveOfferingAttachmentHandler,this),this.removeItemAttachmentHandler=__bind(this.removeItemAttachmentHandler,this),this.saveItemAttachmentHandler=__bind(this.saveItemAttachmentHandler,this),this.setLoading=__bind(this.setLoading,this),this.removeAttachment=__bind(this.removeAttachment,this),this.saveAttachment=__bind(this.saveAttachment,this),this.getContent=__bind(this.getContent,this),this.update=__bind(this.update,this),this.writeValue=__bind(this.writeValue,this);var _this=this;this.itemIndex=itemIndex,this.bundleItemId=bundleItemId,this.name=ko.observable(),this.nameSlug=ko.observable(),this.required=ko.observable(),this.itemAttachments=ko.observableArray([]),this.isUsingAttachment=ko.observable(!1),this.setIsUsingAttachmentOnChild=ko.computed(function(){var att,isUsing,_i,_len,_ref,_results;for(isUsing=_this.isUsingAttachment(),_ref=_this.itemAttachments(),_results=[],_i=0,_len=_ref.length;_len>_i;_i++)att=_ref[_i],_results.push(att.isUsingAttachment(isUsing));return _results}),this.giftMessageAttachment=ko.observable(),this.isSaved=ko.observable(!1),this.loading=ko.observable(!1),radio("checkout.offering.loading").subscribe(this.setLoading),this.giftMessageId=ko.computed(function(){return _this.itemIndex+_this.name()}),this.showRemoveAttachment=ko.computed(function(){return!window.cart.loadingItem()&&!_this.required()})}return ItemAttachmentListViewModel.prototype.writeValue=function(){return this.isUsingAttachment(!0),$("#gift-message-"+this.giftMessageId()).focus()},ItemAttachmentListViewModel.prototype.update=function(itemAttachmentOffering,attachment){var attachmentName,content,itemAttachment,schema,value,_ref;this.name(itemAttachmentOffering.name),this.nameSlug(_.sanitize(_.spacesToHyphens(itemAttachmentOffering.name)).toLowerCase()),this.required(itemAttachmentOffering.required),this.itemAttachments.removeAll(),_ref=itemAttachmentOffering.schema;for(attachmentName in _ref)schema=_ref[attachmentName],itemAttachment=new vtex.checkout.ItemAttachmentViewModel(this,attachmentName,schema),this.itemAttachments.push(itemAttachment);if(attachment){content=attachment.content;for(attachmentName in content)value=content[attachmentName],null!=value&&""!==value&&(this.isUsingAttachment(!0),this.isSaved(!0)),itemAttachment=_.find(this.itemAttachments(),function(att){return att.name===attachmentName}),itemAttachment&&itemAttachment.update(value)}return"message"===this.name()&&this.giftMessageAttachment(_.find(this.itemAttachments(),function(att){return"text"===att.name})),this.required()?this.isUsingAttachment(!0):void 0},ItemAttachmentListViewModel.prototype.getContent=function(){var data,itemAtt,_i,_len,_ref;for(data={},_ref=this.itemAttachments(),_i=0,_len=_ref.length;_len>_i;_i++)itemAtt=_ref[_i],data[itemAtt.name]=itemAtt.value();return data},ItemAttachmentListViewModel.prototype.saveAttachment=function(){var data,request,_this=this;if(this.isUsingAttachment()!==!1)return data=this.getContent(),this.isSaved()&&_.all(data,function(v){return""===v})?this.removeAttachment(data):(request=this.bundleItemId?this.saveOfferingAttachmentHandler(this.itemIndex,this.bundleItemId,this.name(),data):this.saveItemAttachmentHandler(this.itemIndex,this.name(),data),request.done(function(){return _this.isSaved(!0)}))},ItemAttachmentListViewModel.prototype.removeAttachment=function(){var data,request,_this=this;return data=this.getContent(),this.isUsingAttachment(!1),this.isSaved()?(request=this.bundleItemId?this.removeOfferingAttachmentHandler(this.itemIndex,this.bundleItemId,this.name(),data):this.removeItemAttachmentHandler(this.itemIndex,this.name(),data),request.done(function(){var itemAtt,_i,_len,_ref,_results;for(_this.isSaved(!1),_ref=_this.itemAttachments(),_results=[],_i=0,_len=_ref.length;_len>_i;_i++)itemAtt=_ref[_i],_results.push(itemAtt.value(""));return _results})):void 0},ItemAttachmentListViewModel.prototype.setLoading=function(itemIndex,id,flag){return itemIndex===this.itemIndex&&id===this.bundleItemId?this.loading(flag):void 0},ItemAttachmentListViewModel.prototype.saveItemAttachmentHandler=function(itemIndex,attachmentName,attachment){var expected,xhr,_this=this;return expected=this.getExpectedOrderFormSections(),this.itemLoading(itemIndex,!0),xhr=API.addItemAttachment(itemIndex,attachmentName,attachment,expected),xhr.fail(function(data){return _this.handleFail(data.messages,itemIndex)}),xhr.always(function(){return _this.itemLoading(itemIndex,!1)})},ItemAttachmentListViewModel.prototype.removeItemAttachmentHandler=function(itemIndex,attachmentName,attachment){var expected,xhr,_this=this;return expected=this.getExpectedOrderFormSections(),this.itemLoading(itemIndex,!0),xhr=API.removeItemAttachment(itemIndex,attachmentName,attachment,expected),xhr.fail(function(data){return _this.handleFail(data.messages,itemIndex)}),xhr.always(function(){return _this.itemLoading(itemIndex,!1)})},ItemAttachmentListViewModel.prototype.saveOfferingAttachmentHandler=function(itemIndex,bundleItemId,attachmentName,attachment){var expected,xhr,_this=this;return expected=this.getExpectedOrderFormSections(),this.bundleLoading(itemIndex,bundleItemId,!0),xhr=API.addBundleItemAttachment(itemIndex,bundleItemId,attachmentName,attachment,expected),xhr.fail(function(data){return _this.handleFail(data.messages,itemIndex,bundleItemId)}),xhr.always(function(){return _this.bundleLoading(itemIndex,bundleItemId,!1)})},ItemAttachmentListViewModel.prototype.removeOfferingAttachmentHandler=function(itemIndex,bundleItemId,attachmentName,attachment){var expected,xhr,_this=this;return expected=this.getExpectedOrderFormSections(),this.bundleLoading(itemIndex,bundleItemId,!0),xhr=API.removeBundleItemAttachment(itemIndex,bundleItemId,attachmentName,attachment,expected),xhr.fail(function(data){return _this.handleFail(data.messages,itemIndex,bundleItemId)}),xhr.always(function(){return _this.bundleLoading(itemIndex,bundleItemId,!1)})},ItemAttachmentListViewModel.prototype.itemLoading=function(itemIndex,active){return radio("checkout.item.loading").broadcast(itemIndex,active)},ItemAttachmentListViewModel.prototype.bundleLoading=function(itemIndex,bundleItemId,active){return radio("checkout.offering.loading").broadcast(itemIndex,bundleItemId,active)},ItemAttachmentListViewModel.prototype.handleFail=function(messages,itemIndex,bundleItemId){return messages&&vtex.checkout.MessageUtils.showMessagesFromOrderForm(messages),bundleItemId?radio("checkout.offering.fail").broadcast(itemIndex,bundleItemId):radio("checkout.item.fail").broadcast(itemIndex)},ItemAttachmentListViewModel.prototype.getExpectedOrderFormSections=function(){return this.expectedOrderFormSections?this.expectedOrderFormSections:this.expectedOrderFormSections=_.without(vtexjs.checkout._allOrderFormSections,"items")},ItemAttachmentListViewModel}(),vtex.checkout.ItemAttachmentListViewModel=ItemAttachmentListViewModel}.call(this),function(){var SlaViewModel,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};SlaViewModel=function(){function SlaViewModel(json){this.validateSlaFunction=__bind(this.validateSlaFunction,this),this.getPickadateSelectedDate=__bind(this.getPickadateSelectedDate,this),this.getPickadateOptions=__bind(this.getPickadateOptions,this),this.dateChangedHandler=__bind(this.dateChangedHandler,this),this.update=__bind(this.update,this),this.updateLabelsAndPriceProperties=__bind(this.updateLabelsAndPriceProperties,this);var _this=this;this.name="",this.id="",this.price=0,this.summedPrice=null,this.shippingEstimate=0,this.maxShippingEstimate=void 0,this.availableDeliveryWindows=[],this.tax=0,this.summedTaxes=null,this.selectedDeliveryDate=ko.observable(),this.deliveryWindowIndex=ko.observable(null),this.deliveryWindow=function(){return _this.availableDeliveryWindows[_this.deliveryWindowIndex()]},this.maxEstimateOptionText=ko.observable(null),this.valueEstimateLabel=ko.observable(null),this.maxEstimateLabel="",this.exactEstimateLabel="",this.deliveryWindowsForDate=ko.computed(function(){var deliveryDate;return deliveryDate=_this.selectedDeliveryDate(),_(_this.availableDeliveryWindows).filter(function(dw){return dw.dateString===SlaViewModel.dateToDateString(deliveryDate)})}),this.deliveryWindowIndex.subscribe(function(dwIndex){var dw,valueLabel;return dw=_this.availableDeliveryWindows[dwIndex],valueLabel=_.intAsCurrency(dw.price+_this.price),_this.maxEstimateOptionText(_this.name+" - "+valueLabel+" - "+_.dateFormat(dw.endDate)),_this.updateLabelsAndPriceProperties()}),this.formatDate=function(date){var day,month,year;return year=date.getFullYear(),month=date.getMonth()+1,day=date.getDate(),10>month&&(month="0"+month),"en-US"===window.vtex.i18n.getLocale()?month+"/"+day+"/"+year:day+"/"+month+"/"+year},this.update(json)}return SlaViewModel.prototype.updateLabelsAndPriceProperties=function(){var cheapestValue,earliestDate,firstDate,from,isFree,maxWorkingDays,price,tax,workingDays,_ref,_ref1;return price=null!=(_ref=this.summedPrice)?_ref:this.price,tax=null!=(_ref1=this.summedTaxes)?_ref1:this.tax,this.valueLabel=_.intAsCurrency(price),this.taxValueLabel=tax>0?_.intAsCurrency(tax):i18n.t("global.free"),void 0===this.maxShippingEstimate||this.isScheduled||(maxWorkingDays=this.businessDays?i18n.t("shippingData.workingDay"+(this.maxShippingEstimate>1?"s":"")):i18n.t("shippingData.day"+(this.maxShippingEstimate>1?"s":"")),this.maxEstimateLabel=i18n.t("shippingData.upTo")+" ",this.maxEstimateLabel+=this.maxShippingEstimate+" "+maxWorkingDays,this.maxEstimateOptionText(this.name+" - "+this.valueLabel+" - "+this.maxEstimateLabel)),void 0!==this.shippingEstimate&&(workingDays=this.businessDays?i18n.t("shippingData.workingDay"+(this.shippingEstimate>1?"s":"")):i18n.t("shippingData.day"+(this.shippingEstimate>1?"s":"")),this.estimateLabel=this.shippingEstimate+" "+workingDays),this.label=this.name+" - "+this.valueLabel,this.valueEstimateLabel(this.valueLabel),this.isScheduled?(this.estimateLabel=i18n.t("shippingData.scheduled"),earliestDate=null,cheapestValue=Number.MAX_VALUE,isFree=!0,_(this.availableDeliveryWindows).each(function(dw,i){var objTranslation;if(dw.index=i,dw.startDate=SlaViewModel.fromApiDate(dw.startDateUtc),dw.endDate=SlaViewModel.fromApiDate(dw.endDateUtc),dw.dateAsArray=SlaViewModel.dateToDateArray(dw.startDate),dw.dateString=SlaViewModel.dateToDateString(dw.startDate),dw.value=dw.price+price,dw.value>0?(dw.valueLabel=_.intAsCurrency(dw.value),isFree=!1):dw.valueLabel=i18n.t("global.free"),objTranslation={from:SlaViewModel.dateHourMinLabel(dw.startDate),to:SlaViewModel.dateHourMinLabel(dw.endDate)},dw.label=i18n.t("shippingData.fromToHour",objTranslation)+"  - "+dw.valueLabel,dw.timeLabel=i18n.t("shippingData.fromToHour",objTranslation),isNaN(dw.dateAsArray[0]))throw new Error("Datas de entrega agendada apresentam formato incorreto.");return cheapestValue=Math.min(dw.price+price,cheapestValue),null==earliestDate?earliestDate=dw.startDate:dw.startDate<earliestDate?earliestDate=dw.startDate:void 0}),firstDate=i18n.t("shippingData.firstDate"),from=i18n.t("shippingData.priceFrom"),isFree?this.maxEstimateOptionText(this.name+" - "+i18n.t("global.free")+" - "+firstDate+" "+_.dateFormat(earliestDate)):this.maxEstimateOptionText(this.name+" - "+from+" "+_.intAsCurrency(cheapestValue)+" - "+firstDate+" "+_.dateFormat(earliestDate)),null===this.deliveryWindowIndex()?this.exactEstimateLabel=i18n.t("shippingData.toSchedule"):(this.exactEstimateLabel=_.dateFormat(this.deliveryWindow().endDate),this.label=this.name+" - "+this.deliveryWindow().valueLabel,this.valueEstimateLabel(this.deliveryWindow().valueLabel))):this},SlaViewModel.prototype.update=function(serverJSON){var json,selectedDeliveryWindow,selectedDeliveryWindowIndex;return json=JSON.parse(JSON.stringify(serverJSON)),this.name=json.name,this.id=json.id,this.businessDays=void 0===json.businessDays?-1!==(json.shippingEstimate+"").indexOf("bd"):json.businessDays,this.shippingEstimate=parseInt((json.shippingEstimate+"").replace(/bd|d/,""),10),this.price=json.price,this.tax=json.tax,this.availableDeliveryWindows=json.availableDeliveryWindows,this.isScheduled=this.availableDeliveryWindows&&this.availableDeliveryWindows.length>0,this.updateLabelsAndPriceProperties(),json.deliveryWindow&&(selectedDeliveryWindowIndex=null,_(this.availableDeliveryWindows).each(function(dw,i){var sdw;return sdw=json.deliveryWindow,dw.startDateUtc===sdw.startDateUtc&&dw.endDateUtc===sdw.endDateUtc?selectedDeliveryWindowIndex=i:void 0}),null!=selectedDeliveryWindowIndex&&(this.deliveryWindowIndex(selectedDeliveryWindowIndex),selectedDeliveryWindow=this.deliveryWindow(),selectedDeliveryWindow&&this.selectedDeliveryDate(selectedDeliveryWindow.startDate))),this},SlaViewModel.prototype.toJSON=function(){return{id:this.id,name:this.name,price:this.price,tax:this.tax,shippingEstimate:this.shippingEstimate,businessDays:this.businessDays,availableDeliveryWindows:_(this.availableDeliveryWindows).map(function(dw){return _(dw).pick("startDateUtc","endDateUtc","price","tax")}),deliveryWindow:this.deliveryWindow()}},SlaViewModel.prototype.dateChangedHandler=function(date){return date.setHours(0,0,0,0)!==this.selectedDeliveryDate().setHours(0,0,0,0)?(this.selectedDeliveryDate(date),this.deliveryWindowIndex(this.deliveryWindowsForDate()[0].index)):void 0},SlaViewModel.prototype.getPickadateOptions=function(){var deliveryDates,slatype;return deliveryDates=[],_.each(this.availableDeliveryWindows,function(dw){var dateAsArray;return dateAsArray=dw.dateAsArray,_.find(deliveryDates,function(d){return d[0]===dateAsArray[0]&&d[1]===dateAsArray[1]&&d[2]===dateAsArray[2]})?void 0:deliveryDates.push(dateAsArray)}),slatype=this,{datesDisabled:[!0].concat(deliveryDates),onSelect:function(){return slatype.dateChangedHandler(this.getDate(!0))}}},SlaViewModel.prototype.getPickadateSelectedDate=function(){return SlaViewModel.dateToDateArray(this.selectedDeliveryDate())},SlaViewModel.prototype.validateSlaFunction=function(value,element){var validation;return validation={result:!1,message:""},this.selectedDeliveryDate.peek()?(validation.applyErrorClass=validation.showErrorMessage=!1,validation.result=!0):(validation.message=i18n.t("shippingData.chooseScheduledDate"),validation.applyErrorClass=validation.showErrorMessage=!0,router.inOrderForm()&&(validation.giveFocus=!0),validation.result=!1),validation},SlaViewModel.dateToDateArray=function(date){return date?[date.getUTCFullYear(),date.getUTCMonth()+1,date.getUTCDate()]:void 0},SlaViewModel.dateToDateString=function(date){return date?date.getUTCFullYear()+"-"+(date.getUTCMonth()+1)+"-"+date.getUTCDate():void 0},SlaViewModel.dateHourMinLabel=function(date){return date?_.pad(date.getUTCHours(),2)+":"+_.pad(date.getUTCMinutes(),2):void 0},SlaViewModel.toTicks=function(tickString){var ticks;return ticks=tickString.split("(")[1].split(")")[0].split("+"),parseInt(ticks[0])},SlaViewModel.fromApiDate=function(apiDate){return-1===apiDate.indexOf("Date")?window.dammitIE?_.dateFromISO8601(apiDate):new Date(apiDate):new Date(SlaViewModel.toTicks(apiDate))},SlaViewModel}(),vtex.checkout.SlaViewModel=SlaViewModel}.call(this),function(){var LogisticsInfoViewModel,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};LogisticsInfoViewModel=function(){function LogisticsInfoViewModel(json){this.toJSON=__bind(this.toJSON,this),this.setDeliveryWindow=__bind(this.setDeliveryWindow,this),this.setSelectedSla=__bind(this.setSelectedSla,this),this.update=__bind(this.update,this);var _this=this;this.itemIndex=ko.observable(),this.item={},this.seller={},this.selectedSla=ko.observable(),this.deliveryWindow=ko.observable(),this.slas=ko.observableArray([]),this.selectedSlaVM=ko.computed(function(){return _(_this.slas()).find(function(s){return s.id===_this.selectedSla()})}),this.estimateLabel=ko.computed(function(){var _ref;return null!=(_ref=_this.selectedSlaVM())?_ref.estimateLabel:void 0}),this.slaLabel=ko.computed(function(){var _ref;return null!=(_ref=_this.selectedSlaVM())?_ref.label:void 0}),this.update(json)}return LogisticsInfoViewModel.prototype.update=function(json){var dw,scheduledSla,_ref,_ref1,_ref2,_this=this;return this.itemIndex(json.itemIndex),this.item=null!=(_ref=window.cart)?_ref.itemsAndGifts()[this.itemIndex()]:void 0,this.seller=null!=(_ref1=this.item)?_ref1.seller:void 0,this.slas(_(json.slas).map(function(s){return new vtex.checkout.SlaViewModel(s)})),scheduledSla=_(this.slas()).find(function(sla){return sla.isScheduled}),scheduledSla&&scheduledSla.deliveryWindowIndex.subscribe(function(){return _this.setDeliveryWindow(scheduledSla.deliveryWindow())}),this.selectedSla(json.selectedSla),dw=null!=(_ref2=this.selectedSlaVM())?_ref2.deliveryWindow():void 0,dw&&this.deliveryWindow(_(dw).pick("startDateUtc","endDateUtc","price","tax")),this},LogisticsInfoViewModel.prototype.setSelectedSla=function(slaName){var sla,_i,_len,_ref,_results;if(this.slas()){for(_ref=this.slas(),_results=[],_i=0,_len=_ref.length;_len>_i;_i++)sla=_ref[_i],sla.name===slaName?_results.push(this.selectedSla(sla.id)):_results.push(void 0);return _results}},LogisticsInfoViewModel.prototype.setDeliveryWindow=function(deliveryWindow){return this.deliveryWindow(_(deliveryWindow).pick("startDateUtc","endDateUtc","price","tax"))},LogisticsInfoViewModel.prototype.toJSON=function(){var _ref,_ref1;return{itemIndex:this.itemIndex(),slas:_(this.slas()).map(function(sla){return sla.toJSON()}),selectedSla:this.selectedSla(),deliveryWindow:(null!=(_ref=this.selectedSlaVM())?_ref.isScheduled:void 0)?this.deliveryWindow():void 0,tax:null!=(_ref1=this.selectedSlaVM())?_ref1.tax:void 0}},LogisticsInfoViewModel}(),vtex.checkout.LogisticsInfoViewModel=LogisticsInfoViewModel}.call(this),function(){vtex.checkout.cartFixed=function(){var cart,cartFixedReset,cartFixedScroll,cartItemsHeight,cartWrapper,confirmation,confirmationBottom,confirmationHeight,orderform,payment,paymentButtonPosition,setCartItemsHeight,shipping,sidebar,sidebarTitleHeight,sidebarTop,sidebarWrapper,summary,topDistance,windowWidth;return orderform=null,cart=null,sidebar=null,sidebarWrapper=null,sidebarTop=null,cartWrapper=null,sidebarTitleHeight=null,confirmation=null,confirmationHeight=null,confirmationBottom=null,paymentButtonPosition=null,cartItemsHeight=null,payment=null,shipping=null,summary=null,topDistance=20,setCartItemsHeight=function(sidebarWrapperHeight){var itemsHeight,summaryHeight;return summaryHeight=summary.outerHeight(!0),itemsHeight=paymentData.active()?sidebarWrapperHeight?sidebarWrapperHeight-confirmationHeight-confirmationBottom-summaryHeight-sidebarTitleHeight:sidebarWrapper.height()-confirmationHeight-confirmationBottom-summaryHeight-sidebarTitleHeight:sidebarWrapperHeight-confirmationBottom-summaryHeight-sidebarTitleHeight,cart.outerHeight(!0)>itemsHeight?(cartWrapper.height(itemsHeight),setTimeout(function(){return cartWrapper.addClass("cart-fixed-transition",0)})):(cartWrapper.removeClass("cart-fixed-transition"),cartWrapper.height("auto"))},cartFixedScroll=function(){var paymentHeight,paymentTop,scrollTop,shippingHeight,sidebarWrapperHeight,windowHeight;return sidebarTop=sidebar.offset().top,windowHeight=$(window).height(),scrollTop=document.documentElement&&document.documentElement.scrollTop>0?document.documentElement.scrollTop:$("body").scrollTop(),paymentTop=payment.offset().top,paymentHeight=payment.height(),shippingHeight=shipping.outerHeight(!0),sidebarWrapperHeight=null,sidebarWrapperHeight=paymentData.active()?paymentHeight+paymentTop-scrollTop>windowHeight?sidebarWrapper.hasClass("affix-top")?windowHeight-sidebarTop+scrollTop:windowHeight-topDistance:sidebarWrapper.hasClass("affix-top")?paymentHeight+shippingHeight:paymentHeight+paymentTop-scrollTop-topDistance:sidebarWrapper.hasClass("affix-top")?orderform.outerHeight():orderform.outerHeight()+orderform.offset().top-scrollTop-topDistance,sidebarWrapper.height(sidebarWrapperHeight),setCartItemsHeight(sidebarWrapperHeight)},cartFixedReset=function(){return sidebarWrapper.height("auto"),cartWrapper.height("auto")},sidebar=$(".mini-cart"),sidebar.length>0&&(orderform=$(".orderform-template-holder"),sidebarTop=sidebar.offset().top,sidebarWrapper=$(".cart-fixed"),sidebarTitleHeight=sidebar.find("h2").outerHeight(!0),cart=sidebar.find(".cart"),cartWrapper=sidebar.find(".summary-cart-template-holder"),confirmation=$(".payment-confirmation-wrap"),confirmationHeight=confirmation.outerHeight(!0),confirmationBottom=confirmation.css("bottom")?confirmation.css("bottom").replace("px",""):20,summary=sidebar.find(".summary-template-holder"),payment=$(".payment-data"),shipping=$(".step.shipping-data"),windowWidth=968,$(window).width()>windowWidth?(sidebarWrapper.affix({offset:{top:sidebarTop-topDistance}}),cartFixedScroll()):cartFixedReset(),sidebarWrapper.addClass("cart-fixed-transition"),$(window).on({resize:function(){return $(window).width()>windowWidth?(sidebarTop=sidebar.offset().top,sidebarWrapper.affix({offset:{top:sidebarTop-topDistance}}),cartFixedScroll()):cartFixedReset()},scroll:function(){return $(window).width()>windowWidth?(clearTimeout(paymentButtonPosition),paymentButtonPosition=setTimeout(cartFixedScroll,100)):void 0}})),radio("checkout.fixCart").subscribe(cartFixedScroll)}}.call(this),function(){window.vtex||(window.vtex={}),vtex.checkout||(vtex.checkout={}),vtex.checkout.ObservableStep=function(_this){var self;return self=_this,{stepId:"",active:ko.observable(!1),visited:ko.observable(!1),loading:ko.observable(!1),visitedAndNotActive:ko.computed({read:function(){return self.visited()&&!self.active()},deferEvaluation:!0}),notVisitedAndNotActive:ko.computed({read:function(){return!self.visited()&&!self.active()},deferEvaluation:!0}),enable:function(){return self.visited(!0),self.active(!0),self.isValid({giveFocus:!0,showErrorMessage:!1,applyErrorClass:!1})},disable:function(){return self.active(!1)}}}}.call(this),function(){window.vtex||(window.vtex={}),vtex.checkout||(vtex.checkout={}),vtex.checkout.Attachment=function(attachmentId){return null==attachmentId&&(attachmentId=""),{templateOptions:{},attachmentId:attachmentId,validate:function(options){return void 0},isValid:function(){return void 0}}}}.call(this),function(){var ClientProfileDataViewModel,debug,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;l>i;i++)if(i in this&&this[i]===item)return i;return-1};debug=vtex.debug("profile"),ClientProfileDataViewModel=function(){function ClientProfileDataViewModel(){this.parseOrderFormResponse=__bind(this.parseOrderFormResponse,this),this.afterRender=__bind(this.afterRender,this),this.submit=__bind(this.submit,this),this.emailSubmitHandler=__bind(this.emailSubmitHandler,this),this.done=__bind(this.done,this),this.toJSON=__bind(this.toJSON,this),this.validateCorporateDocument=__bind(this.validateCorporateDocument,this),this.validateDocument=__bind(this.validateDocument,this),this.validateARGPhone=__bind(this.validateARGPhone,this),this.validateARGPhoneNDC=__bind(this.validateARGPhoneNDC,this),this.validatePhoneNDC=__bind(this.validatePhoneNDC,this),this.validatePhone=__bind(this.validatePhone,this),this.getPhoneValidationResult=__bind(this.getPhoneValidationResult,this),this.disable=__bind(this.disable,this),this.next=__bind(this.next,this),this.postUpdate=__bind(this.postUpdate,this),this.isValid=__bind(this.isValid,this),this.validate=__bind(this.validate,this),this.blurEmail=__bind(this.blurEmail,this),this.submitFirstEmail=__bind(this.submitFirstEmail,this),this.toggleCorporate=__bind(this.toggleCorporate,this),this.toggleDifferentPhone=__bind(this.toggleDifferentPhone,this),this.toggleDifferentDocument=__bind(this.toggleDifferentDocument,this),this.update=__bind(this.update,this),this.serializableProperties=__bind(this.serializableProperties,this),this.acceptPhoneSuggestion=__bind(this.acceptPhoneSuggestion,this),this.suggestPhone=__bind(this.suggestPhone,this),this.acceptSuggestion=__bind(this.acceptSuggestion,this),this.handleUserProfileNotFound=__bind(this.handleUserProfileNotFound,this),this.getRule=__bind(this.getRule,this);var _this=this;this.moduleId=this.stepId=this.attachmentId=this.id="clientProfileData",_.extend(ClientProfileDataViewModel.prototype,vtex.checkout.ObservableStep(this)),_.extend(ClientProfileDataViewModel.prototype,vtex.checkout.Attachment(this.id)),_.extend(ClientProfileDataViewModel.prototype,vtex.checkout.Module),this.applyModuleSubscriptions(),this.isCorporate=ko.observable(!1),this.showEmailForm=ko.observable(!0),this.firstName=ko.observable(),this.lastName=ko.observable(),this.fullName=ko.computed(function(){return _this.firstName()+" "+_this.lastName()}),this.fullName.subscribe(function(){return $(window).trigger("profileUpdated",[_this.toJSON()])}),this.oldDocument=ko.observable(),this.document=ko.observable(),this.alternateDocument=ko.observable(),this.oldDocumentType=ko.observable(),this.documentType=ko.observable(checkout.defaultDocumentType()),this.alternateDocumentType=ko.observable(),this.hasDifferentDocument=ko.observable(!1),this.hasDifferentPhone=ko.observable(!1),this.differentPhoneFlag=!1,this.changeDefaultDocumentType=ko.computed(function(){var defaultDocumentType;return defaultDocumentType=checkout.defaultDocumentType(),_this.hasDifferentDocument()===!1?_this.documentType(defaultDocumentType):void 0}),this.corporateName=ko.observable(),this.tradeName=ko.observable(),this.corporateDocument=ko.observable(),this.stateInscription=ko.observable(),
this.firstEmail=ko.observable(),this.exempt=ko.observable(!1),this.countryRules={BRA:{customPhoneTemplate:!1,twoSeparateFieldsForPhone:!1,documentRequired:!0,documentRequiredForCorporate:!1,tradeNameRequired:!0,stateInscriptionRequired:!0,showCorporateTradeName:!0,showCorporateStateInscription:!0,showCorporateExempt:!0,showCorporateDocument:!0,showDocumentInCorporate:!1,companyClientAttributes:["isCorporate","corporateName","tradeName","corporateDocument","stateInscription"],personClientAttributes:["firstEmail","email","firstName","lastName","document","phone","documentType"]},ARG:{customPhoneTemplate:!0,twoSeparateFieldsForPhone:!0},CHL:{customPhoneTemplate:!0,twoSeparateFieldsForPhone:!0},COL:{showCorporateExempt:!1,stateInscriptionRequired:!0},GTM:{stateInscriptionRequired:!1,showCorporateExempt:!1,showCorporateStateInscription:!1,companyClientAttributes:["isCorporate","corporateName","tradeName","corporateDocument"]},MEX:{documentRequired:!1,documentRequiredForCorporate:!0,stateInscriptionRequired:!1,showCorporateTradeName:!1,showCorporateStateInscription:!1,showCorporateExempt:!1,showDocumentInCorporate:!0,tradeNameRequired:!1,companyClientAttributes:["isCorporate","corporateName","tradeName","corporateDocument","stateInscription","document","documentType"],personClientAttributes:["firstEmail","email","firstName","lastName","phone"]},PER:{showCorporateTradingName:!1,showCorporateStateInscription:!1,showCorporateExempt:!1,tradeNameRequired:!1,stateInscriptionRequired:!1},PRY:{customPhoneTemplate:!0,twoSeparateFieldsForPhone:!0},USA:{documentRequired:!1,documentRequiredForCorporate:!1,stateInscriptionRequired:!1,showCorporateStateInscription:!1,showCorporateExempt:!1,showCorporateDocument:!1,companyClientAttributes:["isCorporate","corporateName","tradeName"]},URY:{stateInscriptionRequired:!1,showCorporateExempt:!1,showCorporateStateInscription:!1,companyClientAttributes:["isCorporate","corporateName","tradeName","corporateDocument"]}},this.email=ko.observable(),this.emailSuggestionDomain=ko.observable(),this.emailSuggestionAddress=ko.observable(),this.oldEmail=ko.observable(),this.loadingEmail=ko.observable(!1),this.showPhoneSuggestion=ko.observable(!1),this.phoneSuggestionCodeArea=ko.observable(),this.phoneSuggestionDigits=ko.observable(),this.autoFilled=ko.observable(!1),this.documentKey=ko.computed(function(){return"clientProfileData.document-"+checkout.countryCode()}),this.coDocumentKey=ko.computed(function(){return"clientProfileData.coDocument-"+checkout.countryCode()}),this.hasDocumentKey=ko.computed(function(){return"clientProfileData.hasDocument-"+checkout.countryCode()}),this.noDocumentKey=ko.computed(function(){return"clientProfileData.noDocument-"+checkout.countryCode()}),this.hasPhoneKey=ko.computed(function(){return"clientProfileData.hasPhone-"+checkout.countryCode()}),this.noPhoneKey=ko.computed(function(){return"clientProfileData.noPhone-"+checkout.countryCode()}),this.noStateInscriptionKey=ko.computed(function(){return"clientProfileData.noStateInscription-"+checkout.countryCode()}),this.phonePlaceholder=ko.computed(function(){return vtex.validation.placeholders.phone[checkout.countryCode()]}),this.documentPlaceholder=ko.computed(function(){return vtex.validation.placeholders.document[checkout.countryCode()]}),this.companyDocumentPlaceholder=ko.computed(function(){return vtex.validation.placeholders.companyDocument[checkout.countryCode()]}),this.documentInputType=ko.computed(function(){var documentPlaceholder;return documentPlaceholder=vtex.validation.placeholders.document[checkout.countryCode()],!documentPlaceholder||documentPlaceholder.match(/[a-z]/i)?"text":"tel"}),this.documentAttributeBindings={placeholder:this.documentPlaceholder,type:this.documentInputType},8===window.dammitIE&&(this.documentAttributeBindings={placeholder:this.documentPlaceholder}),this.phonePart1=ko.observable(""),this.phonePart2=ko.observable(""),this.phonePart3=ko.observable(""),this.phoneCountryCode=ko.computed(function(){return vtex.phone.getCountryCodeByNameAbbr(checkout.countryCode())}),this.phoneTemplate=ko.computed(function(){var cc;return cc=checkout.countryCode(),_this.getRule(cc,"customPhoneTemplate")?"orderForm-phone-"+cc+"-template":"orderForm-phone-default-template"}),this.phoneIsMobile=ko.observable(!1),this.phoneIsMobile.subscribe(function(newValue){return"ARG"===checkout.countryCode()?newValue?_this.phonePart2("15"):_this.phonePart2(""):void 0}),this.isNotCorporate=ko.computed(function(){return!_this.isCorporate()}),this.isUsingExistingAccount=ko.computed(function(){return checkout.loggedIn()||!checkout.loggedIn()&&!checkout.canEditData()}),this.anonymousURL=ko.computed(function(){var listenToChanges;return listenToChanges=checkout.loggedIn()||checkout.canEditData(),API.getChangeToAnonymousUserURL()}),this.isDocumentRequired=ko.computed(function(){var country,documentRequired,documentRequiredForCorporate,isCorporate;return country=checkout.countryCode(),isCorporate=_this.isCorporate(),documentRequired=_this.getRule(country,"documentRequired"),documentRequiredForCorporate=_this.getRule(country,"documentRequiredForCorporate"),isCorporate&&documentRequiredForCorporate||!isCorporate&&documentRequired?!0:(setTimeout(function(){var _base;return"function"==typeof(_base=_this.document).validate?_base.validate({silent:!0}):void 0},500),!1)}),this.phone=ko.computed({write:function(value){var cc,hasDifferentPhone,isMobile,part1,part3,serverPhone,twoSeparateFieldsForPhone;return cc=checkout.countryCode(),hasDifferentPhone=_this.hasDifferentPhone(),twoSeparateFieldsForPhone=_this.getRule(cc,"twoSeparateFieldsForPhone"),null!=(null!=value?value.number:void 0)?hasDifferentPhone||!twoSeparateFieldsForPhone?hasDifferentPhone?_this.phonePart1(vtex.phone.format(value,vtex.phone.INTERNATIONAL)):_this.phonePart1(vtex.phone.format(value,vtex.phone.NATIONAL)):(_this.phonePart1(value.nationalDestinationCode),_this.phoneIsMobile(value.isMobile),_this.phonePart3(value.number)):twoSeparateFieldsForPhone&&!hasDifferentPhone?"ARG"===cc?(serverPhone=null!=value?value:"",part1=serverPhone.slice(1,5),part1=vtex.phone.normalize(part1),isMobile="15"===serverPhone.slice(5,7),part3=isMobile?serverPhone.slice(7):serverPhone.slice(5),_this.phonePart1(part1),_this.phoneIsMobile(isMobile),_this.phonePart3(part3)):(_this.phonePart1(""),_this.phonePart3(value)):(null!==value&&_this.phonePart1(value),""===value?_this.showPhoneSuggestion(!1):void 0)},read:function(){var country,phoneNumber,suffix;return country=checkout.countryCode(),suffix="ARG"!==country||_this.hasDifferentPhone()?"":"0",phoneNumber=_this.phonePart1()+_this.phonePart2()+_this.phonePart3(),suffix+phoneNumber}}),this.cleanPhone=ko.computed(function(){var phone,phoneNumber,_ref;return phoneNumber=null!=(_ref=_this.phone())?_ref.replace(/\_/g,""):void 0,_this.hasDifferentPhone()&&(phone=vtex.phone.getPhoneInternational(phoneNumber))?vtex.phone.format(phone,vtex.phone.INTERNATIONAL):(phone=vtex.phone.getPhoneNational(phoneNumber,_this.phoneCountryCode()))?vtex.phone.format(phone,vtex.phone.NATIONAL):phoneNumber}),this.phoneFocus=ko.observable(),this.documentFocus=ko.observable(),this.validateCNPJ=vtex.validation.validateCNPJ,this.maskedFirstName=ko.computed({read:function(){return maskInfo(_this.firstName())}}),this.maskedLastName=ko.computed({read:function(){return maskInfo(_this.lastName())}}),this.maskedPhone=ko.computed({read:function(){return maskInfo(_this.phone())}}),this.toggleExempt=ko.computed(function(){var exempt;return exempt=_this.exempt(),exempt?_this.stateInscription(i18n.t("global.exempt")):_this.stateInscription("")}),this.phonePart1.subscribe(function(newPhone){var hasMaskCharacterInsLastPosition,phoneDigits;if("BRA"!==!checkout.countryCode()&&!_this.hasDifferentPhone())return phoneDigits=null!=newPhone?newPhone.replace(/\D/g,""):void 0,hasMaskCharacterInsLastPosition=10===(null!=phoneDigits?phoneDigits.length:void 0)&&newPhone.indexOf("_")===newPhone.length-1,hasMaskCharacterInsLastPosition?_this.phonePart1(null!=newPhone?newPhone.replace("_",""):void 0):void 0}),this.showCorporateTradingName=ko.computed(function(){return _this.getRule(checkout.countryCode(),"showCorporateTradeName")}),this.showCorporateStateInscription=ko.computed(function(){return _this.getRule(checkout.countryCode(),"showCorporateStateInscription")}),this.showCorporateExempt=ko.computed(function(){return _this.getRule(checkout.countryCode(),"showCorporateExempt")}),this.showDocumentInCorporate=ko.computed(function(){return _this.getRule(checkout.countryCode(),"showDocumentInCorporate")}),this.showCorporateDocument=ko.computed(function(){return _this.getRule(checkout.countryCode(),"showCorporateDocument")}),this.companyClientAttributes=ko.computed(function(){return _this.getRule(checkout.countryCode(),"companyClientAttributes")}),this.personClientAttributes=ko.computed(function(){return _this.getRule(checkout.countryCode(),"personClientAttributes")}),this.requirementTradingName=ko.computed(function(){return _this.getRule(checkout.countryCode(),"tradeNameRequired")}),this.stateInscriptionLabel=ko.computed(function(){var translation;return translation=i18n.t("clientProfileData.coRegisterNumber-"+checkout.countryCode()),-1===translation.indexOf("coRegisterNumber")?translation:i18n.t("clientProfileData.coRegisterNumber")}),this.requirementStateInscription=ko.computed(function(){var required;return required=_this.getRule(checkout.countryCode(),"stateInscriptionRequired"),required?_this.showCorporateExempt()&&_this.exempt()===!0?!1:!0:!1}),$(window).on("orderFormUpdated.vtex",function(e,orderForm){return debug("Parsing client profile data from event"),_this.parseOrderFormResponse(orderForm)})}var maskInfo;return maskInfo=function(info){var maskRegex,maskText;return maskRegex=/\*/g,maskText='<span class="masked-info">*</span>',info?info.replace(maskRegex,maskText):info},ClientProfileDataViewModel.prototype.getRule=function(countryCode,rule){return this.countryRules[countryCode]&&null!=this.countryRules[countryCode][rule]?this.countryRules[countryCode][rule]:this.countryRules.BRA[rule]},ClientProfileDataViewModel.prototype.handleUserProfileNotFound=function(){var _this=this;return this.loadingEmail(!1),this.showEmailForm(!1),window.hasher.replaceHash("profile"),Kicksend.mailcheck.run({email:this.email(),suggested:function(suggestion){return _this.emailSuggestionAddress(suggestion.address+"@"),_this.emailSuggestionDomain(suggestion.domain)},empty:function(){return _this.emailSuggestionAddress(void 0),_this.emailSuggestionDomain(void 0)}})},ClientProfileDataViewModel.prototype.acceptSuggestion=function(){return this.email(this.emailSuggestionAddress()+this.emailSuggestionDomain()),this.emailSuggestionDomain(void 0),this.emailSuggestionAddress(void 0),this.blurEmail()},ClientProfileDataViewModel.prototype.suggestPhone=function(validation,phone){var phoneFormatted,phoneObj,suggestedAreaCode;return"COL"===checkout.countryCode()&&null===phone.match(/\(\d{1}\)/)&&(phone=phone.replace(/\D/g,""),7===phone.length&&validation.result===!1&&"3"!==phone[0]?(suggestedAreaCode="(1) ",phoneObj=vtex.phone.getPhoneNational(suggestedAreaCode+phone,this.phoneCountryCode()),phoneFormatted=vtex.phone.format(phoneObj,vtex.phone.LOCAL),this.phoneSuggestionDigits(phoneFormatted),this.phoneSuggestionCodeArea(suggestedAreaCode),this.showPhoneSuggestion(!0),validation.message=""):this.showPhoneSuggestion()&&(this.phoneSuggestionDigits(null),this.phoneSuggestionCodeArea(null),this.showPhoneSuggestion(!1))),validation},ClientProfileDataViewModel.prototype.acceptPhoneSuggestion=function(){return this.phone(this.phoneSuggestionCodeArea()+this.phoneSuggestionDigits()),this.phone.validate(),this.showPhoneSuggestion(!1),this.phoneSuggestionDigits(void 0),this.phoneSuggestionCodeArea(void 0)},ClientProfileDataViewModel.prototype.serializableProperties=function(){return this.personClientAttributes().concat(this.companyClientAttributes())},ClientProfileDataViewModel.prototype.update=function(data){var phone;return data.phone&&checkout.canEditData()&&(phone=0===data.phone.indexOf("+")?vtex.phone.getPhoneInternational(data.phone):vtex.phone.getPhoneNational(data.phone,this.phoneCountryCode()),phone&&(data.phone=phone),phone&&phone.countryCode===this.phoneCountryCode()||(this.hasDifferentPhone(!0),this.differentPhoneFlag||(this.differentPhoneFlag=!0))),null!==data.documentType&&data.documentType?data.documentType!==vtex.validation.countryToKey[checkout.countryCode()].document&&this.hasDifferentDocument(!0):data.documentType=vtex.validation.countryToKey[checkout.countryCode()].document,ko.utils.extendObservable(this,data),this.commit(),this},ClientProfileDataViewModel.prototype.toggleDifferentDocument=function(){var hasDifferentDocument;return hasDifferentDocument=this.hasDifferentDocument(),hasDifferentDocument?(this.alternateDocument(this.document()),this.alternateDocumentType(this.documentType()),this.document(this.oldDocument()),this.documentType(this.oldDocumentType())):(this.oldDocument(this.document()),this.oldDocumentType(this.documentType()),this.document(this.alternateDocument()),this.documentType(this.alternateDocumentType())),this.hasDifferentDocument(!hasDifferentDocument)},ClientProfileDataViewModel.prototype.toggleDifferentPhone=function(){var hasDifferentPhone;return hasDifferentPhone=this.hasDifferentPhone(),hasDifferentPhone?(this.phonePart1(""),this.phonePart2(""),this.phonePart3("")):(this.phonePart1(this.phone()),this.phonePart2(""),this.phonePart3("")),this.hasDifferentPhone(!hasDifferentPhone)},ClientProfileDataViewModel.prototype.toggleCorporate=function(){return this.isCorporate(!this.isCorporate())},ClientProfileDataViewModel.prototype.submitFirstEmail=function(){return this.firstEmail.validate({giveFocus:!0}),this.email(this.firstEmail()),this.oldEmail()!==this.email()&&""!==this.email()&&this.email.validate().result!==!1?(this.oldEmail(this.email()),this.loadingEmail(!0),this.emailSubmitHandler(this.toJSON()),this.enable()):void 0},ClientProfileDataViewModel.prototype.blurEmail=function(){return this.oldEmail()!==this.email()&&""!==this.email()&&this.email.validate().result!==!1?(this.oldEmail(this.email()),this.loadingEmail(!0),this.emailSubmitHandler(this.toJSON())):void 0},ClientProfileDataViewModel.prototype.validate=function(options){var fields,prop,validationResults,_i,_j,_len,_len1,_ref,_ref1;if(window.checkout.loggedIn()||window.checkout.canEditData()){for(fields=[],_ref=this.personClientAttributes(),_i=0,_len=_ref.length;_len>_i;_i++)prop=_ref[_i],fields.push(this[prop]);if(this.isCorporate())for(_ref1=this.companyClientAttributes(),_j=0,_len1=_ref1.length;_len1>_j;_j++)prop=_ref1[_j],fields.push(this[prop]);validationResults=vtex.ko.validation.validateObservables(fields,options),checkout.canEditData()===!0&&checkout.loggedIn()===!1&&this.loadingEmail()===!0&&validationResults.push({result:!1})}else validationResults=[{result:!0}];return $("#client-profile-data").trigger("componentValidated.vtex",[validationResults]),validationResults},ClientProfileDataViewModel.prototype.isValid=function(options){var isValid,validationResults;return validationResults=this.validate(options||{giveFocus:!1}),isValid=validationResults.length>0&&_(validationResults).all(function(val){return val.result===!0})},ClientProfileDataViewModel.prototype.postUpdate=function(data){return data.email?(this.firstEmail(data.email),this.oldEmail(data.email),void 0!==this.email&&this.showEmailForm(!1),this.loadingEmail(!1),this.stateInscription()===i18n.t("global.exempt")&&this.exempt(!0),vtex.checkout.Module.commit.apply(this)):void 0},ClientProfileDataViewModel.prototype.next=function(){return this.active()&&this.isValid({giveFocus:!0,showErrorMessage:!0,applyErrorClass:!0})&&this.done(),!1},ClientProfileDataViewModel.prototype.disable=function(){return this.isDirty()&&this.active()&&this.isValid()&&this.submit(),this.active(!1)},ClientProfileDataViewModel.prototype.getPhoneValidationResult=function(result,options){var validation;return null==options&&(options={}),validation={applyErrorClass:!result,showErrorMessage:!result,applySuccessClass:result,result:result},result||(validation.message=vtex.ko.validation.getValidationMessage("tel",checkout.locale())),_.extend(validation,options),validation},ClientProfileDataViewModel.prototype.validatePhone=function(value,element,options){var phoneResult,validationResult;return this.hasDifferentPhone()?{result:!0,applySuccessClass:!1,showErrorMessage:!1,applyErrorClass:!1}:"ARG"===checkout.countryCode()?this.validateARGPhone(value,element,options):(phoneResult=vtex.phone.validate(this.phone(),this.phoneCountryCode()),validationResult=this.getPhoneValidationResult(phoneResult,options),validationResult=this.suggestPhone(validationResult,value))},ClientProfileDataViewModel.prototype.validatePhoneNDC=function(value,element,options){var countryObj,ndc,result,_i,_len,_ref,_ref1;if(this.hasDifferentPhone())return{result:!0,applySuccessClass:!1,showErrorMessage:!1,applyErrorClass:!1};for(value=value.replace(/\D/g,""),countryObj=vtex.phone.countries[this.phoneCountryCode()],result=!1,_ref=countryObj.nationalDestinationCode,_i=0,_len=_ref.length;_len>_i&&(ndc=_ref[_i],_ref1=vtex.phone.testNDC(ndc,countryObj,value),result=_ref1[0],ndc=_ref1[1],!result);_i++);return this.getPhoneValidationResult(result,options)},ClientProfileDataViewModel.prototype.validateARGPhoneNDC=function(value,element,options){var phoneResult;return this.hasDifferentPhone()?{result:!0,applySuccessClass:!1,showErrorMessage:!1,applyErrorClass:!1}:(phoneResult="9"!==value&&__indexOf.call(vtex.phone.countries[54].nationalDestinationCode,value)>=0,this.getPhoneValidationResult(phoneResult,options))},ClientProfileDataViewModel.prototype.validateARGPhone=function(value,element,options){var phoneResult;return this.hasDifferentPhone()?{result:!0,applySuccessClass:!1,showErrorMessage:!1,applyErrorClass:!1}:(phoneResult=vtex.phone.validate(this.phone(),"54"),this.getPhoneValidationResult(phoneResult,options))},ClientProfileDataViewModel.prototype.validateDocument=function(value,element){return value||this.isDocumentRequired()?this.hasDifferentDocument()?void 0:vtex.validation.validateDocument(value,element):{result:!0,applySuccessClass:!1,showErrorMessage:!1,applyErrorClass:!1}},ClientProfileDataViewModel.prototype.validateCorporateDocument=function(value,element,options){var corporateDocumentKey,result,validation;return"BRA"===checkout.countryCode()?vtex.validation.validateCNPJ(value,element,options):"PER"===checkout.countryCode()?vtex.validation.validateRUCPER(value,element,options):(corporateDocumentKey=vtex.validation.countryToKey[checkout.countryCode()].corporateDocument,result=vtex.validation.regex[corporateDocumentKey].test(value),validation={},validation.applyErrorClass=validation.showErrorMessage=!result,validation.applySuccessClass=result,validation.result=result,validation)},ClientProfileDataViewModel.prototype.toJSON=function(){var attr,json,key,phone,_i,_len,_ref;for(json={},_ref=this.serializableProperties(),_i=0,_len=_ref.length;_len>_i;_i++)key=_ref[_i],"phone"===key?(attr=ko.toJS(this[key]),this.hasDifferentPhone()?phone=vtex.phone.getPhoneInternational(attr):(phone=vtex.phone.getPhoneNational(attr,this.phoneCountryCode()),phone||(phone=vtex.phone.getPhoneInternational(attr))),attr=phone?vtex.phone.format(phone,vtex.phone.INTERNATIONAL):ko.toJS(this[key])):(attr=ko.toJS(this[key]),"string"==typeof attr&&(attr=attr.trim())),json[key]=attr;return this.isCorporate()&&(json.corporatePhone=json.phone),json},ClientProfileDataViewModel.prototype.done=function(){return $("#client-profile-data").trigger("componentDone.vtex")},ClientProfileDataViewModel.prototype.emailSubmitHandler=function(clientProfileData){var attachment,attachmentId,xhr,_this=this;return attachmentId="clientProfileData",attachment=_(clientProfileData).pick("email"),xhr=API.getProfileByEmail(clientProfileData.email,window.checkout.salesChannel()),xhr.done(function(data){var sendAttachmentXHR;return!data.userProfileId||void 0!==data.hasAddress&&data.hasAddress!==!0?_this.handleUserProfileNotFound():(vtex.checkout.MessageUtils.showEmailMessage(),_this.loading(!0),"function"==typeof vtexid.setEmail&&vtexid.setEmail(clientProfileData.email),sendAttachmentXHR=API.sendAttachment(attachmentId,attachment),sendAttachmentXHR.done(function(data){return $("#shipping-data").one("componentValidated.vtex",function(){return _this.done()})}),sendAttachmentXHR.fail(function(){return _this.handleUserProfileNotFound(),_this.loading(!1),_this.enable()}))}),xhr.fail(this.handleUserProfileNotFound)},ClientProfileDataViewModel.prototype.submit=function(){var attachment,attachmentId,xhr,_this=this;return this.loading(!0),attachmentId="clientProfileData",attachment=this.toJSON(),xhr=API.sendAttachment(attachmentId,attachment),xhr.fail(function(){return router.setHash("profile"),_this.loading(!1)})},ClientProfileDataViewModel.prototype.afterRender=function(){return vtex.i18n.translateHtml("#client-profile-data")},ClientProfileDataViewModel.prototype.parseOrderFormResponse=function(orderForm){var clientProfileData,_ref;return clientProfileData=null!=(_ref=orderForm.clientProfileData)?_ref:{},"BRA"===window.checkout.countryCode()&&clientProfileData.document&&(clientProfileData.document=_.maskString(clientProfileData.document,vtex.validation.masks.cpf)),this.loading(!1),this.update(clientProfileData),this.postUpdate(clientProfileData),this.validate({dontChangeDOM:!0})},ClientProfileDataViewModel}(),vtex.checkout.ClientProfileDataViewModel=ClientProfileDataViewModel}.call(this),vtex.localeUtils.BRA={states:["AC","AL","AM","AP","BA","CE","DF","ES","GO","MA","MT","MS","MG","PA","PB","PR","PE","PI","RJ","RN","RO","RS","RR","SC","SE","SP","TO"]},vtex.localeUtils.USA={states:["Alabama","Alaska","Arizona","Arkansas","California","Colorado","Connecticut","Delaware","Florida","Georgia","Hawaii","Idaho","Illinois","Indiana","Iowa","Kansas","Kentucky","Louisiana","Maine","Maryland","Massachusetts","Michigan","Minnesota","Mississippi","Missouri","Montana","Nebraska","Nevada","New Hampshire","New Jersey","New Mexico","New York","North Carolina","North Dakota","Ohio","Oklahoma","Oregon","Pennsylvania","Rhode Island","South Carolina","South Dakota","Tennessee","Texas","Utah","Vermont","Virginia","Washington","West Virginia","Wisconsin","Wyoming"]},function(){var SlasForSellerViewModel,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};SlasForSellerViewModel=function(){function SlasForSellerViewModel(logisticsInfoArray){var _ref,_this=this;this.logisticsInfoArray=logisticsInfoArray,this.findScheduledSla=__bind(this.findScheduledSla,this),this.buildSlas=__bind(this.buildSlas,this),this.sellerId=ko.observable(this.logisticsInfoArray[0].item.seller.id()),this.sellerName=ko.observable(this.logisticsInfoArray[0].item.seller.name()),this.slas=ko.observableArray(this.buildSlas()),this.scheduledSla=this.findScheduledSla(),null!=(_ref=this.scheduledSla)&&_ref.deliveryWindowIndex.subscribe(function(newValue){var logisticsInfo,scheduledSla,_i,_len,_ref1;for(_ref1=_this.logisticsInfoArray.slice(1),_i=0,_len=_ref1.length;_len>_i;_i++)logisticsInfo=_ref1[_i],scheduledSla=_.find(logisticsInfo.slas(),function(s){var _ref2;return s.name===(null!=(_ref2=_this.scheduledSla)?_ref2.name:void 0)}),null!=scheduledSla&&scheduledSla.deliveryWindowIndex(newValue);return _this.logisticsInfoArray[0].selectedSla.notifySubscribers(),$(".totalizers-list").trigger("deliverySelected.vtex",[_.map(_this.logisticsInfoArray,function(li){return li.toJSON()})])}),this.selectedSlaName=ko.computed({read:function(){return _this.logisticsInfoArray[0].selectedSlaVM()?_this.logisticsInfoArray[0].selectedSlaVM().name:void 0},write:function(name){var isNewScheduledSla,logisticsInfo,_i,_len,_ref1,_ref2,_ref3;for(isNewScheduledSla=(null!=(_ref1=_this.scheduledSla)?_ref1.name:void 0)===name&&null===(null!=(_ref2=_this.scheduledSla)?_ref2.deliveryWindowIndex():void 0),_ref3=_this.logisticsInfoArray,_i=0,_len=_ref3.length;_len>_i;_i++)logisticsInfo=_ref3[_i],logisticsInfo.setSelectedSla(name);return $(".totalizers-list").trigger("deliverySelected.vtex",[_.map(_this.logisticsInfoArray,function(li){return li.toJSON()})])}}),this.selectedSlaEstimate=ko.computed(function(){return _this.logisticsInfoArray[0].selectedSlaVM()?_this.logisticsInfoArray[0].selectedSlaVM().maxEstimateLabel?_this.logisticsInfoArray[0].selectedSlaVM().maxEstimateLabel:_this.logisticsInfoArray[0].selectedSlaVM().exactEstimateLabel:void 0}),this.selectedSlaPrice=ko.computed(function(){return _this.logisticsInfoArray[0].selectedSlaVM()?_this.logisticsInfoArray[0].selectedSlaVM().valueLabel:void 0}),this.isSelectedSlaScheduled=ko.computed(function(){return _this.logisticsInfoArray[0].selectedSlaVM()?_this.logisticsInfoArray[0].selectedSlaVM().isScheduled:void 0})}return SlasForSellerViewModel.prototype.buildSlas=function(){var i,logisticsInfo,maxShippingEstimateForSlaName,sla,slas,summedPriceForSlaName,summedTaxesForSlaName,_i,_j,_k,_l,_len,_len1,_len2,_len3,_ref,_ref1,_ref2,_ref3,_this=this;for(summedPriceForSlaName={},summedTaxesForSlaName={},_ref=this.logisticsInfoArray,i=_i=0,_len=_ref.length;_len>_i;i=++_i)for(logisticsInfo=_ref[i],_ref1=logisticsInfo.slas(),_j=0,_len1=_ref1.length;_len1>_j;_j++)sla=_ref1[_j],void 0===summedPriceForSlaName[sla.name]&&(summedPriceForSlaName[sla.name]=0),void 0===summedTaxesForSlaName[sla.name]&&(summedTaxesForSlaName[sla.name]=0),summedPriceForSlaName[sla.name]+=sla.price,summedTaxesForSlaName[sla.name]+=sla.tax;for(maxShippingEstimateForSlaName={},_ref2=this.logisticsInfoArray,i=_k=0,_len2=_ref2.length;_len2>_k;i=++_k)for(logisticsInfo=_ref2[i],_ref3=logisticsInfo.slas(),_l=0,_len3=_ref3.length;_len3>_l;_l++)sla=_ref3[_l],void 0===maxShippingEstimateForSlaName[sla.name]&&(maxShippingEstimateForSlaName[sla.name]=0),sla.shippingEstimate>maxShippingEstimateForSlaName[sla.name]&&(maxShippingEstimateForSlaName[sla.name]=sla.shippingEstimate);return slas=this.logisticsInfoArray[0].slas(),_(slas).each(function(sla){var _ref4;return sla.summedPrice=summedPriceForSlaName[sla.name],sla.summedTaxes=summedTaxesForSlaName[sla.name],sla.maxShippingEstimate=maxShippingEstimateForSlaName[sla.name],sla.updateLabelsAndPriceProperties(),sla.nameAttr=_.plainChars("seller-"+_this.sellerId()),sla.idAttr=_.plainChars(sla.nameAttr+"-sla-"+(null!=(_ref4=sla.id)?_ref4.replace(/\ /g,""):void 0)),sla.hasFocus=ko.observable()}),slas},SlasForSellerViewModel.prototype.findScheduledSla=function(){return _(this.slas()).find(function(sla){return sla.isScheduled})},SlasForSellerViewModel.slasGroupedBySeller=function(logisticsInfo){var logisticsInfoMap,slasForSellerViewModelArray;return logisticsInfo?(logisticsInfoMap=_(logisticsInfo).groupBy(function(li){return li.seller.id()}),slasForSellerViewModelArray=[],_(logisticsInfoMap).each(function(logisticsInfoArray,sellerId){var logisticsInfoWithSlas;return logisticsInfoWithSlas=_.filter(logisticsInfoArray,function(li){var _ref;return(null!=(_ref=li.slas())?_ref.length:void 0)>0}),logisticsInfoWithSlas.length>0?slasForSellerViewModelArray.push(new vtex.checkout.SlasForSellerViewModel(logisticsInfoWithSlas)):void 0}),slasForSellerViewModelArray):[]},SlasForSellerViewModel}(),vtex.checkout.SlasForSellerViewModel=SlasForSellerViewModel}.call(this),function(){var ShippingAddressViewModel,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;l>i;i++)if(i in this&&this[i]===item)return i;return-1};ShippingAddressViewModel=function(){function ShippingAddressViewModel(){this.getRequiredAttributes=__bind(this.getRequiredAttributes,this),this.isComplete=__bind(this.isComplete,this),this.isValid=__bind(this.isValid,this),this.validate=__bind(this.validate,this),this.handleDeliverySelected=__bind(this.handleDeliverySelected,this),this.updateSlasForSeller=__bind(this.updateSlasForSeller,this),this.update=__bind(this.update,this),this.toJSON=__bind(this.toJSON,this),this.forceShippingFields=__bind(this.forceShippingFields,this),this.submit=__bind(this.submit,this),this.postalCodeChanged=__bind(this.postalCodeChanged,this),this.pad=__bind(this.pad,this),this.select=__bind(this.select,this);var instanceId,_this=this;instanceId=(-1*(new Date).getTime()).toString(),this.moduleId="shippingData.shippingAddress",_.defaults(vtex.checkout.ShippingAddressViewModel.prototype,vtex.checkout.Module),this.applyModuleSubscriptions(),this.postalCodeChangedSubscription={},this.addressUpdatedFromServer=!1,this.addressType=ko.observable("residential"),this.postalCode=ko.observable(null),this.postalCodeFound=ko.observable(!1),this.street=ko.observable(null),this.number=ko.observable(null),this.complement=ko.observable(null),this.neighborhood=ko.observable(null),this.neighborhoodOptions=ko.observableArray(null),this.reference=ko.observable(null),this.city=ko.observable(null),this.state=ko.observable(""),this.receiverName=ko.observable(null),this.addressId=ko.observable(instanceId),this.disableCity=ko.observable(!1),this.disableState=ko.observable(!1),this.labelShippingFields=ko.observable(!1),this.logisticsInfo=ko.observableArray(),this.slasForSellerViewModelArray=ko.observableArray(),this.loading=ko.observable(!1),this.throttledLoading=ko.computed(function(){return _this.loading()}).extend({throttle:500}),this.maskedStreet=ko.computed(function(){return _.maskInfo(_this.street())}),this.maskedNumber=ko.computed(function(){return _.maskInfo(_this.number())}),this.maskedComplement=ko.computed(function(){return _.maskInfo(_this.complement())}),this.maskedNeighborhood=ko.computed(function(){return _.maskInfo(_this.neighborhood())}),this.maskedCity=ko.computed(function(){return _.maskInfo(_this.city())}),this.maskedState=ko.computed(function(){return _.maskInfo(_this.state())}),this.maskedReference=ko.computed(function(){return _.maskInfo(_this.reference())}),this.maskedPostalCode=ko.computed(function(){return _.maskInfo(_this.postalCode())}),this.sellers=ko.computed(function(){return _.uniq(_.map(window.cart.items(),function(i){return i.sellerId()}))}),this.multipleSellers=ko.computed(function(){var _ref;return(null!=(_ref=_this.sellers())?_ref.length:void 0)>1}),this.addressTypeCommercial=ko.computed({read:function(){return"commercial"===_this.addressType()},write:function(value){return _this.addressType(value===!0?"commercial":"residential")}}),this.availableDeliveryCountries=ko.computed(function(){return checkout.deliveryCountries()}),this.defaultDeliveryCountry=ko.computed(function(){var code,deliveryCountry;return code=checkout.countryCode(),deliveryCountry=_(_this.availableDeliveryCountries()).find(function(c){return c===code}),deliveryCountry?deliveryCountry:_this.availableDeliveryCountries()[0]}),this.availableDeliveryCountries.subscribe(function(){return _this.deliveryCountry(_this.defaultDeliveryCountry())}),this.deliveryCountry=ko.observable(this.defaultDeliveryCountry()),this.nameForCountry=function(country){return i18n.t("global."+country)},this.deliveryCountryName=ko.computed(function(){return _this.nameForCountry(_this.deliveryCountry())}),this.addressTemplate=ko.computed(function(){return"orderForm-shipping-address-"+_this.deliveryCountry()+"-template"}),this.deliveryCountry.subscribe(function(deliveryCountry){return _this.postalCode(""),_this.postalCodeFound(!1)}),this.isNotUsingPostalCode=ko.computed(function(){var _ref;return _ref=_this.deliveryCountry(),__indexOf.call(checkout.countriesWithNoPostalCode,_ref)>=0}),this.isPostalCodeAccordingToCity=ko.computed(function(){var _ref;return _ref=_this.deliveryCountry(),__indexOf.call(checkout.countriesWithPostalCodeAccordingToCity,_ref)>=0}),this.country=ko.computed(function(){return _this.deliveryCountry()}),this.postalCodeRegex=ko.computed(function(){var countryToKey;return countryToKey=vtex.validation.countryToKey[_this.deliveryCountry()],null==countryToKey&&(countryToKey=vtex.validation.countryToKey[_this.defaultDeliveryCountry()],
_this.deliveryCountry(_this.defaultDeliveryCountry())),vtex.validation.regex[countryToKey.postalCode]}),this.postalCodeMask=ko.computed(function(){var countryToKey;return countryToKey=vtex.validation.countryToKey[_this.deliveryCountry()],null==countryToKey&&(countryToKey=vtex.validation.countryToKey[_this.defaultDeliveryCountry()],_this.deliveryCountry(_this.defaultDeliveryCountry())),vtex.validation.masks[countryToKey.postalCode]}),this.firstPart=ko.computed(function(){var value;return value="",value+=_.maskInfo(_this.street()),_this.number()&&"USA"!==_this.deliveryCountry()&&(value+=", "+_.maskInfo(_this.number())),_this.complement()&&(value+=", "+_.maskInfo(_this.complement())),_this.reference()&&(value+=", "+_.maskInfo(_this.reference())),value}),this.secondPart=ko.computed(function(){var value;return value="",_this.city()&&(value+=_.maskInfo(_this.city())+" - "),_this.state()&&(value+=_.maskInfo(_this.state())+" - "),value+=i18n.t("global."+_this.country())}),this.summary=ko.computed(function(){var value;return value="",value+=_.maskInfo(_this.street()),_this.postalCode()&&(value+=" - "+_.maskInfo(_this.postalCode())),value}),this.showSlasForSeller=ko.computed(function(){var array,postalCodeFound;return array=_this.slasForSellerViewModelArray(),postalCodeFound=_this.postalCodeFound(),(null!=array?array.length:void 0)>0&&postalCodeFound}),this.loadingSlasForSeller=ko.computed(function(){var array;return array=_this.slasForSellerViewModelArray(),_this.postalCodeFound()&&void 0===array}),this.clearAddressIfPostalCodeNotFound=ko.computed(function(){return!_this.isNotUsingPostalCode()}),this.showPostalCode=ko.computed(function(){return"BRA"===_this.deliveryCountry()||"MEX"===_this.deliveryCountry()?_this.postalCodeFound()===!0&&_this.postalCodeRegex().test(_this.postalCode()):!0}),this.postalCodeChangedSubscription=this.postalCode.subscribe(this.postalCodeChanged),this.changePostalCodeBasedOnState=ko.computed(function(){var city,currentPostalCode;if(!_this.isPostalCodeAccordingToCity()&&_this.isNotUsingPostalCode()&&checkout.canEditData()&&_this.state()&&vtex.localeUtils[_this.deliveryCountry()]){currentPostalCode=null;for(city in vtex.localeUtils[_this.deliveryCountry()].map[_this.state()]){currentPostalCode=vtex.localeUtils[_this.deliveryCountry()].map[_this.state()][city];break}if(currentPostalCode)return _this.addressUpdatedFromServer=!1,_this.postalCode(currentPostalCode)}}).extend({throttle:1e3}),this.changePostalCodeBasedOnCity=_.throttle(function(){var currentPostalCode;if(_this.isPostalCodeAccordingToCity()&&_this.isNotUsingPostalCode()&&checkout.canEditData()&&_this.state()&&(currentPostalCode=null,"CHL"===_this.deliveryCountry()&&_this.neighborhood()?currentPostalCode=vtex.localeUtils[_this.deliveryCountry()].map[_this.state()][_this.neighborhood()]:_this.city()&&(currentPostalCode=vtex.localeUtils[_this.deliveryCountry()].map[_this.state()][_this.city()]),currentPostalCode))return _this.addressUpdatedFromServer=!1,_this.postalCode(currentPostalCode)},1e3),this.citiesBasedOnState=ko.computed(function(){var deliveryCountry;return deliveryCountry=_this.deliveryCountry(),"BRA"!==deliveryCountry&&"USA"!==deliveryCountry&&_this.state()&&vtex.localeUtils[deliveryCountry]?vtex.localeUtils[deliveryCountry].map?(vtex.localeUtils[deliveryCountry].cities[_this.state()]||(vtex.localeUtils[deliveryCountry].cities[_this.state()]=_.map(vtex.localeUtils[deliveryCountry].map[_this.state()],function(k,v){return v})),vtex.localeUtils[deliveryCountry].cities[_this.state()]):(_this.isNotUsingPostalCode()&&!_this.isPostalCodeAccordingToCity()&&_this.changePostalCodeBasedOnState(),vtex.localeUtils[deliveryCountry].cities[juridicCode]):void 0}),this.isGift=ko.computed(function(){return"giftRegistry"===_this.addressType()}),radio("vtex.i18n.update").subscribe(this.updateSlasForSeller),$(window).on("deliverySelected.vtex",this.handleDeliverySelected)}return ShippingAddressViewModel.prototype.select=function(){return shippingData.currentAddressId(this.addressId())},ShippingAddressViewModel.prototype.pad=function(num,size){var s;for(s=num+"";s.length<size;)s="0"+s;return s},ShippingAddressViewModel.prototype.postalCodeChanged=function(){return this.addressUpdatedFromServer||(null!=this.postalCode()&&this.postalCodeRegex().exec(this.postalCode())&&!this.isNotUsingPostalCode()||this.isNotUsingPostalCode()&&this.postalCode())&&(this.logisticsInfo(void 0),this.slasForSellerViewModelArray(void 0),this.submit()),this.postalCodeFound(!1),this.addressUpdatedFromServer=!1},ShippingAddressViewModel.prototype.submit=function(){return this.loading(!0),vtex.checkout.Module.submit.apply(this)},ShippingAddressViewModel.prototype.serializableProperties=function(){return["addressType","addressId","postalCode","street","number","complement","neighborhood","reference","city","state","receiverName","country","clearAddressIfPostalCodeNotFound"]},ShippingAddressViewModel.prototype.forceShippingFields=function(){return this.labelShippingFields(!1)},ShippingAddressViewModel.prototype.toJSON=function(){var attr,json,key,_i,_len,_ref;for(json={},_ref=this.serializableProperties(),_i=0,_len=_ref.length;_len>_i;_i++)key=_ref[_i],attr=ko.toJS(this[key]),json[key]=attr;return json.street=_.capitalizeSentence(json.street),json.neighborhood=_.capitalizeSentence(json.neighborhood),json.city=_.capitalizeSentence(json.city),json},ShippingAddressViewModel.prototype.update=function(address,logisticsInfo){var postalCodeChanged,postalCodeSanitized,state,_ref,_ref1,_ref2;return this.loading(!1),postalCodeChanged=!1,address.country&&this.deliveryCountry(address.country),(null!=(_ref=address.postalCode)?_ref.replace(/[^\w\s]/gi,""):void 0)!==(null!=(_ref1=this._cache.postalCode)?_ref1.replace(/[^\w\s]/gi,""):void 0)&&(this.isNotUsingPostalCode()||(postalCodeChanged=!0)),(postalCodeChanged||address.street&&address.street.length>0)&&this.street(_.capitalizeSentence(address.street)),(postalCodeChanged||address.neighborhood&&address.neighborhood.length>0)&&(address.neighborhood&&-1!==address.neighborhood.indexOf(";")?(this.neighborhoodOptions(_.filter(address.neighborhood.split(";"),function(neighborhood){return neighborhood.length>0})),this.neighborhood(address.neighborhood=null)):(this.neighborhoodOptions(null),this.neighborhood(address.neighborhood))),("Ciudad de Buenos Aires"===(_ref2=address.state)||"Provincia de Buenos Aires"===_ref2)&&(address.state="Ciudad Autnoma de Buenos Aires",address.city="Ciudad Autnoma Buenos Aires"),(postalCodeChanged||address.state&&address.state.length>0)&&(state=_.find(checkout.getStates(this.deliveryCountry()),function(s){return s.toUpperCase()===address.state.toUpperCase()}),state?this.state(state):this.state(address.state)),(postalCodeChanged||address.city&&address.city.length>0)&&this.city(_.capitalizeSentence(address.city)),(postalCodeChanged||address.number&&address.number.length>0)&&this.number(address.number),(postalCodeChanged||address.complement&&address.complement.length>0)&&this.complement(address.complement),address.addressType&&this.addressType(address.addressType),address.addressId&&this.addressId(address.addressId),address.receiverName&&this.receiverName(address.receiverName),address.reference&&this.reference(address.reference),address.postalCode&&(this.addressUpdatedFromServer=!0,postalCodeSanitized=9===address.postalCode.length&&"*"===address.postalCode[0]&&"BRA"===address.country?address.postalCode.slice(1):address.postalCode,this.postalCode(_.maskString(postalCodeSanitized,this.postalCodeMask())),this.postalCodeFound(!0)),this.disableCity(void 0!==address.city&&""!==address.city),this.disableState(void 0!==address.state&&""!==address.state),address.street&&address.neighborhood&&address.city&&address.state&&!this.isNotUsingPostalCode()?this.labelShippingFields(!0):this.labelShippingFields(!1),logisticsInfo?this.handleDeliverySelected(null,logisticsInfo):this.validate({giveFocus:!0,silent:!0}),this.commit(),this},ShippingAddressViewModel.prototype.updateSlasForSeller=function(){return _(this.logisticsInfo()).each(function(li){return _(li.slas()).each(function(sla){return sla.updateLabelsAndPriceProperties()})}),this.slasForSellerViewModelArray(vtex.checkout.SlasForSellerViewModel.slasGroupedBySeller(this.logisticsInfo())),vtex.i18n.translateHtml(".orderform-template-holder")},ShippingAddressViewModel.prototype.handleDeliverySelected=function(e,logisticsInfoArray){return logisticsInfoArray?(this.logisticsInfo(_(logisticsInfoArray).map(function(li){return new vtex.checkout.LogisticsInfoViewModel(li)})),this.updateSlasForSeller()):void 0},ShippingAddressViewModel.prototype.validate=function(options){var fields,prop,_i,_len,_ref;if(!checkout.canEditData())return[{result:this.isComplete()}];for(fields=[],_ref=this.serializableProperties(),_i=0,_len=_ref.length;_len>_i;_i++)prop=_ref[_i],fields.push(this[prop]);return vtex.ko.validation.validateObservables(fields,options)},ShippingAddressViewModel.prototype.isValid=function(options){var validationResults;return"giftRegistry"===this.addressType()?!0:(validationResults=this.validate(options||{giveFocus:!0}),validationResults.length>0&&_(validationResults).all(function(val){return val.result===!0}))},ShippingAddressViewModel.prototype.isComplete=function(){var attr,unwrapped,_i,_len,_ref;if("giftRegistry"===this.addressType())return!0;for(_ref=this.getRequiredAttributes(),_i=0,_len=_ref.length;_len>_i;_i++)if(attr=_ref[_i],unwrapped=ko.utils.safeUnwrapObservable(this[attr]),void 0===unwrapped||null===unwrapped||0===unwrapped.toString().replace(/_|-/g,"").length)return!1;return!0},ShippingAddressViewModel.prototype.getRequiredAttributes=function(){var _ref,_ref1;return"COL"===(_ref=this.deliveryCountry())||"USA"===_ref?["addressType","addressId","receiverName","postalCode","street","city","state","country"]:"ARG"===(_ref1=this.deliveryCountry())||"ECU"===_ref1||"URY"===_ref1?["addressType","addressId","receiverName","postalCode","street","city","state","country","number"]:"CHL"===this.deliveryCountry()?["addressType","addressId","receiverName","postalCode","street","state","country","number"]:["addressType","addressId","receiverName","postalCode","street","neighborhood","city","state","country","number"]},ShippingAddressViewModel.prototype.afterRenderAddress=function(elements){return vtex.i18n.translateHtml(".orderform-template-holder")},ShippingAddressViewModel}(),vtex.checkout.ShippingAddressViewModel=ShippingAddressViewModel}.call(this),function(){var BillingAddressViewModel,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};BillingAddressViewModel=function(_super){function BillingAddressViewModel(){this.validate=__bind(this.validate,this),this.getRequiredAttributes=__bind(this.getRequiredAttributes,this);var _this=this;BillingAddressViewModel.__super__.constructor.call(this),this.removeModuleSubscriptions(),radio("vtex.i18n.update").unsubscribe(this.updateSlasForSeller),this.moduleId="paymentData.billingAddress",this.isBillingAddress=!0,radio("checkout."+this.moduleId+".commit").subscribe(function(address){return _this.loading()?(_this.update(address),_this.validate({giveFocus:!0,silent:!0})):void 0})}return __extends(BillingAddressViewModel,_super),BillingAddressViewModel.prototype.serializableProperties=function(){return["addressType","addressId","postalCode","street","number","complement","neighborhood","reference","city","state","country"]},BillingAddressViewModel.prototype.getRequiredAttributes=function(){return this.serializableProperties()},BillingAddressViewModel.prototype.validate=function(options){var fields,prop,_i,_len,_ref;for(fields=[],_ref=this.serializableProperties(),_i=0,_len=_ref.length;_len>_i;_i++)prop=_ref[_i],fields.push(this[prop]);return vtex.ko.validation.validateObservables(fields,options)},BillingAddressViewModel.prototype.afterRenderAddress=function(elements){return vtex.i18n.translateHtml("#payment-data")},BillingAddressViewModel}(vtex.checkout.ShippingAddressViewModel),vtex.checkout.BillingAddressViewModel=BillingAddressViewModel}.call(this),function(){var Payment;Payment=function(){function Payment(json){var deviceFingerprint,_ref,_ref1,_ref2;this.paymentSystem=json.paymentSystem,this.paymentSystemName=json.paymentSystemName,this.group=json.group,this.installments=json.installments,this.installmentsInterestRate=null!=(_ref=json.installmentsInterestRate)?_ref:0,this.installmentsValue=null!=(_ref1=json.installmentsValue)?_ref1:json.value,this.value=json.value,this.referenceValue=json.referenceValue,this.fields=json.fields,this.availableAccounts=json.availableAccounts,this.bin=json.bin,this.accountId=json.accountId,deviceFingerprint=null!=(_ref2=window.vtex.deviceFingerprint)&&"function"==typeof _ref2.toString?_ref2.toString():void 0,deviceFingerprint&&(this.fields||(this.fields={}),this.fields.deviceFingerprint=deviceFingerprint)}return Payment}(),vtex.checkout.Payment=Payment}.call(this),function(){var Installment,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};Installment=function(){function Installment(json){this.toJSON=__bind(this.toJSON,this),this.update=__bind(this.update,this);var _this=this;this.number=ko.observable(),this.value=this.price=ko.observable(),this.hasInterestRate=ko.observable(),this.interestRate=ko.observable(),this.total=ko.observable(),this.update(json),this.text=ko.computed(function(){return 1===_this.number()?i18n.t("paymentData.paymentGroup.creditCard.payInCash")+" - "+_.intAsCurrency(_this.value()):_this.hasInterestRate()?_this.number()+i18n.t("paymentData.paymentGroup.creditCard.installmentsInterestPrefix")+" "+_.intAsCurrency(_this.value())+" "+i18n.t("paymentData.paymentGroup.creditCard.installmentsInterestSuffix")+_.formatCurrency(_this.interestRate()/100)+i18n.t("paymentData.paymentGroup.creditCard.installmentsInterestPeriod"):_this.number()+i18n.t("paymentData.paymentGroup.creditCard.installmentsInterestPrefix")+" "+_.intAsCurrency(_this.value())+" "+i18n.t("paymentData.paymentGroup.creditCard.installments")})}return Installment.prototype.update=function(json){return this.number(json.count),this.value(json.value),this.hasInterestRate(json.hasInterestRate),this.interestRate(json.interestRate),this.total(json.total)},Installment.prototype.toJSON=function(){return{number:this.number(),value:this.value(),hasInterestRate:this.hasInterestRate(),interestRate:this.interestRate(),total:this.total()}},Installment}(),vtex.checkout.Installment=Installment}.call(this),function(){var PaymentSystem,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};PaymentSystem=function(){function PaymentSystem(json){this.toJSON=__bind(this.toJSON,this),this.getInstallmentsForValue=__bind(this.getInstallmentsForValue,this),this.updateInstallmentsMap=__bind(this.updateInstallmentsMap,this),this.update=__bind(this.update,this),this.id=ko.observable(),this.name=ko.observable(),this.groupName=ko.observable(),this.group=ko.observable(),this.template=ko.observable(),this.installmentsMap={},this.requestedInstallmentValuesArray=[],this.selected=ko.observable(),this.regex=ko.observable(),this.mask=ko.observable(),this.cardCodeRegex=ko.observable(),this.cardCodeMask=ko.observable(),this.weights=ko.observable(),this.requiresAuthentication=ko.observable(!1),this.isCustom=ko.observable(),this.useBillingAddress=ko.observable(),this.useCardHolderName=ko.observable(),this.useCvv=ko.observable(),this.useExpirationDate=ko.observable(),this.payments=[],this.update(json)}return PaymentSystem.prototype.update=function(json){return ko.utils.extendObservable(this,_(json).omit("validator")),this.regex(json.validator.regex),this.mask(json.validator.mask),this.cardCodeRegex(json.validator.cardCodeRegex),this.cardCodeMask(json.validator.cardCodeMask),this.weights(json.validator.weights),this.useBillingAddress(json.validator.useBillingAddress),this.useCardHolderName(json.validator.useCardHolderName),this.useCvv(json.validator.useCvv),this.useExpirationDate(json.validator.useExpirationDate),this},PaymentSystem.prototype.updateInstallmentsMap=function(installmentOptionsArray){var bin,installmentOption,installmentsArray,_i,_len,_results;for(_results=[],_i=0,_len=installmentOptionsArray.length;_len>_i;_i++)installmentOption=installmentOptionsArray[_i],installmentsArray=_(installmentOption.installments).map(function(i){return new vtex.checkout.Installment(i)}),bin=installmentOption.bin||"default",this.installmentsMap[bin]||(this.installmentsMap[bin]={}),_results.push(this.installmentsMap[bin][installmentOption.value]=installmentsArray);return _results},PaymentSystem.prototype.getInstallmentsForValue=function(bin,value){var _ref,_ref1;return bin||(bin="default"),(null!=(_ref=this.installmentsMap[bin])?_ref[value]:void 0)?null!=(_ref1=this.installmentsMap[bin])?_ref1[value]:void 0:[]},PaymentSystem.prototype.toJSON=function(){return{paymentSystem:this.id(),installments:this.installmentsMap}},PaymentSystem}(),vtex.checkout.PaymentSystem=PaymentSystem}.call(this),function(){vtex.debug("creditcard");vtex.checkout.CreditCardViewModel=function(parent,paidValue){var self=this;self.id=(-1*(new Date).getTime()).toString(),self.parent=parent,self.active=ko.observable(!0),self.billingAddressRequired=ko.observable(!0),self.billingAddress=new vtex.checkout.BillingAddressViewModel,self.cardNumber=ko.observable(),self.cardBin=ko.observable(),self.cardOwnerNameRequired=ko.observable(!0),self.cardOwnerName=ko.observable(),self.cardExpirationDateRequired=ko.observable(!0),self.cardDueMonth=ko.observable(),self.cardDueYear=ko.observable(),self.cardSafetyCodeRequired=ko.observable(!0),self.cardSafetyCode=ko.observable(),self.document=ko.observable(),self.installments=ko.observableArray(),self._selectedInstallmentNumber=ko.observable(),self.documentPlaceholder=vtex.validation.placeholders.document[checkout.countryCode()],self.documentInputType=ko.computed(function(){var documentPlaceholder;return documentPlaceholder=vtex.validation.placeholders.document[checkout.countryCode()],(null!=documentPlaceholder?documentPlaceholder.match(/[a-z]/i):!0)?"text":"tel"}),self.documentAttributeBindings={placeholder:self.documentPlaceholder,type:self.documentInputType},8===window.dammitIE&&(self.documentAttributeBindings={placeholder:self.documentPlaceholder}),self.noInstallmentsAvailable=ko.computed(function(){return 0==self.installments().length&&self.cardBin()}),self.showInstallmentOptions=ko.computed(function(){var isCreditCard=!self.parent.isDebitCard(),hasInstallments=!self.noInstallmentsAvailable();return isCreditCard&&hasInstallments&&"USA"!==checkout.countryCode()}),self._cardNumberTotem=ko.observable(),self.cardNumberTotem=ko.computed({read:function(){return self._cardNumberTotem()},write:function(value){value+="",self._cardNumberTotem(value.replace(" ","")),self.cardNumber(value)}}),self.cardFormVisible=ko.observable(!checkout.isTotem()),self.cardNumberTotemLabel=ko.observable(),self.labelCardFields=ko.observable(!1),self.isCardOwnerNameLabel=ko.observable(!1),self.isScanningCard=!1,self.selectedInstallment=ko.computed(function(){var number=self._selectedInstallmentNumber();return _.find(self.installments(),function(i){return i.number()===number})}),self.selectedInstallmentNumber=ko.computed({read:function(){return self._selectedInstallmentNumber()},write:function(installmentNumber){if(installmentNumber){var currentInstallmentNumber=self._selectedInstallmentNumber.peek();self._selectedInstallmentNumber(installmentNumber);var newInstallmentIsDifferent=currentInstallmentNumber&&currentInstallmentNumber!==installmentNumber;(!currentInstallmentNumber||newInstallmentIsDifferent)&&($("#payment-data").trigger("cardUpdated.vtex",[self.getPayment(!0),"selectedInstallmentNumber",self.id]),self.selectedInstallmentNumber.validate&&!self.isScanningCard&&self.selectedInstallmentNumber.validate())}}}),self.installmentsCaption=ko.computed(function(){return i18n.t("paymentData.paymentGroup.installmentsCaption")}),self.setOptionDisable=function(option,item){"undefined"==typeof item&&self._selectedInstallmentNumber()&&ko.applyBindingsToNode(option,{disable:!0},item)},self._selectedAvailableAccountId=ko.observable(),self._paidValue=ko.observable(void 0!=paidValue?paidValue:window.paymentData.totalToPayIncludingGifts.peek()),self.cardFlagSuggested=ko.observable(!1),self.oldFlag=ko.observable(void 0),self.isSavedCreditCardsVisible=ko.observable(!1),self.isUsingNewCard=ko.observable(!0),self.oldSelectedAvailableAccountId=ko.observable(void 0),self.cardSafetyCodeHasFocus=ko.observable(),self.sameBillingAddress=ko.observable(!0),self.isUsingGiftRegistryAddress=ko.computed(function(){var isUsign=window.checkout.isUsingGiftRegistryAddress();self.sameBillingAddress(!isUsign)}),self.isCreditCardCustom=ko.observable(self.parent.isCustom()),self.defaultRequiredProperties=["cardNumber","selectedInstallmentNumber","cardOwnerName","cardDueMonth","cardDueYear","cardSafetyCode","document","paidValue","cardBin"],self.requiredProperties=self.defaultRequiredProperties,self.localizedMonth=function(){return i18n.t("paymentData.paymentGroup.creditCard.dueMonth")},self.localizedYear=function(){return i18n.t("paymentData.paymentGroup.creditCard.dueYear")},self.months=["01","02","03","04","05","06","07","08","09","10","11","12"],self.years=[];for(var thisYear=parseInt((new Date).getFullYear().toString().slice(2)),i=0;10>=i;i++)self.years.push((thisYear+i).toString());self.selectedCardFlagId=ko.computed({read:function(){return self.selectedCardFlagId.value()},write:function(value){var flagId=parseInt(value,10),flagIdIsChanged=value!==self.selectedCardFlagId.value.peek();self.selectedCardFlagId.value(flagId),flagIdIsChanged&&null!=value&&$("#payment-data").trigger("cardUpdated.vtex",[self.getPayment(!0),"selectedCardFlagId",self.id])},deferEvaluation:!0});var defaultPaymentSystem=self.parent.availableFlags.peek()[0];self.selectedCardFlagId.value=ko.observable(defaultPaymentSystem?defaultPaymentSystem.id():null),self.billingAddressTemplate=ko.computed(function(){var cc=checkout.countryCode()||"BRA";return"orderForm-shipping-address-"+cc+"-template"}),self.cardDueDate=ko.computed(function(){return self.cardDueMonth()+"/"+self.cardDueYear()}),self.paidValueLabel=ko.computed(function(){var paidValue=self._paidValue();return 0===paidValue?i18n.t("global.free"):null==paidValue?"-":_.intAsCurrency(paidValue)}),self.paidValue=ko.computed({read:function(){return _.formatCurrency(self._paidValue()/100)},write:function(newValue){var editingSensitiveField="number"!=typeof newValue;newValue+="";var intValue=parseInt(newValue.replace(/[\.,]/g,""),10);if(self._paidValue.peek()!==intValue){if(isNaN(intValue))return void self._paidValue.valueHasMutated();if(self._paidValue(intValue),self.paidValue.validate){var validation=self.paidValue.validate({giveFocus:!1});validation.result&&$("#payment-data").trigger("cardUpdated.vtex",[self.getPayment(!0),"paidValue",self.id,editingSensitiveField])}}}}),self._selectedAvailableAccountId=ko.observable(),self.selectedAvailableAccountId=ko.computed({read:function(){return self._selectedAvailableAccountId()},write:function(value){var currentAvailableAccountIdIsChanged=value!==self._selectedAvailableAccountId.peek();self._selectedAvailableAccountId(value),currentAvailableAccountIdIsChanged&&null!=value&&$("#payment-data").trigger("cardUpdated.vtex",[self.getPayment(!0),"selectedAvailableAccountId",self.id])}}),self.unusedAvailableAccounts=ko.computed(function(){var allAccounts=self.parent.availableAccounts(),availables=_.filter(allAccounts,function(acc){var cardUsingAccount=self.parent.isUnusedAvailableAccount(acc.accountId());return void 0===cardUsingAccount||cardUsingAccount===self.id});return availables}),self.showNewCard=function(){self.isSavedCreditCardsVisible(!1),self.isUsingNewCard(!0),self.oldSelectedAvailableAccountId(self.selectedAvailableAccountId()),self._selectedAvailableAccountId(void 0),vtex.i18n.translateHtml("#payment-data")},self.selectedAvailableAccount=ko.computed(function(){for(var i=0;i<self.parent.availableAccounts().length;i++)if(self.parent.availableAccounts()[i].accountId()==self.selectedAvailableAccountId())return self.parent.availableAccounts()[i];self.oldSelectedAvailableAccountId(self.selectedAvailableAccountId()),self.selectedAvailableAccountId(null),self.showNewCard()}),self.selectedCardFlag=ko.computed(function(){var selectedAvailableAccount=self.selectedAvailableAccount(),selectedCardFlagId=self.selectedCardFlagId();return _.find(self.parent.availableFlags.peek(),function(flag){return flag.id()==(selectedAvailableAccount?selectedAvailableAccount.paymentSystem():selectedCardFlagId)})}),self.holderDocumentRequired=ko.computed(function(){var flag=self.selectedCardFlag();return void 0!=flag?flag.requiresDocument():!1}),self.cardCodeMask=ko.computed(function(){var flag=self.selectedCardFlag();return flag&&flag.cardCodeMask().length>0?flag.cardCodeMask():"9999"}),self.isPaidValueNull=ko.computed(function(){return 0===self.paidValue().length}),self.selectedCardFlagId.subscribe(function(newValue,oldValue){if(self.cardFlagSuggested())return void self.cardFlagSuggested(!1);if(self.cardNumber.validate){if(self.isScanningCard)return;oldValue?self.cardNumber.validate({giveFocus:!0}):self.cardNumber.validate({giveFocus:!0,showErrorMessage:!1,applyErrorClass:!1})}}),self.checkBIN=function(cardNumber){var cardNumberNoSpaces=cardNumber.replace(" ","");if(cardNumberNoSpaces.length>=6){var bin=cardNumberNoSpaces.slice(0,6);(null==self.cardBin()||self.cardBin()!==bin)&&(self.cardBin(bin),$("#payment-data").trigger("cardUpdated.vtex",[self.getPayment(),"cardBin",self.id]))}else 0==cardNumberNoSpaces.length&&self.cardBin()&&(self.cardBin(null),$("#payment-data").trigger("cardUpdated.vtex",[self.getPayment(),"cardBin",self.id]))},self.cardRead="",self.canUseCardScanner=ko.computed(function(){return checkout.isTotem()&&paymentData.active()&&self.active()&&paymentData.selectedPaymentGroupId()==parent.id}),self.isWaitingForCardScanner=ko.computed(function(){return self.canUseCardScanner()&&!self.cardFormVisible()?(self.isScanningCard=!1,self.cardRead="",$(document).on("keypress.cardScanner"+parent.id+self.id,function(ev){self.isScanningCard||(self.isScanningCard=!0,setTimeout(function(){self.isScanningCard=!1,$(document).off("keypress.cardScanner"+parent.id+self.id),self.cardFormVisible(!0),new RegExp(/\d{10,18}/).test(self.cardRead)&&self.parseCardRead(self.cardRead)},2e3)),0!==ev.which&&(self.cardRead+=String.fromCharCode(ev.which))}),!0):($(document).off("keypress.cardScanner"+parent.id+self.id),self.isScanningCard=!1,!1)}),self.parseCardRead=function(cardRead){var cardLines=cardRead.split("?"),cardOwnerName=null,cardNumber=null,cardNumberLabel=null,cardDueMonth=null,cardDueYear=null;_.each(cardLines,function(line,index){if(0===index&&-1!==line.indexOf("^")){var lineOneRegex=new RegExp(/^(?:%B)([0-9]+)[^](.+)(?=\^)[^]([0-9]{4})/),lineResult=lineOneRegex.exec(line);if(4===lineResult.length){cardNumber=lineResult[1],cardOwnerName=lineResult[2].trim(),cardDueMonth=lineResult[3].substr(2,2),cardDueYear=lineResult[3].substr(0,2);var lastNameSeparator=cardOwnerName.indexOf("/");if(-1!==lastNameSeparator){var lastName=cardOwnerName.substring(0,lastNameSeparator),firstName=cardOwnerName.substring(lastNameSeparator+1,cardOwnerName.length);cardOwnerName=firstName+" "+lastName}}}else if(-1===line.indexOf("==")&&-1!==line.indexOf("=")){var lineTwoRegex=new RegExp(/\;([0-9]+)(?=\=)=([0-9]{4})/),lineResult=lineTwoRegex.exec(line);if(3==lineResult.length){cardNumber=lineResult[1],cardDueMonth=lineResult[2].substr(2,2),cardDueYear=lineResult[2].substr(0,2);var cardLastDigits=cardNumber.substr(-4,4);cardNumberLabel="   "+cardLastDigits}}}),cardOwnerName?(self.cardOwnerName(cardOwnerName),self.isCardOwnerNameLabel(!0)):(self.cardOwnerName(""),self.isCardOwnerNameLabel(!1)),cardNumber?(self.labelCardFields(!0),self.cardNumber(cardNumber),self.cardNumberTotemLabel(cardNumberLabel),self.cardDueMonth(cardDueMonth),self.cardDueYear(cardDueYear),self.cardSafetyCode(""),vtex.i18n.translateHtml("#payment-data")):(self.labelCardFields(!1),self.cardFormVisible(!1),self.cardNumber(""),self.cardNumberTotemLabel(""),self.cardSafetyCode(""),vtex.i18n.translateHtml("#payment-data")),self.validate({silent:!0,giveFocus:!0})},self.openCardFields=function(){self.labelCardFields(!1),vtex.i18n.translateHtml("#payment-data")},self.toggleCardForm=function(){self.cardFormVisible()&&(self.labelCardFields(!1),self.cardNumberTotem(""),self.cardNumberTotemLabel(""),self.cardSafetyCode(""),self.cardOwnerName(""),self.cardDueMonth(""),self.cardDueYear("")),self.cardFormVisible(!self.cardFormVisible())},self.cardNumber.subscribe(function(newValue){var cardNumber=newValue,ccDOMElement=$("#"+parent.identifier()+"payment-card"+self.id+"Number")[0];if(self.creditCardCustom===!1){if(""==cardNumber)return self.selectedCardFlagId(null),void self.cardFlagSuggested(!1);if(null!=self.selectedCardFlag()&&!self.cardFlagSuggested()&&0===self.selectedCardFlag().regex().length)return}if(self.checkBIN(cardNumber),self.isCreditCardCustom())var flag=self.parent.paymentSystem();else var flag=self.parent.findPaymentSystemByCardNumber(cardNumber);if(flag){(void 0==self.oldFlag()||self.oldFlag()!=flag)&&(self.cardFlagSuggested(!0),self.oldFlag(flag),self.cardSafetyCode("")),self.selectedCardFlagId(flag.id());var maskedNumber=flag.mask().length>0?_.maskString(cardNumber,flag.mask()):cardNumber;if(maskedNumber===cardNumber)return;if(void 0==ccDOMElement)return;var selectionStart,selectionEnd;ccDOMElement.selectionStart&&(selectionStart=ccDOMElement.selectionStart,selectionEnd=ccDOMElement.selectionEnd),self.cardNumber(maskedNumber),ccDOMElement.selectionStart&&(ccDOMElement.selectionStart=self.calculateNewSelectionIgnoringChars(selectionStart,cardNumber,maskedNumber,/ /g),ccDOMElement.selectionEnd=self.calculateNewSelectionIgnoringChars(selectionEnd,cardNumber,maskedNumber,/ /g))}else self.cardFlagSuggested(!1),self.cardNumber(cardNumber)}),self.validateDocument=function(value,element){return self.holderDocumentRequired()?vtex.validation.validateDocument(value,element):{result:!0}},self.documentOwner=ko.computed(function(){var documentName=i18n.t("clientProfileData.document-"+checkout.countryCode());return i18n.t("paymentData.paymentGroup.creditCard.documentOwner",{document:documentName})}),self.calculateNewSelectionIgnoringChars=function(selectionIndex,stringBefore,stringAfter,ignoreRegex){var beforeSubString=stringBefore.substring(0,selectionIndex),afterSubString=stringAfter.substring(0,selectionIndex),matchBefore=beforeSubString.match(ignoreRegex),matchAfter=afterSubString.match(ignoreRegex),ignoredBefore=matchBefore?matchBefore.length:0,ignoredAfter=matchAfter?matchAfter.length:0;return selectionIndex+(ignoredAfter-ignoredBefore)},self.getPayment=function(masked){var _ref,selectedInstallment=null;self.installments()&&(selectedInstallment=null!=(_ref=self.selectedInstallment())?_ref.toJSON():void 0);var selectedPaymentSystem=self.selectedCardFlag();if(void 0==selectedPaymentSystem)return null;var account=self.selectedAvailableAccount(),fields={},bin=void 0,accountId=void 0;if(masked)null!=self.cardBin()&&(bin=self.cardBin()),void 0!=account&&(accountId=account.accountId(),bin=account.cardBin()),fields=void 0;else if(void 0!=account)fields={accountId:account.accountId(),validationCode:account.cardSafetyCode(),firstDigits:account.cardBin()};else if(fields={holderName:self.cardOwnerName(),cardNumber:self.cardNumber(),validationCode:self.cardSafetyCode(),dueDate:self.cardDueDate(),document:self.document()},0==self.cardExpirationDateRequired()&&(fields.dueDate=""),self.sameBillingAddress())fields.addressId=paymentData.selectedAddressId;else{
var billingAddress=self.billingAddress.toJSON(),countryCode=checkout.countryCode(),countryWithNoPostalCode=["CHL","COL","PER","ECU","PRY"],billingHasNoPostalCode=_.any(countryWithNoPostalCode,function(country){return countryCode===country});if(billingHasNoPostalCode){var postalCodeKey=vtex.validation.countryToKey[countryCode].postalCode;billingAddress.postalCode=vtex.validation.masks[postalCodeKey]}fields.address=billingAddress}return new vtex.checkout.Payment({paymentSystem:selectedPaymentSystem.id(),paymentSystemName:selectedPaymentSystem.name(),group:selectedPaymentSystem.groupName(),referenceValue:self._paidValue(),value:selectedInstallment?selectedInstallment.total:self._paidValue(),installments:self._selectedInstallmentNumber(),installmentsInterestRate:selectedInstallment?selectedInstallment.interestRate:null,installmentsValue:selectedInstallment?selectedInstallment.value:null,fields:fields,bin:bin,accountId:accountId})},self.paidValueValidationMessage=ko.computed(function(){return checkout.locale(),i18n.t("paymentData.paymentGroup.creditCard.invalidValue")}),self.validatePaidValue=function(value,element){var validation={result:!1,message:""},totalToPay=window.paymentData.totalToPayIncludingGifts.peek(),paidValue=self._paidValue.peek(),isTotalZero=0===totalToPay;return 0>paidValue||0==paidValue&&!isTotalZero||paidValue>totalToPay?(validation.message=self.paidValueValidationMessage(),validation.applyErrorClass=validation.showErrorMessage=!0,validation.result=!1):(validation.applyErrorClass=validation.showErrorMessage=!1,validation.result=!0),validation},self.digitsValidationMessage=ko.computed(function(){return checkout.locale(),i18n.t("paymentData.paymentGroup.creditCard.invalidDigits")}),self.validateCreditCard=function(value,element){var validation={result:!1,message:""},selectedCardFlag=self.selectedCardFlag.peek();self.cardNumber(self.cardNumber.peek().replace(/[A-Za-z$-]/g,""));var cardNumber=self.cardNumber.peek();if(void 0==selectedCardFlag)return validation;var selectedFlagRegex=selectedCardFlag.regex.peek();return 0===selectedFlagRegex.length?(validation.applyErrorClass=validation.showErrorMessage=!1,validation.applySuccessClass=!validation.applyErrorClass,validation.result=!0):new RegExp(selectedFlagRegex).test(cardNumber.replace(/ /g,""))&&vtex.validation.validateCardDigits(selectedCardFlag.weights.peek(),cardNumber)?(validation.applyErrorClass=validation.showErrorMessage=!1,validation.applySuccessClass=!validation.applyErrorClass,validation.result=!0):self.isCreditCardCustom()&&new RegExp(selectedFlagRegex).test(cardNumber.replace(/ /g,""))?(validation.applyErrorClass=validation.showErrorMessage=!1,validation.applySuccessClass=!validation.applyErrorClass,validation.result=!0):(validation.message=self.digitsValidationMessage(),validation.applyErrorClass=validation.showErrorMessage=!0,validation.applySuccessClass=!validation.applyErrorClass,validation.result=!1),validation},self.validateDate=function(dmonth,dyear){var today=new Date,year=today.getFullYear().toString().slice(2),month=today.getMonth()+1;return!(dyear==year&&month>dmonth||dmonth>12||year>dyear)},self.dateValidationMessage=ko.computed(function(){return checkout.locale(),i18n.t("paymentData.paymentGroup.creditCard.invalidDate")}),self.validateDueMonth=function(value,element){var validation={result:self.validateDate(value,self.cardDueYear()),message:""};return validation.applyErrorClass=validation.showErrorMessage=!validation.result,validation.result||(validation.message=self.dateValidationMessage()),validation},self.validateDueYear=function(value,element){var validation={result:self.validateDate(self.cardDueMonth(),value),message:""};return validation.applyErrorClass=validation.showErrorMessage=!validation.result,validation.result||(validation.message=self.dateValidationMessage()),validation},self.validateCardCode=function(cardSafetyCode,element){var regex,cardCodeRegex,validation={result:!1,message:""},selectedCardFlag=self.selectedCardFlag.peek();return cardCodeRegex=null==selectedCardFlag?/\d{3,4}/:(regex=selectedCardFlag.cardCodeRegex.peek())?new RegExp(regex):/^\d{3,4}$/,validation.result=cardCodeRegex.test(cardSafetyCode),validation.result||(validation.message=i18n.t("paymentData.paymentGroup.creditCard.invalidDigits")),validation.applyErrorClass=validation.showErrorMessage=!validation.result,validation},self.validate=function(options){var fields=[];if(null!=self.selectedAvailableAccountId())fields.push(self.selectedInstallmentNumber,self.paidValue),self.selectedAvailableAccount().cardSafetyCodeRequired()&&fields.push(self.selectedAvailableAccount().cardSafetyCode);else{var properties=self.requiredProperties;if(fields=fields.concat(_.map(properties,function(f){return self[f]})),self.billingAddressRequired()&&!self.sameBillingAddress()){var addressProperties=self.billingAddress.serializableProperties();fields=fields.concat(_.map(addressProperties,function(f){return self.billingAddress[f]}))}}return vtex.ko.validation.validateObservables(fields,options)},self.toggleSavedCardsVisibility=function(viewModel){self.isSavedCreditCardsVisible()===!0?(self.showNewCard(),$("#payment-data").trigger("cardUpdated.vtex",[self.getPayment(!0),"selectedCardFlagId",self.id])):self.showSavedCreditCards(viewModel),window.paymentData.isValid({giveFocus:!0,silent:!0})},self.showSavedCreditCards=function(viewModel){var accountIdObservable=viewModel?self.selectedAvailableAccountId:self._selectedAvailableAccountId,used=self.parent.isUnusedAvailableAccount(self.oldSelectedAvailableAccountId());if(void 0!==used&&used!==self.id||null==self.oldSelectedAvailableAccountId()){var unusedAvailableAccounts=self.unusedAvailableAccounts();if(!(unusedAvailableAccounts.length>0))return self.showNewCard();null==accountIdObservable()&&accountIdObservable(unusedAvailableAccounts[0].accountId())}else accountIdObservable(self.oldSelectedAvailableAccountId());self.isSavedCreditCardsVisible(!0),self.isUsingNewCard(!1)},self.isRemovedAvailableAccountBeingUsed=function(aa){self.selectedAvailableAccountId()==aa.accountId()&&self.showSavedCreditCards(aa)},radio("paymentData.paymentGroup.creditCard.availableAccounts.remove").subscribe(self.isRemovedAvailableAccountBeingUsed),self.setupCustomCard=function(paymentSystem){self.selectedCardFlagId.value(paymentSystem.id()),paymentSystem.useBillingAddress()||self.billingAddressRequired(!1),paymentSystem.useCardHolderName()||(self.cardOwnerNameRequired(!1),self.requiredProperties=_.reject(self.requiredProperties,function(p){return"cardOwnerName"===p})),paymentSystem.useCvv()||(self.cardSafetyCodeRequired(!1),self.requiredProperties=_.reject(self.requiredProperties,function(p){return"cardSafetyCode"===p})),paymentSystem.useExpirationDate()||(self.cardExpirationDateRequired(!1),self.requiredProperties=_.reject(self.requiredProperties,function(p){return"cardDueYear"===p||"cardDueMonth"===p}))}}}(),function(){var AvailableAccountViewModel,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};AvailableAccountViewModel=function(){function AvailableAccountViewModel(id,json,paymentSystem){this.focusOnCCV=__bind(this.focusOnCCV,this),this.remove=__bind(this.remove,this),this.cardRemoveAsterisks=__bind(this.cardRemoveAsterisks,this);var _this=this;this.id=id,this.accountId=ko.observable(json.accountId),this.cardNumber=ko.observable(json.cardNumber),this.paymentSystem=ko.observable(json.paymentSystem),this.paymentSystemName=ko.observable(json.paymentSystemName),this.availableAddresses=ko.observableArray(json.availableAddresses),this.cardSafetyCode=ko.observable(""),this.cardBin=ko.observable(json.bin),this.cardSafetyCodeHasFocus=ko.observable(),this.groupName="creditCardPaymentGroup",this.cardSafetyCodeRequired=ko.observable(paymentSystem?paymentSystem.useCvv():!1),this.cardCodeMask=ko.observable("9999"),paymentSystem&&paymentSystem.useCvv()&&this.cardCodeMask(paymentSystem.cardCodeMask()),this.cardNumberLabel=ko.computed(function(){var lastNumbers;return checkout.locale(),lastNumbers=_this.cardRemoveAsterisks(),""+_this.paymentSystemName()+" "+i18n.t("paymentData.paymentGroup.creditCard.endingIn")+" "+lastNumbers})}return AvailableAccountViewModel.prototype.cardRemoveAsterisks=function(){return this.cardNumber().toString().replace(/\*/g,"")},AvailableAccountViewModel.prototype.remove=function(){return API.removeAccountId(this.accountId()),radio("paymentData.paymentGroup.creditCard.availableAccounts.remove").broadcast(this)},AvailableAccountViewModel.prototype.focusOnCCV=function(data){return this.cardSafetyCodeRequired()&&$(".orderform-template.active .step.active #cardCode"+this.id).focus(),!0},AvailableAccountViewModel}(),vtex.checkout.AvailableAccountViewModel=AvailableAccountViewModel}.call(this),function(){var GiftCardViewModel,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};GiftCardViewModel=function(){function GiftCardViewModel(json){var _ref,_this=this;null==json&&(json={}),this.dontUse=__bind(this.dontUse,this),this.use=__bind(this.use,this),this.toJSON=__bind(this.toJSON,this),this.update=__bind(this.update,this),this.id=null!=(_ref=json.id)?_ref:(-1*(new Date).getTime()).toString()+Math.random().toString(36).substr(2),this.redemptionCode=ko.observable(null),this.value=ko.observable(null),this.balance=ko.observable(null),this.name=ko.observable(null),this.inUse=ko.observable(null),this.isSpecialCard=ko.observable(null),this.caption=ko.observable(null),this.captionClass=ko.observable(null),this.provider=ko.observable(null),this.groupName=ko.observable(null),this.update(json),this.valueLabel=ko.computed(function(){return _.intAsCurrency(_this.value())}),this.balanceLabel=ko.computed(function(){return _.intAsCurrency(_this.balance())}),this.friendlyName=ko.computed(function(){return _this.caption()?_this.caption():i18n.t("global."+_this.name())}),radio("vtex.i18n.update").subscribe(function(){return _this.name.notifySubscribers()})}return GiftCardViewModel.prototype.update=function(json){var _ref,_ref1;return this.redemptionCode(json.redemptionCode),this.value(json.value),this.balance(json.balance),this.name(json.name),this.inUse(null!=(_ref=json.inUse)?_ref:!1),this.isSpecialCard(null!=(_ref1=json.isSpecialCard)?_ref1:!1),this.caption(json.caption),json.caption&&this.captionClass(_.spacesToHyphens(json.caption+"").toLowerCase()),this.provider(json.provider),this.groupName(json.groupName)},GiftCardViewModel.prototype.toJSON=function(){return{id:this.id,redemptionCode:this.redemptionCode(),value:this.value(),balance:this.balance(),name:this.name(),inUse:this.inUse(),isSpecialCard:this.isSpecialCard(),provider:this.provider()}},GiftCardViewModel.prototype.use=function(){return this.inUse(!0),window.paymentData.paymentGroups.giftCardPaymentGroup.submitGiftCards()},GiftCardViewModel.prototype.dontUse=function(){return this.inUse(!1),window.paymentData.paymentGroups.giftCardPaymentGroup.submitGiftCards()},GiftCardViewModel}(),vtex.checkout.GiftCardViewModel=GiftCardViewModel}.call(this),function(){var PaymentGroupViewModel,debug,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};debug=vtex.debug("paym-group"),PaymentGroupViewModel=function(){function PaymentGroupViewModel(json,paymentSystems){this.getPayments=__bind(this.getPayments,this),this.updateInstallments=__bind(this.updateInstallments,this),this.updatePayments=__bind(this.updatePayments,this);var _this=this;this.id=(-1*(new Date).getTime()).toString()+Math.random().toString(36).substr(2),this.template=ko.observable("genericPaymentGroup-template"),this.name=json.name,this.nameSlug=json.isCustom?_.sanitize(_.spacesToHyphens(json.name)).toLowerCase():"",this.className=this.nameSlug?"pg-"+this.nameSlug:"",this.description=json.description,this.groupName=ko.observable(json.groupName),radio("vtex.i18n.update").subscribe(function(){return _this.groupName.notifySubscribers()}),this.showAsTab=ko.observable(!0),this.paymentSystems=ko.observableArray(paymentSystems),this.paidValue=ko.observable(),"PayPal"===this.name&&(this.template=ko.observable("payPalPaymentGroup-template")),"Safetypay"===this.name&&(this.template=ko.observable("safetyPayPaymentGroup-template")),"Koin Ps-Pago"===this.name&&(this.template=ko.observable("boletoKoinPosPagoPaymentGroup-template")),"Stelo"===this.name&&(this.template=ko.observable("steloPaymentGroup-template")),"Venda Direta Credito"===this.name&&(this.template=ko.observable("pinpadPaymentGroup-template")),"Mercado Pago"===this.name&&(this.template=ko.observable("mercadoPagoPaymentGroup-template")),this.localizedLabel=ko.computed(function(){var groupName,translation,translationKey;return groupName=_this.groupName(),translationKey="paymentData.paymentGroup."+groupName.replace("PaymentGroup","")+".name",translation=i18n.t(translationKey),translation===translationKey?_this.name:translation}),this.localizedDescription=ko.computed(function(){var groupName,translation,translationKey,_ref;return groupName=_this.groupName(),translationKey="paymentData.paymentGroup."+groupName.replace("PaymentGroup","")+".description",translation=i18n.t(translationKey),translation===translationKey?null!=(_ref=_this.description)?_ref:_this.name:translation}),this.paymentSystem=ko.observable(paymentSystems[0]),this.installments=ko.observableArray(),this.selectedInstallment=ko.computed(function(){return _.find(_this.installments(),function(i){return i.number()===_this._selectedInstallmentNumber()})}),this._selectedInstallmentNumber=ko.observable(),this.selectedInstallmentNumber=ko.computed({read:function(){return _this._selectedInstallmentNumber()},write:function(installmentNumber){var currentInstallmentNumber,newInstallmentIsDifferent;if(installmentNumber)return currentInstallmentNumber=_this._selectedInstallmentNumber.peek(),_this._selectedInstallmentNumber(installmentNumber),newInstallmentIsDifferent=null!=currentInstallmentNumber&&currentInstallmentNumber!==installmentNumber,null==currentInstallmentNumber||newInstallmentIsDifferent?(debug("changed installment from",currentInstallmentNumber,"to",installmentNumber),$(window).trigger("paymentUpdated.vtex")):void 0}}),this.maxInstallmentOptionFunction=function(installments){return installments?_.max(installments,function(i){return i.number()}):void 0},this.maxInstallmentOption=ko.computed(function(){return _this.maxInstallmentOptionFunction(_this.installments())}),this.installmentsCaption=ko.computed(function(){return null==_this._selectedInstallmentNumber()?i18n.t("paymentData.paymentGroup.installmentsCaption"):null}),this.setOptionDisable=function(option,item){return"undefined"==typeof item&&_this._selectedInstallmentNumber()?ko.applyBindingsToNode(option,{disable:!0},item):void 0}}return PaymentGroupViewModel.prototype.updatePayments=function(payments){var p,_i,_len,_results;for(_results=[],_i=0,_len=payments.length;_len>_i;_i++)p=payments[_i],this.paidValue(p.referenceValue),_results.push(this.updateInstallments(p.installments));return _results},PaymentGroupViewModel.prototype.updateInstallments=function(installmentNumber){var installments,oldInstallmentNumber,_ref;if(oldInstallmentNumber=null!=(_ref=this._selectedInstallmentNumber())?_ref:installmentNumber,installments=this.paymentSystem().getInstallmentsForValue("default",this.paidValue()),null==installments)throw new Error("No installments for current paid value",this.paidValue(),"on paymentSystem",this.paymentSystem().id());return oldInstallmentNumber&&this._selectedInstallmentNumber(oldInstallmentNumber),this.installments(installments),vtex.i18n.translateHtml(".steps-view")},PaymentGroupViewModel.prototype.getPayments=function(masked){var payment,selectedInstallment,total,_ref;return total=this.paidValue(),0===total?[]:(selectedInstallment=null!=(_ref=this.selectedInstallment())?_ref.toJSON():void 0,payment=new vtex.checkout.Payment({paymentSystem:this.paymentSystem().id(),paymentSystemName:this.paymentSystem().name(),group:this.paymentSystem().groupName(),value:selectedInstallment?null!=selectedInstallment?selectedInstallment.total:void 0:total,referenceValue:total,installments:this._selectedInstallmentNumber(),installmentsInterestRate:null!=selectedInstallment?selectedInstallment.interestRate:void 0,installmentsValue:null!=selectedInstallment?selectedInstallment.value:void 0}),[payment])},PaymentGroupViewModel.prototype.validate=function(){return[{result:!0}]},PaymentGroupViewModel.prototype.isValid=function(){return!0},PaymentGroupViewModel}(),vtex.checkout.PaymentGroupViewModel=PaymentGroupViewModel}.call(this),function(){var CreditCardPaymentGroupViewModel,debug,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};debug=vtex.debug("pg-credit"),CreditCardPaymentGroupViewModel=function(_super){function CreditCardPaymentGroupViewModel(json,paymentSystems){this.afterSelected=__bind(this.afterSelected,this),this.afterRenderGroup=__bind(this.afterRenderGroup,this),this.isUnusedAvailableAccount=__bind(this.isUnusedAvailableAccount,this),this.removeAvailableAccount=__bind(this.removeAvailableAccount,this),this.isValid=__bind(this.isValid,this),this.validate=__bind(this.validate,this),this.getPayments=__bind(this.getPayments,this),this.findPaymentSystemByName=__bind(this.findPaymentSystemByName,this),this.findPaymentSystemByCardNumber=__bind(this.findPaymentSystemByCardNumber,this),this.cardUpdatedHandlerDebounced=__bind(this.cardUpdatedHandlerDebounced,this),this.cardUpdatedHandler=__bind(this.cardUpdatedHandler,this),this.throttledPaidValueHandler=__bind(this.throttledPaidValueHandler,this),this.updateInstallments=__bind(this.updateInstallments,this),this.updatePayments=__bind(this.updatePayments,this),this.useOneLessCard=__bind(this.useOneLessCard,this),this.useOneMoreCard=__bind(this.useOneMoreCard,this),this.distributeValue=__bind(this.distributeValue,this);var _this=this;CreditCardPaymentGroupViewModel.__super__.constructor.apply(this,arguments),this.identifier=ko.observable("creditCard"),this.maxNumberOfCards=ko.observable(2),this.lastTotalToPay=ko.observable(),this.cards=ko.observableArray(),this.removedCards=ko.observableArray(),this.isDebitCard=ko.observable(!1),"debitCardPaymentGroup-template"===json.template&&(json.template="creditCardPaymentGroup-template",this.isDebitCard=ko.observable(!0)),this.template(json.template),this.showUseMoreCards=ko.computed(function(){return!checkout.isTotem()&&!_this.isDebitCard()}),this.isCustom=ko.observable(json.isCustom),this.pgTitle="paymentData.paymentGroup."+this.identifier()+"."+this.identifier(),this.isEditingSensitiveField=ko.observable(),this.paidValue=ko.computed({read:function(){return _.reduce(_this.cards(),function(memo,c){return memo+c._paidValue()},0)},write:function(value,index){return null!=index&&"number"==typeof index?_this.cards()[index].paidValue(value):_this.paidValue.peek()!==value?_this.distributeValue(value):void 0}}),this.throttledPaidValue=ko.computed(function(){return _this.paidValue()}).extend({throttle:2e3}),this.throttledPaidValue.subscribe(this.throttledPaidValueHandler),this.availableAccountsArray=ko.observableArray(),this.wasArrayUpdated=!1,radio("paymentData.paymentGroup.creditCard.availableAccounts.remove").subscribe(this.removeAvailableAccount),this.isUsingMoreThanOneCard=ko.computed(function(){return _this.cards().length>1}),this.availableFlags=ko.computed(function(){return _.filter(_this.paymentSystems(),function(paymentSystem){return paymentSystem.groupName()===_this.groupName()&&!paymentSystem.isCustom()})}),this.availableAccounts=ko.computed({read:function(){return _this.availableAccountsArray()},write:function(value){var account,hashAA,hashValue,i,j,paymentSystem,tempArray;if(_this.availableAccountsArray().length>0){if(hashValue=_.reduce(value,function(hashValue,c){return hashValue+c.accountId},""),hashAA=_.reduce(_this.availableAccountsArray(),function(hashAA,c){return hashAA+c.accountId()},""),hashAA===hashValue)return;_this.wasArrayUpdated=!0,_this.availableAccountsArray.removeAll()}else _this.wasArrayUpdated=!1;for(i=0,j=value.length,tempArray=[];j>i;)paymentSystem=_this.findPaymentSystemByName(value[i].paymentSystemName),account=new vtex.checkout.AvailableAccountViewModel(i,value[i],paymentSystem),tempArray.push(account),i++;return _this.availableAccountsArray(tempArray),_this.wasArrayUpdated=!1,_this.afterRenderGroup()}}),this.totalToPaySubscription=window.paymentData.totalToPayIncludingGifts.subscribe(function(newValue){return null!=_this.lastTotalToPay()&&newValue!==_this.lastTotalToPay()?(_this.lastTotalToPay(newValue),_this.distributeValue(newValue)):void 0}),this.cards.push(new vtex.checkout.CreditCardViewModel(this)),this.cardUpdatedHandlerDebounced=_.debounce(this.cardUpdatedHandlerDebounced,100),$("#payment-data").on("cardUpdated.vtex",this.cardUpdatedHandler)}return __extends(CreditCardPaymentGroupViewModel,_super),CreditCardPaymentGroupViewModel.prototype.distributeValue=function(totalIncludingGifts){var adjusted,card,cards,divided,i,numberOfCards,_i,_len;for(cards=this.cards.peek(),numberOfCards=cards.length,divided=totalIncludingGifts/numberOfCards,i=0,i=_i=0,_len=cards.length;_len>_i;i=++_i)card=cards[i],adjusted=divided,adjusted=i===numberOfCards-1?Math.ceil(divided):Math.floor(divided),card.paidValue(adjusted),card.paidValue.validate&&card.paidValue.validate()},CreditCardPaymentGroupViewModel.prototype.useOneMoreCard=function(paymentGroupViewModel){var card,newCard,total;if(this.cards().length!==this.maxNumberOfCards())return this.removedCards().length>0?(newCard=this.removedCards.pop(),newCard.active(!0),this.cards.push(newCard)):(card=new vtex.checkout.CreditCardViewModel(this),card.showSavedCreditCards(paymentGroupViewModel),this.cards.push(card)),$(".orderform-template.active .step.active #paymentCard2Number").focus(),null!=paymentGroupViewModel?(total=window.paymentData.totalToPayIncludingGifts.peek(),this.distributeValue(total)):void 0},CreditCardPaymentGroupViewModel.prototype.useOneLessCard=function(){var removedCard,total;return removedCard=this.cards.pop(),removedCard.active(!1),this.cards().length>1&&this.removedCards.push(removedCard),$(".orderform-template.active .step.active #paymentCard1Number").focus(),total=window.paymentData.totalToPayIncludingGifts.peek(),this.distributeValue(total)},CreditCardPaymentGroupViewModel.prototype.updatePayments=function(payments){var card,i,p,_i,_len,_results;for(_results=[],i=_i=0,_len=payments.length;_len>_i;i=++_i)p=payments[i],1===i&&1===this.cards().length&&this.useOneMoreCard(),card=this.cards()[i],p.accountId?(card.selectedAvailableAccountId(p.accountId),card.showSavedCreditCards()):(card.selectedCardFlagId.value(parseInt(p.paymentSystem)),card.showNewCard()),card._paidValue(p.referenceValue),_results.push(this.updateInstallments(p.installments,i));return _results},CreditCardPaymentGroupViewModel.prototype.updateInstallments=function(installmentNumber,index){var account,bin,card,installments,paymentSystem,value;return null==index&&(index=0),card=this.cards.peek()[index],paymentSystem=card.selectedCardFlag.peek(),paymentSystem&&(value=card._paidValue.peek(),account=card.selectedAvailableAccount(),bin=account?account.cardBin.peek():card.cardBin.peek(),installments=paymentSystem.getInstallmentsForValue(bin,value),null!=installments)?(null!=installmentNumber&&card._selectedInstallmentNumber(installmentNumber),card.installments(installments)):void 0},CreditCardPaymentGroupViewModel.prototype.throttledPaidValueHandler=function(){var allCardsHaveValidValues,isEditingSensitiveField;return isEditingSensitiveField=this.isEditingSensitiveField.peek(),allCardsHaveValidValues=_.all(this.cards(),function(c){var validation,_base;return validation="function"==typeof(_base=c.paidValue).validate?_base.validate({dontChangeDOM:!0}):void 0,null!=validation?validation.result:void 0}),2===this.cards().length&&allCardsHaveValidValues&&isEditingSensitiveField&&this.cardUpdatedHandlerDebounced(),this.isEditingSensitiveField(!1)},CreditCardPaymentGroupViewModel.prototype.cardUpdatedHandler=function(ev,payment,attributeUpdated,cardId,editingSensitiveField){var otherCard,otherCardValue,total;return debug("card updated",payment,attributeUpdated),null!=ev&&ev.stopPropagation(),payment&&"paidValue"===attributeUpdated&&2===this.cards().length?(editingSensitiveField&&this.isEditingSensitiveField(!0),total=window.paymentData.totalToPayIncludingGifts.peek(),otherCardValue=total-payment.referenceValue,otherCard=_.find(this.cards(),function(c){return c.id!==cardId}),otherCard.paidValue(otherCardValue),void otherCard.paidValue.validate({giveFocus:!1})):this.cardUpdatedHandlerDebounced()},CreditCardPaymentGroupViewModel.prototype.cardUpdatedHandlerDebounced=function(){var allCardsHavePaymentSystems;return(allCardsHavePaymentSystems=_.all(this.cards(),function(c){return c.selectedCardFlag()}))?$(window).trigger("paymentUpdated.vtex"):void 0},CreditCardPaymentGroupViewModel.prototype.findPaymentSystemByCardNumber=function(cardNumber){var cardNumberString;return cardNumberString=cardNumber+"",_.find(this.availableFlags(),function(item){var regex;return regex=new RegExp(item.regex()),item.regex().length>0&&regex.test(cardNumberString.replace(RegExp(" ","g"),""))})},CreditCardPaymentGroupViewModel.prototype.findPaymentSystemByName=function(psName){return _.find(this.availableFlags(),function(item){return item.name()===psName})},CreditCardPaymentGroupViewModel.prototype.getPayments=function(masked){return _.chain(this.cards()).map(function(c){return c.getPayment(masked)}).compact().value()},CreditCardPaymentGroupViewModel.prototype.validate=function(options){return _.flatten(_.map(this.cards(),function(c){var opt;return opt=_.clone(options)||{giveFocus:!1},c.validate(opt)}))},CreditCardPaymentGroupViewModel.prototype.isValid=function(options){var validationResults;return validationResults=this.validate(options||{giveFocus:!0}),validationResults.length>0&&_.all(validationResults,function(val){return val.result===!0})},CreditCardPaymentGroupViewModel.prototype.removeAvailableAccount=function(ac){return this.availableAccountsArray.remove(ac)},CreditCardPaymentGroupViewModel.prototype.isUnusedAvailableAccount=function(availableAccountId){var _ref;return null!=(_ref=_.find(this.cards(),function(c){return c.selectedAvailableAccountId()===availableAccountId}))?_ref.id:void 0},CreditCardPaymentGroupViewModel.prototype.afterRenderGroup=function(){return vtex.i18n.translateHtml("#payment-data")},CreditCardPaymentGroupViewModel.prototype.afterSelected=function(){return this.validate({giveFocus:!0,showErrorMessage:!1,applyErrorClass:!1})},CreditCardPaymentGroupViewModel}(vtex.checkout.PaymentGroupViewModel),vtex.checkout.CreditCardPaymentGroupViewModel=CreditCardPaymentGroupViewModel}.call(this),function(){var CreditCardCustomPaymentGroupViewModel,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};CreditCardCustomPaymentGroupViewModel=function(_super){function CreditCardCustomPaymentGroupViewModel(json,paymentSystems){this.afterRenderGroup=__bind(this.afterRenderGroup,this),this.afterSelected=__bind(this.afterSelected,this);var _this=this;CreditCardCustomPaymentGroupViewModel.__super__.constructor.apply(this,arguments),this.identifier=ko.observable("creditCardCustom"),this.template("creditCardPaymentGroup-template"),this.maxNumberOfCards(1),this.pgTitle=this.name,this.localizedLabel=ko.computed(function(){return _this.name}),this.availableFlags=ko.computed(function(){return _.filter(_this.paymentSystems(),function(paymentSystem){return paymentSystem.groupName()===_this.groupName()})}),this.selectedPaymentSystemId=ko.observable(this.availableFlags()[0].id())}return __extends(CreditCardCustomPaymentGroupViewModel,_super),CreditCardCustomPaymentGroupViewModel.prototype.afterSelected=function(wasSelectedBefore){return wasSelectedBefore?void 0:(this.cards()[0].setupCustomCard(this.paymentSystem()),$(".payment-card-number input").focus())},CreditCardCustomPaymentGroupViewModel.prototype.afterRenderGroup=function(){return vtex.i18n.translateHtml("#payment-data"),this.cards()[0].cardNumber.validate?this.cards()[0].cardNumber.validate({silent:!0}):void 0},CreditCardCustomPaymentGroupViewModel}(vtex.checkout.CreditCardPaymentGroupViewModel),vtex.checkout.CreditCardCustomPaymentGroupViewModel=CreditCardCustomPaymentGroupViewModel}.call(this),function(){var DebitPaymentGroupViewModel,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};DebitPaymentGroupViewModel=function(_super){function DebitPaymentGroupViewModel(json,paymentSystems){var _this=this;DebitPaymentGroupViewModel.__super__.constructor.apply(this,arguments),this.template("debitPaymentGroup-template"),this.selectedPaymentSystemId=ko.observable(this.paymentSystems()[0].id()),this.paymentSystem=ko.computed(function(){return _.find(_this.paymentSystems(),function(paymentSystem){return paymentSystem.id()===parseInt(_this.selectedPaymentSystemId(),10)})}),this.selectedPaymentSystemId.subscribe(function(oldValue){return null!=oldValue&&window.paymentData.selectedPaymentGroupId()===_this.id?$(window).trigger("paymentUpdated.vtex"):void 0},this,"beforeChange")}return __extends(DebitPaymentGroupViewModel,_super),DebitPaymentGroupViewModel}(vtex.checkout.PaymentGroupViewModel),vtex.checkout.DebitPaymentGroupViewModel=DebitPaymentGroupViewModel}.call(this),function(){var PagosWebPaymentGroupViewModel,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};PagosWebPaymentGroupViewModel=function(_super){function PagosWebPaymentGroupViewModel(json,paymentSystems){var _this=this;PagosWebPaymentGroupViewModel.__super__.constructor.apply(this,arguments),this.template("PagosWebPaymentGroup-template"),this.selectedPaymentSystemId=ko.observable(this.paymentSystems()[0].id()),this.localizedLabel=ko.observable(i18n.t("paymentData.paymentGroup.pagosWeb.name")),this.description=ko.observable(i18n.t("paymentData.paymentGroup.pagosWeb.description")),this.paymentSystem=ko.computed(function(){return _.find(_this.paymentSystems(),function(paymentSystem){return paymentSystem.id()===parseInt(_this.selectedPaymentSystemId(),10)})}),this.selectedPaymentSystemId.subscribe(function(oldValue){return null!=oldValue&&window.paymentData.selectedPaymentGroupId()===_this.id?$(window).trigger("paymentUpdated.vtex"):void 0},this,"beforeChange")}return __extends(PagosWebPaymentGroupViewModel,_super),PagosWebPaymentGroupViewModel}(vtex.checkout.PaymentGroupViewModel),vtex.checkout.PagosWebPaymentGroupViewModel=PagosWebPaymentGroupViewModel}.call(this),function(){var SpecialGiftCardProviderGroupViewModel;SpecialGiftCardProviderGroupViewModel=function(){function SpecialGiftCardProviderGroupViewModel(parent,name,giftCards){var slug,_this=this;"VtexGiftCard"===name&&(name=i18n.t("global.loyalty-program")),slug=_.sanitize(_.spacesToHyphens(name)).toLowerCase(),this.parent=parent,this.name=ko.observable(name),this.slug=ko.observable(slug),this.giftCards=ko.observableArray(giftCards),this.specialGiftCardsGroups=ko.computed(function(){var groups,groupsArray,key,specialGiftCardsGroup,value;
groups=_.groupBy(_this.giftCards(),function(gc){return gc.groupName()}),groupsArray=[];for(key in groups)value=groups[key],specialGiftCardsGroup=new vtex.checkout.SpecialGiftCardGroupViewModel(self,key,value),groupsArray.push(specialGiftCardsGroup);return groupsArray})}return SpecialGiftCardProviderGroupViewModel}(),window.vtex.checkout.SpecialGiftCardProviderGroupViewModel=SpecialGiftCardProviderGroupViewModel}.call(this),function(){var SpecialGiftCardGroupViewModel;SpecialGiftCardGroupViewModel=function(){function SpecialGiftCardGroupViewModel(parent,name,giftCards){var firstGiftCardInUse,slug,_this=this;"VtexGiftCard"===name&&(name=i18n.t("global.loyalty-program")),slug=_.sanitize(_.spacesToHyphens(name)).toLowerCase(),this.parent=parent,this.name=ko.observable(name),this.slug=ko.observable(slug),this.isRadio=ko.observable(giftCards.length>1),this.giftCards=ko.observableArray(giftCards),firstGiftCardInUse=_.find(giftCards,function(gc){return gc.inUse()}),this.selectedRadioGiftCard=ko.observable(firstGiftCardInUse),this.selectedRadioGiftCard.subscribe(function(value){var giftCard,giftCardToBeUsed,_i,_len,_ref;for(_ref=_this.giftCards(),_i=0,_len=_ref.length;_len>_i;_i++)giftCard=_ref[_i],giftCard.id===value?giftCardToBeUsed=giftCard:giftCard.inUse(!1);return null!=giftCardToBeUsed?giftCardToBeUsed.use():void 0})}return SpecialGiftCardGroupViewModel}(),window.vtex.checkout.SpecialGiftCardGroupViewModel=SpecialGiftCardGroupViewModel}.call(this),function(){var GiftCardPaymentGroupViewModel,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};GiftCardPaymentGroupViewModel=function(_super){function GiftCardPaymentGroupViewModel(){this.getGiftCardsJSON=__bind(this.getGiftCardsJSON,this),this.updateGiftPaymentsTotal=__bind(this.updateGiftPaymentsTotal,this),this.remove=__bind(this.remove,this),this.update=__bind(this.update,this),this.login=__bind(this.login,this),this.getPayments=__bind(this.getPayments,this),this.submitGiftCards=__bind(this.submitGiftCards,this),this.addGiftCard=__bind(this.addGiftCard,this),this.cleanValidation=__bind(this.cleanValidation,this),this.validateGiftCardCode=__bind(this.validateGiftCardCode,this);var _this=this;GiftCardPaymentGroupViewModel.__super__.constructor.apply(this,arguments),this.showAsTab(!1),this.template("giftCardPaymentGroup-template"),this.availableGiftCards=ko.observableArray(),this.giftCardCode=ko.observable(),this.loadingGiftCard=ko.observable(!1),this.giftCards=ko.computed(function(){return _.filter(_this.availableGiftCards(),function(gc){return!gc.isSpecialCard()})}),this.specialGiftCards=ko.computed(function(){return _.filter(_this.availableGiftCards(),function(gc){return gc.isSpecialCard()})}),this.specialGiftCardsProviderGroups=ko.computed(function(){var groups,groupsArray,provider,specialGiftCardsGroup,value;groups=_.groupBy(_this.specialGiftCards(),function(gc){return gc.provider()}),groupsArray=[];for(provider in groups)value=groups[provider],specialGiftCardsGroup=new vtex.checkout.SpecialGiftCardProviderGroupViewModel(self,provider,value),groupsArray.push(specialGiftCardsGroup);return groupsArray}),this.showSpecialGiftCards=ko.computed(function(){return _.some(_this.specialGiftCards(),function(gc){return 0!==gc.balance()})}),this.usedGiftCards=ko.computed(function(){return _.filter(_this.availableGiftCards(),function(gc){return gc.inUse()})}),this.selectedProvider=ko.observable(),this.giftCardProviders=ko.computed(function(){var providers;return providers=window.checkoutConfig.giftCardsProviders(),_this.selectedProvider(providers[0]),providers})}return __extends(GiftCardPaymentGroupViewModel,_super),GiftCardPaymentGroupViewModel.prototype.giftCardOptionsText=function(gc){return null!=gc.caption?gc.caption:gc.id},GiftCardPaymentGroupViewModel.prototype.validateGiftCardCode=function(value,element){var totalPaidByGift,totalToPay,usedGC,validation,_this=this;return validation={result:!0,message:""},void 0===value||""===value?(validation.applyErrorClass=validation.showErrorMessage=!validation.result,validation.applySuccessClass=!validation.result,validation):(usedGC=_(this.availableGiftCards()).find(function(gc){return gc.redemptionCode()===_this.giftCardCode()}),usedGC&&(validation.result=!1,validation.message=i18n.t("paymentData.paymentGroup.giftCard.alreadyUsed")),totalPaidByGift=window.paymentData.giftPaymentsTotal(),totalToPay=window.paymentData.totalToPay(),totalPaidByGift>totalToPay&&(validation.result=!1,validation.message=i18n.t("paymentData.paymentGroup.giftCard.totalAlreadyPaid")),validation.applySuccessClass=validation.result,validation.applyErrorClass=validation.showErrorMessage=!validation.result,validation)},GiftCardPaymentGroupViewModel.prototype.cleanValidation=function(){return this.giftCardCode.validate?this.giftCardCode.validate({silent:!0}):void 0},GiftCardPaymentGroupViewModel.prototype.addGiftCard=function(){var gcArray,_this=this;if(this.giftCardCode()&&(this.giftCardCode(this.giftCardCode().replace(/\s/g,"")),this.giftCardCode.validate().result!==!1&&!_.find(this.availableGiftCards(),function(ugc){return ugc.redemptionCode()===_this.giftCardCode()})))return gcArray=this.availableGiftCards().concat([new vtex.checkout.GiftCardViewModel({redemptionCode:this.giftCardCode(),provider:this.selectedProvider().id,inUse:!0})]),this.submitGiftCards(gcArray)},GiftCardPaymentGroupViewModel.prototype.submitGiftCards=function(giftCardArray){return null==giftCardArray&&(giftCardArray=this.availableGiftCards()),this.loadingGiftCard(!0),radio("checkout.paymentData.giftcard.submit").broadcast(giftCardArray)},GiftCardPaymentGroupViewModel.prototype.getPayments=function(){var ps;return ps=this.paymentSystem(),_.map(this.usedGiftCards(),function(gc){return new vtex.checkout.Payment({paymentSystem:ps.id(),paymentSystemName:ps.name(),installments:1,group:ps.groupName(),value:gc.value(),referenceValue:gc.value(),fields:{redemptionCode:gc.redemptionCode(),provider:gc.provider(),giftCardId:gc.id}})})},GiftCardPaymentGroupViewModel.prototype.updatePayments=function(){},GiftCardPaymentGroupViewModel.prototype.updateInstallments=function(){},GiftCardPaymentGroupViewModel.prototype.login=function(){return vtexid.start({returnUrl:window.location.href,userEmail:window.clientProfileData.email(),locale:checkout.locale(),forceProviders:_.map(this.giftCardProviders(),function(p){return p.oauth})})},GiftCardPaymentGroupViewModel.prototype.update=function(json){var gc,_i,_len;for(this.loadingGiftCard(!1),this.giftCardCode(""),this.availableGiftCards.removeAll(),_i=0,_len=json.length;_len>_i;_i++)gc=json[_i],this.availableGiftCards.push(new vtex.checkout.GiftCardViewModel(gc));return this.updateGiftPaymentsTotal()},GiftCardPaymentGroupViewModel.prototype.remove=function(giftCardId){var normalGiftCard,others;return others=_.filter(this.availableGiftCards(),function(gc){return gc.id!==giftCardId}),normalGiftCard=_.find(others,function(gc){return!gc.isSpecialCard()}),normalGiftCard||window.paymentData.showGiftCard(!1),this.submitGiftCards(others)},GiftCardPaymentGroupViewModel.prototype.updateGiftPaymentsTotal=function(){var value;return value=_.reduce(this.getPayments(),function(memo,payment){return memo+payment.value},0),radio("checkout.paymentData.giftPaymentsTotal").broadcast(value)},GiftCardPaymentGroupViewModel.prototype.getGiftCardsJSON=function(){return _.map(this.availableGiftCards(),function(gc){return gc.toJSON()})},GiftCardPaymentGroupViewModel}(vtex.checkout.PaymentGroupViewModel),vtex.checkout.GiftCardPaymentGroupViewModel=GiftCardPaymentGroupViewModel}.call(this),function(){var BankInvoicePaymentGroupViewModel,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};BankInvoicePaymentGroupViewModel=function(_super){function BankInvoicePaymentGroupViewModel(json,paymentSystems){var _this=this;BankInvoicePaymentGroupViewModel.__super__.constructor.apply(this,arguments),this.template("bankInvoicePaymentGroup-template"),this.selectedPaymentSystemId=ko.observable(this.paymentSystems()[0].id()),this.paymentSystem=ko.computed(function(){return _.find(_this.paymentSystems(),function(paymentSystem){return paymentSystem.id()===parseInt(_this.selectedPaymentSystemId(),10)})}),this.selectedPaymentSystemId.subscribe(function(oldValue){return null!=oldValue&&window.paymentData.selectedPaymentGroupId()===_this.id?$(window).trigger("paymentUpdated.vtex"):void 0},this,"beforeChange")}return __extends(BankInvoicePaymentGroupViewModel,_super),BankInvoicePaymentGroupViewModel}(vtex.checkout.PaymentGroupViewModel),vtex.checkout.BankInvoicePaymentGroupViewModel=BankInvoicePaymentGroupViewModel}.call(this),function(){var PaymentDataViewModel,debug,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;l>i;i++)if(i in this&&this[i]===item)return i;return-1};debug=vtex.debug("payment"),PaymentDataViewModel=function(){function PaymentDataViewModel(){this.adjustPayments=__bind(this.adjustPayments,this),this.update=__bind(this.update,this),this.updatePaymentGroups=__bind(this.updatePaymentGroups,this),this.updatePaymentSystems=__bind(this.updatePaymentSystems,this),this.getPaymentGroupClass=__bind(this.getPaymentGroupClass,this),this.togglePaymentMethodsVisibility=__bind(this.togglePaymentMethodsVisibility,this),this.submit=__bind(this.submit,this),this.afterRender=__bind(this.afterRender,this),this.isValid=__bind(this.isValid,this),this.validate=__bind(this.validate,this),this.paymentsArrayJSON=__bind(this.paymentsArrayJSON,this),this.updateInterestTotalizer=__bind(this.updateInterestTotalizer,this),this.paymentUpdatedHandler=__bind(this.paymentUpdatedHandler,this),this.sendAttachment=__bind(this.sendAttachment,this),this.submitGiftCard=__bind(this.submitGiftCard,this),this.getAllPaymentsAndGiftsForRnB=__bind(this.getAllPaymentsAndGiftsForRnB,this),this.getAllPayments=__bind(this.getAllPayments,this),this.clearValidationError=__bind(this.clearValidationError,this),this.setPaymentGroup=__bind(this.setPaymentGroup,this),this.selectPaymentGroup=__bind(this.selectPaymentGroup,this),this.enable=__bind(this.enable,this);var _this=this;this.stepId=this.attachmentId="paymentData",_.extend(vtex.checkout.PaymentDataViewModel.prototype,vtex.checkout.ObservableStep(this)),_.extend(vtex.checkout.PaymentDataViewModel.prototype,vtex.checkout.Attachment(this.stepId)),this.validationError=ko.observable(!1),this.showGiftCard=ko.observable(!1),this.selectedPaymentGroupId=ko.observable(),this.giftPaymentsTotal=ko.observable(0),this.paymentSystems=ko.observableArray([]),this.giftCardMessages=ko.observableArray([]),this.isPaymentMethodsVisible=ko.observable(!1),this.isAdjustingPayments=ko.observable(!1),this.gatewayCallbackURL=ko.observable(API._getGatewayCallbackURL()),this.isEditingSensitiveField=ko.computed({read:function(){var _ref;return null!=(_ref=_this.selectedPaymentGroup())&&"function"==typeof _ref.isEditingSensitiveField?_ref.isEditingSensitiveField():void 0},deferEvaluation:!0}),this.paymentGroups={},this.paymentGroupsChanged=ko.observable(),this.paymentGroupArray=ko.computed(function(){return _this.paymentGroupsChanged(),_(_this.paymentGroups).values()}),this.selectedPaymentGroup=ko.computed(function(){var selected,_ref;return selected=null!=(_ref=_this.selectedPaymentGroupId())?_ref.toString():void 0,_.find(_this.paymentGroups,function(pg){return pg.id.toString()===selected})}),this.totalToPay=ko.computed(function(){return window.summary.total()}),this.totalToPayIncludingGifts=ko.computed(function(){return _this.totalToPay()-_this.giftPaymentsTotal()}),this.totalToPayIncludingGiftsLabel=ko.computed(function(){return _.intAsCurrency(_this.totalToPayIncludingGifts())}),this.countryClass=ko.computed(function(){return"payment-country-"+checkout.countryCode()}),this.totalToPayIncludingGifts.subscribe(function(newValue,oldValue){var _ref;if(newValue!==oldValue)return 0===newValue?_this.selectedPaymentGroupId(null):null!=(_ref=_this.selectedPaymentGroup())?_ref.paidValue(newValue):void 0}),this.totalIsFree=ko.computed(function(){return 0===_this.totalToPay()&&window.cart.unavailableItems().length!==window.cart.items().length}),this.totalIsPaidByGiftCards=ko.computed(function(){return _this.totalToPay()>0&&_this.totalToPay()<=_this.giftPaymentsTotal()}),this.showPaymentOptions=ko.computed(function(){return _this.active()&&!_this.totalIsFree()&&!_this.totalIsPaidByGiftCards()}),this.isArgentina=ko.computed(function(){return"ARG"===checkout.countryCode()}),this.ahora12Classes=ko.computed(function(){var date,weekday;return date=new Date,weekday=date.toLocaleDateString("es",{weekday:"long"}),"ahora12 ahora12-"+weekday}),this.isScanningCard=ko.observable(!1),radio("checkout.paymentData.creditCardPaymentGroup.isScanningCard").subscribe(this.isScanningCard),radio("checkout.paymentData.submit.fail").subscribe(function(reason){return _this.loading(!1)}),radio("checkout.paymentData.giftcard.submit").subscribe(this.submitGiftCard),radio("checkout.paymentData.giftPaymentsTotal").subscribe(this.giftPaymentsTotal),$(window).on("orderFormUpdated.vtex",function(e,orderForm){return orderForm.paymentData?(debug("Parsing payment data from event"),_this.update(orderForm)):void 0}),$(window).on("paymentUpdated.vtex",_.debounce(this.paymentUpdatedHandler,100)),this.loading.subscribe(function(value){return radio("checkout.disableInputs").broadcast(value)})}return PaymentDataViewModel.prototype.enable=function(){return this.visited(!0),this.active(!0),this.isValid({giveFocus:!0,showErrorMessage:!1,applyErrorClass:!1}),0===vtexjs.checkout.orderForm.paymentData.payments.length&&this.adjustPayments(vtexjs.checkout.orderForm.paymentData,vtexjs.checkout.orderForm.items),window.Mobile&&Mobile.SwipeCardReaderIsConnected(),radio("checkout.fixCart").broadcast()},PaymentDataViewModel.prototype.selectPaymentGroup=function(paymentGroup){var old;return old=this.selectedPaymentGroupId(),this.setPaymentGroup(paymentGroup,old)&&null!=old?this.sendAttachment():void 0},PaymentDataViewModel.prototype.setPaymentGroup=function(paymentGroup,old){var total;return null==old&&(old=this.selectedPaymentGroupId()),old===paymentGroup.id?!1:(this.selectedPaymentGroupId(paymentGroup.id),total=this.totalToPayIncludingGifts.peek(),paymentGroup.paidValue(total),paymentGroup.afterSelected&&paymentGroup.afterSelected(old===paymentGroup.id),!0)},PaymentDataViewModel.prototype.clearValidationError=function(){return this.validationError(!1)},PaymentDataViewModel.prototype.getAllPayments=function(masked,includeGiftPayment){var giftPayments,payments,pg,pgPayments;return null==includeGiftPayment&&(includeGiftPayment=!0),payments=[],pg=ko.utils.safeUnwrapObservable(this.selectedPaymentGroup),pgPayments=(null!=pg?pg.getPayments(masked):void 0)||[],giftPayments=includeGiftPayment&&this.paymentGroups.giftCardPaymentGroup?this.paymentGroups.giftCardPaymentGroup.getPayments():[],this.totalIsPaidByGiftCards()?payments=giftPayments:(payments=payments.concat(pgPayments?pgPayments:[]),payments=payments.concat(giftPayments?giftPayments:[])),ko.utils.safeUnwrapObservable(this.totalIsFree)?[]:payments},PaymentDataViewModel.prototype.getAllPaymentsAndGiftsForRnB=function(masked,includeGiftPayment){var giftCards,payments,pg,pgPayments;return pg=ko.utils.safeUnwrapObservable(this.selectedPaymentGroup),pgPayments=(null!=pg?pg.getPayments(!0):void 0)||[],payments=ko.utils.safeUnwrapObservable(this.totalIsFree)||ko.utils.safeUnwrapObservable(this.totalIsPaidByGiftCards)?[]:pgPayments,giftCards=includeGiftPayment&&this.paymentGroups.giftCardPaymentGroup?this.paymentGroups.giftCardPaymentGroup.getGiftCardsJSON():[],{payments:payments,giftCards:giftCards}},PaymentDataViewModel.prototype.submitGiftCard=function(giftCardsArray){var attachment,attachmentId;return attachmentId=window.paymentData.attachmentId,attachment=this.getAllPaymentsAndGiftsForRnB(!0,0===giftCardsArray.length?!0:!1),attachment||(attachment={}),attachment.giftCards=_.map(giftCardsArray,function(gc){return gc.toJSON()}),radio("checkout.giftcard.submit").broadcast(attachmentId,attachment)},PaymentDataViewModel.prototype.sendAttachment=function(){var attachment,attachmentId;return attachmentId="paymentData",attachment=this.getAllPaymentsAndGiftsForRnB(!0,!0),API.sendAttachment(attachmentId,attachment)},PaymentDataViewModel.prototype.paymentUpdatedHandler=function(){return this.active()&&!this.isAdjustingPayments()&&0!==window.cart.items.peek().length&&window.cart.unavailableItems.peek().length!==window.cart.items.peek().length?this.sendAttachment():void 0},PaymentDataViewModel.prototype.updateInterestTotalizer=function(){var interest,payment,payments,pg,_i,_len;if(pg=ko.utils.safeUnwrapObservable(this.selectedPaymentGroup),void 0===pg||null===pg)return void 0;for(payments=pg.getPayments(!0),interest=0,_i=0,_len=payments.length;_len>_i;_i++)payment=payments[_i],payment.value&&payment.referenceValue&&(interest+=payment.value-payment.referenceValue);return radio("checkout.totalizers.interest").broadcast(interest)},PaymentDataViewModel.prototype.paymentsArrayJSON=function(){return JSON.stringify(this.getAllPayments())},PaymentDataViewModel.prototype.validate=function(options){return this.selectedPaymentGroup()?this.selectedPaymentGroup().validate(options):[{result:!0}]},PaymentDataViewModel.prototype.isValid=function(options){var validationResults;return validationResults=this.validate(options||{giveFocus:!0}),validationResults.length>0&&_.all(validationResults,function(val){return val.result===!0})},PaymentDataViewModel.prototype.afterRender=function(){return vtex.i18n.translateHtml("#payment-data")},PaymentDataViewModel.prototype.submit=function(){var giftCardIsEnough,payments,referenceValue,value,_ref,_ref1;if(!this.isScanningCard()){if(giftCardIsEnough=!this.totalIsFree()&&this.paymentGroups.giftCardPaymentGroup&&this.totalIsPaidByGiftCards())this.paymentGroups.giftCardPaymentGroup.cleanValidation();else if(!this.totalIsFree()&&!this.isValid())return void this.validationError(!0);if(this.validationError(!1),this.active()){if((null!=(_ref=this.selectedPaymentGroup())&&null!=(_ref1=_ref.paymentSystem())?_ref1.requiresAuthentication():void 0)&&!checkout.loggedIn()&&"callCenterOperator"!==checkout.userType())return vtexid.start({returnUrl:window.location.href,userEmail:window.clientProfileData.email(),locale:checkout.locale(),title:i18n.t("paymentData.requiresAuthentication")}),$(window).one("authenticatedUser.vtexid",function(){var oldEmail,xhr;return oldEmail=window.clientProfileData.email(),checkout.loading(!0),xhr=checkout.update(),xhr.then(function(){return oldEmail===window.clientProfileData.email()?paymentData.submit():void 0}),xhr.always(function(){return checkout.loading(!1)})}),!1;payments=this.getAllPayments(),value=_.reduce(payments,function(memo,p){return memo+p.value},0),referenceValue=this.totalToPay(),this.loading(!0),radio("checkout.paymentData.submit").broadcast(value,referenceValue,payments)}return!1}},PaymentDataViewModel.prototype.togglePaymentMethodsVisibility=function(){return this.isPaymentMethodsVisible(!this.isPaymentMethodsVisible())},PaymentDataViewModel.prototype.getPaymentGroupClass=function(groupName){switch(groupName){case"creditCardPaymentGroup":return vtex.checkout.CreditCardPaymentGroupViewModel;case"debitCardPaymentGroup":return vtex.checkout.CreditCardPaymentGroupViewModel;case"giftCardPaymentGroup":return vtex.checkout.GiftCardPaymentGroupViewModel;case"debitPaymentGroup":return vtex.checkout.DebitPaymentGroupViewModel;case"bankInvoicePaymentGroup":return vtex.checkout.BankInvoicePaymentGroupViewModel;case"PagosWebPaymentGroup":return vtex.checkout.PagosWebPaymentGroupViewModel;default:return-1!==groupName.indexOf("customPrivate")?vtex.checkout.CreditCardCustomPaymentGroupViewModel:vtex.checkout.PaymentGroupViewModel}},PaymentDataViewModel.prototype.updatePaymentSystems=function(paymentData){var i,installmentsOptionsForPaymentSystem,ps,psJson,_i,_len,_ref,_results;for(_ref=paymentData.paymentSystems,_results=[],i=_i=0,_len=_ref.length;_len>_i;i=++_i)psJson=_ref[i],ps=_(this.paymentSystems()).find(function(eps){return eps.id()===parseInt(psJson.id)}),ps?ps.update(psJson):(ps=new vtex.checkout.PaymentSystem(psJson),this.paymentSystems.push(ps)),installmentsOptionsForPaymentSystem=_.filter(paymentData.installmentOptions,function(io){return ps.id()===parseInt(io.paymentSystem)}),_results.push(ps.updateInstallmentsMap(installmentsOptionsForPaymentSystem));return _results},PaymentDataViewModel.prototype.updatePaymentGroups=function(paymentData){var PaymentGroupViewModelName,availableAccountsForPaymentGroup,groupName,i,paymentSystemIdArray,paymentSystemsAvailable,paymentSystemsForGroup,paymentsForPaymentSystems,pg,ps,psJson,selectedPaymentSystem,_base,_i,_len,_ref,_ref1,_ref2,_ref3,_ref4;for(_ref=paymentData.paymentSystems,i=_i=0,_len=_ref.length;_len>_i;i=++_i)psJson=_ref[i],groupName=psJson.groupName,PaymentGroupViewModelName=this.getPaymentGroupClass(groupName),paymentSystemsForGroup=_.filter(this.paymentSystems(),function(ps){return ps.groupName()===groupName}),(_base=this.paymentGroups)[groupName]||(_base[groupName]=new PaymentGroupViewModelName(psJson,paymentSystemsForGroup));this.paymentGroups.giftCardPaymentGroup&&(this.paymentGroups.giftCardPaymentGroup.update(paymentData.giftCards||[]),this.showGiftCard((null!=(_ref1=this.paymentGroups.giftCardPaymentGroup)?_ref1.giftCards().length:void 0)>0)),_ref2=this.paymentGroups;for(groupName in _ref2)pg=_ref2[groupName],paymentSystemIdArray=_.map(pg.paymentSystems(),function(ps){return ps.id()}),availableAccountsForPaymentGroup=_.filter(paymentData.availableAccounts,function(a){var _ref3;return _ref3=parseInt(a.paymentSystem),__indexOf.call(paymentSystemIdArray,_ref3)>=0}),"function"==typeof pg.availableAccounts&&pg.availableAccounts(null!=availableAccountsForPaymentGroup?availableAccountsForPaymentGroup:[]),paymentsForPaymentSystems=_.filter(paymentData.payments,function(p){var _ref3;return _ref3=parseInt(p.paymentSystem),__indexOf.call(paymentSystemIdArray,_ref3)>=0}),pg.updatePayments(paymentsForPaymentSystems);return this.paymentGroupsChanged.notifySubscribers(),paymentSystemsAvailable=paymentData.paymentSystems.length>0,paymentSystemsAvailable&&(selectedPaymentSystem=null!=(_ref3=paymentData.payments)&&null!=(_ref4=_ref3[0])?_ref4.paymentSystem:void 0,null==selectedPaymentSystem&&null==this.selectedPaymentGroupId()&&this.totalToPayIncludingGifts()>0&&(selectedPaymentSystem=paymentData.paymentSystems[0].id),selectedPaymentSystem)?(ps=_.find(this.paymentSystems(),function(p){return p.id()===parseInt(selectedPaymentSystem)}),this.setPaymentGroup(this.paymentGroups[ps.groupName()])):void 0},PaymentDataViewModel.prototype.update=function(orderForm){var paymentData,validationResults,_ref,_ref1,_ref2,_ref3;if(paymentData=null!=(_ref=orderForm.paymentData)?_ref:{},this.selectedAddressId=null!=(_ref1=orderForm.shippingData)&&null!=(_ref2=_ref1.address)?_ref2.addressId:void 0,!paymentData.paymentSystems)throw new Error("JSON enviado para PaymentData no contm paymentSystems");return this.updatePaymentSystems(paymentData),this.adjustPayments(paymentData,orderForm.items)?void 0:(this.updatePaymentGroups(paymentData),(null!=(_ref3=paymentData.payments)?_ref3.length:void 0)>0&&this.updateInterestTotalizer(),null!=paymentData.giftCardMessages&&this.giftCardMessages(paymentData.giftCardMessages),validationResults=this.validate({dontChangeDOM:!0}),$("#payment-data").trigger("componentValidated.vtex",[validationResults]))},PaymentDataViewModel.prototype.adjustPayments=function(paymentData,items){var adjustmentsMade,adjustmentsMadeOnAvailableAccount,firstNonGiftPaymentSystem,groupName,installments,isCard,noItemsAvailable,payment,paymentAttachment,paymentSystem,payments,totalPayedByGifts,totalToPay,_i,_len,_ref,_this=this;if(adjustmentsMade=!1,payments=paymentData.payments,totalToPay=this.totalToPay.peek(),noItemsAvailable=_.all(items,function(item){var _ref;return!("available"===(_ref=item.availability)||null===_ref||void 0===_ref)}))0!==payments.length&&(payments=[],adjustmentsMade=!0);else if(totalPayedByGifts=paymentData.giftCards&&paymentData.giftCards.length>0?_.reduce(paymentData.giftCards,function(total,gc){return gc.inUse?total+gc.value:total},0):0,1===payments.length&&payments[0].referenceValue+totalPayedByGifts!==totalToPay&&(payments[0].referenceValue=totalToPay,adjustmentsMade=!0),this.active()===!0)for(0===payments.length&&totalPayedByGifts!==totalToPay&&(firstNonGiftPaymentSystem=_.find(this.paymentSystems(),function(ps){return"giftCardPaymentGroup"!==ps.groupName()}),payments.push({paymentSystem:parseInt(firstNonGiftPaymentSystem.id()),referenceValue:totalToPay-totalPayedByGifts}),adjustmentsMade=!0),_i=0,_len=payments.length;_len>_i;_i++)if(payment=payments[_i],!payment.installments){if(paymentSystem=_.find(this.paymentSystems(),function(ps){return parseInt(ps.id())===parseInt(payment.paymentSystem)}),groupName=paymentSystem.groupName(),installments=paymentSystem.getInstallmentsForValue(payment.bin,payment.referenceValue),isCard="creditCardPaymentGroup"===groupName||"debitCardPaymentGroup"===groupName||-1!==groupName.indexOf("customPrivate")){if(null==installments)break;if(1!==installments.length)continue;payment.installments=installments[0].number()}else"MercadoPagoPaymentGroup"===groupName?payment.installments=null!=(_ref=_.max(installments,function(i){return i.number()}))?_ref.number():void 0:(null!=installments?installments.length:void 0)>0?payment.installments=installments[0].number():payment.installments=1;adjustmentsMade=!0,payment.accountId&&(adjustmentsMadeOnAvailableAccount=!0)}return adjustmentsMade&&(paymentAttachment={payments:payments,giftCards:paymentData.giftCards},null!=adjustmentsMadeOnAvailableAccount&&this.loading(!0),this.isAdjustingPayments(!0),API.sendAttachment("paymentData",paymentAttachment).always(function(){return _this.isAdjustingPayments(!1),null!=adjustmentsMadeOnAvailableAccount?_this.loading(!1):void 0})),adjustmentsMade},PaymentDataViewModel}(),vtex.checkout.PaymentDataViewModel=PaymentDataViewModel}.call(this),function(){var reportData,_base,_base1;window.vtex||(window.vtex={}),(_base=window.vtex).checkout||(_base.checkout={}),(_base1=window.vtex.checkout).analytics||(_base1.analytics={}),reportData=function(){var orderForm,_ref;return orderForm=null!=(_ref=window.vtexjs.checkout.orderForm)?_ref:{},{salesChannel:function(){return orderForm.salesChannel},campaignName:function(){var _ref1;return null!=(_ref1=orderForm.marketingData)?_ref1.utmCampaign:void 0},campaignSource:function(){var _ref1;return null!=(_ref1=orderForm.marketingData)?_ref1.utmSource:void 0},campaignMedium:function(){var _ref1;return null!=(_ref1=orderForm.marketingData)?_ref1.utmMedium:void 0},internalCampaignName:function(){var _ref1;return null!=(_ref1=orderForm.marketingData)?_ref1.utmiCampaign:void 0},internalCampaignPage:function(){var _ref1;return null!=(_ref1=orderForm.marketingData)?_ref1.utmiPage:void 0},internalCampaignPart:function(){var _ref1;return null!=(_ref1=orderForm.marketingData)?_ref1.utmiPart:void 0},visitorType:function(){return orderForm.loggedIn?"existing customer":orderForm.canEditData&&!orderForm.loggedIn?"new customer":void 0},visitorLoginState:function(){return orderForm.loggedIn?"authenticated customer":orderForm.canEditData||orderForm.loggedIn?void 0:"unauthenticated customer"},visitorContactInfo:function(){var _ref1,_ref2,_ref3;return[null!=(_ref1=orderForm.clientProfileData)?_ref1.email:void 0,null!=(_ref2=orderForm.clientProfileData)?_ref2.firstName:void 0,null!=(_ref3=orderForm.clientProfileData)?_ref3.lastName:void 0]},visitorDemographicInfo:function(){var city,complement,neighborhood,number,postalCode,state,street,_ref1,_ref10,_ref11,_ref12,_ref13,_ref14,_ref2,_ref3,_ref4,_ref5,_ref6,_ref7,_ref8,_ref9;return postalCode=null!=(_ref1=orderForm.shippingData)&&null!=(_ref2=_ref1.address)?_ref2.postalCode:void 0,street=null!=(_ref3=orderForm.shippingData)&&null!=(_ref4=_ref3.address)?_ref4.street:void 0,number=null!=(_ref5=orderForm.shippingData)&&null!=(_ref6=_ref5.address)?_ref6.number:void 0,neighborhood=null!=(_ref7=orderForm.shippingData)&&null!=(_ref8=_ref7.address)?_ref8.neighborhood:void 0,complement=null!=(_ref9=orderForm.shippingData)&&null!=(_ref10=_ref9.address)?_ref10.complement:void 0,city=null!=(_ref11=orderForm.shippingData)&&null!=(_ref12=_ref11.address)?_ref12.city:void 0,state=null!=(_ref13=orderForm.shippingData)&&null!=(_ref14=_ref13.address)?_ref14.state:void 0,[postalCode,street+", "+number+" - "+neighborhood+" - "+complement+" - "+city+" - "+state]},orderFormShipping:function(){var _ref1;return null!=(_ref1=_.find(orderForm.totalizers,function(t){return"Shipping"===t.id}))?_ref1.value:void 0},orderFormShippingMethod:function(){var _ref1;return _.uniq(_.map(null!=(_ref1=orderForm.shippingData)?_ref1.logisticsInfo:void 0,function(li){return li.selectedSla}))},orderFormPromoCode:function(){var _ref1;return null!=(_ref1=orderForm.marketingData)?_ref1.coupon:void 0},orderFormPaymentType:function(){var payment,paymentSystem,_ref1,_ref2;return payment=null!=(_ref1=orderForm.paymentData)?_ref1.payments[0]:void 0,paymentSystem=_.find(null!=(_ref2=orderForm.paymentData)?_ref2.paymentSystems:void 0,function(ps){return ps.id+""===(null!=payment?payment.paymentSystem:void 0)}),null!=paymentSystem?paymentSystem.name:void 0},orderFormTotal:function(){return _.reduce(orderForm.totalizers,function(memo,t){return memo+t.value},0)},orderFormProducts:function(){var c,category,categoryId,categoryIdTree,categoryIds,categoryTree,item,seller,sellerName,_i,_j,_k,_len,_len1,_len2,_ref1,_ref2,_ref3,_ref4,_results;if(!orderForm.items)return[];for(_ref1=orderForm.items,_results=[],_i=0,_len=_ref1.length;_len>_i;_i++){for(item=_ref1[_i],categoryIds=item.productCategoryIds.split("/"),categoryIds=_.reject(categoryIds,function(c){return 0===c.length}),categoryId=categoryIds[categoryIds.length-1],category=item.productCategories[categoryId],categoryTree=[],categoryIdTree=[],_j=0,_len1=categoryIds.length;_len1>_j;_j++)c=categoryIds[_j],categoryIdTree.push(c),categoryTree.push(item.productCategories[c]);for(sellerName="",_ref2=orderForm.sellers,_k=0,_len2=_ref2.length;_len2>_k;_k++)seller=_ref2[_k],item.seller===seller.id&&(sellerName=seller.name);_results.push({id:item.productId,name:item.name,sku:item.id,skuRefId:item.skuRefId,skuName:item.skuName,seller:sellerName,sellerId:item.seller,brand:null!=(_ref3=item.additionalInfo)?_ref3.brandName:void 0,brandId:null!=(_ref4=item.additionalInfo)?_ref4.brandId:void 0,isGift:item.isGift,category:category,categoryId:categoryId,categoryTree:categoryTree,categoryIdTree:categoryIdTree,price:item.price/100,sellingPrice:item.sellingPrice/100,tax:item.tax/100,quantity:item.quantity,components:item.components,measurementUnit:item.measurementUnit,unitMultiplier:item.unitMultiplier})}return _results}}},window.vtex.checkout.analytics.addOrderFormEvents=function(){var _ref,_ref1,_ref2;return null!=(_ref=window.vtex.events)&&_ref.addEvent("cartLoaded","cartLoaded",reportData()),null!=(_ref1=window.vtex.events)&&_ref1.addEvent("finishPayment","submit",reportData()),null!=(_ref2=window.vtex.events)?_ref2.addEvent("sendPayments","submit",reportData()):void 0},window.vtex.checkout.analytics.sendEvent=function(event){var result,sendReport;return result={},sendReport=function(){var _ref;return _.each(reportData(),function(value,key){return result[key]=value()}),null!=(_ref=window.vtex.events)?_ref.sendEvent(event,result):void 0;
},0===window.vtexjs.checkout._pendingRequestCounter?sendReport():$(window).one("orderFormUpdated.vtex",sendReport)}}.call(this),function(){var Config,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};Config=function(){function Config(start){null==start&&(start=!0),this.init=__bind(this.init,this),this.giftCardsProviders=ko.observableArray([{id:"VtexGiftCard",oauth:"vtex",caption:"Default"}]),start&&this.init()}return Config.prototype.init=function(){var _this=this;return $.ajax({url:window.location.origin+"/api/checkout/pub/gift-cards/providers",type:"GET",contentType:"application/json; charset=utf-8",dataType:"json"}).success(function(data){return _this.giftCardsProviders(data)})},Config}(),window.vtex.checkout.Config=Config}.call(this),function(){var clientProfileData,debug,dependencies,e,el,paymentData,shippingData,update,_i,_len,_ref,_ref1,_ref2,_ref3;debug=vtex.debug("main"),window.benchmark("OrderForm main"),window.vtex.ko.validation.options.locale="pt-BR",window.vtex.ko.validation.options.fadeError=!0,window.vtex.i18n.setLocaleCallback("vtex.i18n.update"),window.vtex.i18n.setCountryCodeCallback("vtex.countryCode.update"),window.vtex.i18n.init();try{for(window.checkoutConfig=new vtex.checkout.Config,window.router=new vtex.checkout.Router,window.API=window.vtexjs.checkout,window.checkout=new vtex.checkout.CheckoutModel,window.cart=new vtex.checkout.CartViewModel(window.checkout),window.summary=new vtex.checkout.SummaryViewModel(window.checkout),window.clientProfileData=new vtex.checkout.ClientProfileDataViewModel,window.paymentData=new vtex.checkout.PaymentDataViewModel,window.checkout.loading(!0),ko.applyBindings(window.checkout,$(".pci-alert-topbar")[0]),ko.applyBindings(window.router,$("#orderform-title")[0]),ko.applyBindings(window.router,$("#cart-title")[0]),ko.applyBindings(window.checkout,$(".gift-list-alert.alert")[0]),ko.applyBindings(window.checkout,$(".loading.loading-bg")[0]),ko.applyBindings(window.checkout,$(".link-choose-more-products-wrapper")[0]),ko.applyBindings(window.checkout,$(".link-print-cart-wrapper")[0]),ko.applyBindings(window.checkout,$(".note.summary-note")[0]),ko.applyBindings(window.cart,$(".unavailable-modal")[0]),ko.applyBindings(window.cart,$(".cart-template-holder")[0]),ko.applyBindings(window.cart,$(".summary-cart-template-holder")[0]),ko.applyBindings(window.summary,$(".full-cart .summary-template-holder")[0]),_ref=$(".btn-place-order-wrapper"),_i=0,_len=_ref.length;_len>_i;_i++)el=_ref[_i],ko.applyBindings(window.summary,el);ko.applyBindings(window.summary,$(".mini-cart .summary-template-holder")[0]),ko.applyBindings(window.clientProfileData,$(".client-profile-data")[0]),ko.applyBindings(window.paymentData,$(".payment-submit-wrap")[0]),ko.applyBindings(window.paymentData,$(".payment-data")[0]),window.router.state.subscribe(function(newValue){return"cart"===newValue?($("body").addClass("body-cart").removeClass("body-order-form"),$("div.container.container-main").addClass("container-cart").removeClass("container-order-form"),$("div.checkout-container.row-fluid").addClass("cart-active").removeClass("orderform-active"),$("div.cart-template.full-cart").addClass("active").removeClass("inactive"),$("div.orderform-template").removeClass("active").addClass("inactive")):($("body").removeClass("body-cart").addClass("body-order-form"),$("div.container.container-main").removeClass("container-cart").addClass("container-order-form"),$("div.checkout-container.row-fluid").removeClass("cart-active").addClass("orderform-active"),$("div.cart-template.full-cart").removeClass("active").addClass("inactive"),$("div.orderform-template").addClass("active").removeClass("inactive"))}),window.cart.hasItemsAndIsInCart.subscribe(function(newValue){return newValue?$(".cart-links.cart-links-bottom").show():$(".cart-links.cart-links-bottom").hide()}),window.paymentData.active.subscribe(function(newValue){return newValue?$(".payment-confirmation-wrap").show():$(".payment-confirmation-wrap").hide()})}catch(_error){e=_error,console.error&&console.error("Error initializing checkout:",e,e.stack)}_ref1=[$.Deferred(),$.Deferred(),$.Deferred()],clientProfileData=_ref1[0],shippingData=_ref1[1],paymentData=_ref1[2],$("#client-profile-data").one("componentValidated.vtex",clientProfileData.resolve),$("#shipping-data").one("componentValidated.vtex",shippingData.resolve),$("#payment-data").one("componentValidated.vtex",paymentData.resolve),update=window.checkout.update().done(function(){return window.benchmark("Checkout update finished")}),dependencies=["cart/script/component/SelectGift","shipping/script/ShippingData","link!cart/style/style"],vtex.curl(vtex.curl.configuration,dependencies,function(SelectGift,ShippingData){return update.done(function(){return SelectGift.attachTo(".cart-select-gift-placeholder"),ShippingData.attachTo("#shipping-data",{API:API})})}),update.always(function(){return $(function(){var componentsValidated,componentsValidatedTimeout,componentsValidatedTimeoutHandler,config;return window.vtex.checkout.analytics.sendEvent("cartLoaded"),window.vtex.i18n.translateHtml(),config={app:"checkout-ui",version:vtex.checkout.version,country:vtexjs.checkout.orderForm.storePreferencesData.countryCode},window.vtex.checkout.va=window.vtex.analytics.createContext(config),componentsValidatedTimeoutHandler=function(){return debug("Houve um erro ao validar um dos componentes"),debug(JSON.stringify(window.router.validationResults))},componentsValidatedTimeout=setTimeout(componentsValidatedTimeoutHandler,1e4),componentsValidated=function(){return window.router.initializeRouter(),clearInterval(componentsValidatedTimeout),window.checkout.loading(!1),$("body").removeClass("loading")},$.when(clientProfileData,shippingData,paymentData).then(componentsValidated),setTimeout(function(){return vtex.checkout.cartFixed()},500)})}),$(window).load(function(){return window.benchmark("Window load"),window.vtex.checkout.analytics.addOrderFormEvents()}),$(window).on("authenticatedUser.vtexid",function(){return window.checkout.loading(!0),window.checkout.update().always(function(){return window.checkout.loading(!1)})}),window.benchmark("Main end"),-1!==(null!=(_ref2=window.location)&&null!=(_ref3=_ref2.search)?_ref3.indexOf("development"):void 0)&&($("body").addClass("development"),window.development=!0)}.call(this);



$(function(){
	var bind = function() {
		try {
			var tr = $('.cart-template:not(.mini-cart) tr.Shipping');
			tr.find('td.space , td.monetary').remove();
			tr.find('td.info').attr('colspan',3);
			var o = null;
			for(var i in vtexjs.checkout.orderForm.totalizers) {
			 	o = vtexjs.checkout.orderForm.totalizers[i];
				if(o.id == "Shipping") {
					tr.after('<tr class="qd-shipping-monetary"> <td colspan="3"> '+( (o.value > 0? " R$ " + qd_number_format(o.value / 100, 2, ",", "."): "Grtis") )+' </td> </tr>');
					break;
				}
			}
		}
		catch (e) {(typeof console !== "undefined" && typeof console.error === "function" && console.error("Problemas :( . Detalhes: ", e)); }
	};

	$(window).on("orderFormUpdated.vtex", bind);
	$(bind);
});